
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>DS lore</title>
  <meta name="author" content="nadbor">

  
  <meta name="description" content="I recently bought a deep learning rig to start doing all the cool stuff people do with neural networks these days. First on the list - because it &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://nadbordrozd.github.io/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="DS lore" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-65624880-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">DS lore</a></h1>
  
    <h2>words about stuff</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="nadbordrozd.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/interviews">Interviews</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/09/17/text-generation-with-keras-char-rnns/">Text Generation With Keras char-RNNs</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-09-17T22:17:50+01:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>10:17 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I recently bought a deep learning rig to start doing all the cool stuff people do with neural networks these days. First on the list - because it seemed easiest to implement - text generation with character-based recurrent neural networks.</p>

<p><img src="/images/deep_learning_pc.png" alt="" />
<em>Watercooled 2 x GTX 1080 (on the right)</em></p>

<p>This topic has been widely written about by better people so if you don’t already know about char-RNNs go read them instead. <a href="http://karpathy.github.io/2015/05/21/rnn-effectiveness/">Here</a> is Andrej Karpathy’s blog post that started it all. It has an introduction to RNNs plus some <em>extremely</em> fun examples of texts generated with them. For an in depth explanation of LSTM (the specific type of RNN that everyone uses) I highly recommend <a href="http://r2rt.com/written-memories-understanding-deriving-and-extending-the-lstm.html">this</a>.</p>

<p>I started playing with LSTMs by copying the <a href="https://github.com/fchollet/keras/blob/master/examples/lstm_text_generation.py">example frmo Keras</a>, and then I kept adding to it. First - more layers, then - training with generators instead of batch - to handle datasets that don’t fit in memory. Then a bunch of scripts for getting interesting datasets, then utilities for persisting the models and so on. I ended up with a small set of command line tools for getting the data and running the experiments that I thought may be worth sharing. <a href="https://github.com/nadbordrozd/neural_playground">Here</a> it is.</p>

<h3 id="and-here-are-the-results">And here are the results</h3>
<p>A network with 3 LSTM layers 512 units each + a dense layer trained on the trained for a week on the concatenation of all java files from the <a href="https://github.com/apache/hadoop">hadoop repository</a> produces stuff like <a href="https://github.com/nadbordrozd/neural_playground/blob/master/output/hadoop.java">this</a>:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
<span class="line-number">64</span>
<span class="line-number">65</span>
<span class="line-number">66</span>
<span class="line-number">67</span>
<span class="line-number">68</span>
<span class="line-number">69</span>
<span class="line-number">70</span>
<span class="line-number">71</span>
<span class="line-number">72</span>
<span class="line-number">73</span>
<span class="line-number">74</span>
<span class="line-number">75</span>
<span class="line-number">76</span>
<span class="line-number">77</span>
<span class="line-number">78</span>
<span class="line-number">79</span>
<span class="line-number">80</span>
<span class="line-number">81</span>
<span class="line-number">82</span>
</pre></td><td class="code"><pre><code class="java"><span class="line">  <span class="nd">@Override</span>
</span><span class="line">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setPerDispatcher</span><span class="o">(</span>
</span><span class="line">      <span class="n">MockAM</span> <span class="n">nn1</span><span class="o">,</span> <span class="n">String</span> <span class="n">queue</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class="line">    <span class="n">when</span><span class="o">(</span><span class="n">app1</span><span class="o">.</span><span class="na">getAppAttemptId</span><span class="o">()).</span><span class="na">thenReturn</span><span class="o">(</span><span class="n">defaultSize</span><span class="o">);</span>
</span><span class="line">    <span class="n">menlined</span><span class="o">.</span><span class="na">incr</span><span class="o">();</span>
</span><span class="line">      <span class="n">assertLaunchRMNodes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;AM.2.0 scheduler event&quot;</span><span class="o">);</span>
</span><span class="line">      <span class="n">store</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@Test</span><span class="o">(</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">5000</span><span class="o">)</span>
</span><span class="line">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testAllocateBoths</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class="line">    <span class="n">RMAppAttemptContainer</span> <span class="n">event</span> <span class="o">=</span>
</span><span class="line">        <span class="k">new</span> <span class="nf">RMAppStatusesStatus</span><span class="o">(</span><span class="n">csConf</span><span class="o">);</span>
</span><span class="line">    <span class="kd">final</span> <span class="n">ApplicationAttemptId</span> <span class="n">applicationRetry</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">StatusInfo</span><span class="o">(</span><span class="n">appAttempt</span><span class="o">.</span><span class="na">getAppAttemptId</span><span class="o">(),</span> <span class="kc">null</span><span class="o">,</span>
</span><span class="line">        <span class="n">RMAppEventType</span><span class="o">.</span><span class="na">APP_ENTITY</span><span class="o">,</span>
</span><span class="line">        <span class="n">RMAppEventType</span><span class="o">.</span><span class="na">NODE</span>
</span><span class="line">                  <span class="n">currentFinalBuffer</span><span class="o">);</span>
</span><span class="line">
</span><span class="line">    <span class="n">rm</span><span class="o">.</span><span class="na">handle</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span><span class="line">    <span class="n">assertEquals</span><span class="o">(</span><span class="n">memory</span> <span class="o">&gt;</span> <span class="n">queue</span><span class="o">.</span><span class="na">getAbsolutePreemptionCount</span><span class="o">(),</span> <span class="kc">true</span><span class="o">);</span>
</span><span class="line">
</span><span class="line">    <span class="n">sched</span> <span class="o">=</span> <span class="n">putQueueScheduler</span><span class="o">();</span>
</span><span class="line">    <span class="n">webServiceEvent</span><span class="o">.</span><span class="na">awaitTrackedState</span><span class="o">(</span><span class="k">new</span> <span class="nf">YarnApplicationAttemptEvent</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">      <span class="nd">@Override</span>
</span><span class="line">      <span class="kd">public</span> <span class="n">RMAppEvent</span> <span class="nf">applicationAttemptId</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">        <span class="k">return</span> <span class="o">(</span><span class="n">ApplicationNumMBean</span><span class="o">)</span> <span class="n">response</span><span class="o">.</span><span class="na">getNode</span><span class="o">(</span><span class="n">appAttemptId</span><span class="o">);</span>
</span><span class="line">      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class="line">        <span class="k">return</span> <span class="k">try</span><span class="o">;</span>
</span><span class="line">      <span class="o">}</span>
</span><span class="line">    <span class="o">});</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@Test</span>
</span><span class="line">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testApplicationOverConfigurationHreserved</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class="line">    <span class="k">throw</span> <span class="k">new</span> <span class="nf">StrongResponseException</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@Override</span>
</span><span class="line">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setMediaType</span><span class="o">(</span><span class="n">Angate</span><span class="o">.</span><span class="na">ASQUEUTTED</span><span class="o">,</span> <span class="kt">int</span> <span class="n">cellReplication</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">ApplicationAttemptStatus</span><span class="o">[]</span> <span class="n">url</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">YarnApplicationStatus</span><span class="o">(</span><span class="n">ContainerEventHandler</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class="line">    <span class="n">when</span><span class="o">(</span><span class="n">scheduler</span><span class="o">).</span><span class="na">getFailSet</span><span class="o">(</span><span class="n">nnApplicationRef</span><span class="o">,</span> <span class="mi">1</span><span class="o">)</span>
</span><span class="line">        <span class="o">.</span><span class="na">handle</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
</span><span class="line">    <span class="n">RMAppAttemptAttemptRMState</span> <span class="n">status</span> <span class="o">=</span> <span class="n">spy</span><span class="o">(</span><span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">ApplicationAttemptId</span><span class="o">,</span> <span class="n">RMAppEvent</span><span class="o">&gt;());</span>
</span><span class="line">    <span class="n">testAppManagerManager</span><span class="o">(</span><span class="n">RMAppAttempt</span><span class="o">.</span><span class="na">getApplicationQueueEnabledAndTavanatationFrom</span><span class="o">(),</span> <span class="mi">2</span><span class="o">);</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="cm">/**</span>
</span><span class="line"><span class="cm">   * Whether of spy a stite and heat by Mappings</span>
</span><span class="line"><span class="cm">   */</span>
</span><span class="line">  <span class="nd">@Test</span> <span class="o">(</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">60000</span><span class="o">)</span>
</span><span class="line">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testFences</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class="line">    <span class="n">when</span><span class="o">(</span><span class="n">scheduler</span><span class="o">.</span><span class="na">getRMApp</span><span class="o">(</span>
</span><span class="line">          <span class="kc">false</span><span class="o">)).</span><span class="na">thenReturn</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">.</span><span class="na">getApplicationAttempt</span><span class="o">());</span>
</span><span class="line">    <span class="n">ApplicationAttemptEvent</span> <span class="n">attempt</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">MomaRMApplicationAttemptAttemptEvent</span><span class="o">(</span><span class="n">applicationAttempt</span><span class="o">.</span><span class="na">getApplicationAttemptId</span><span class="o">(),</span> <span class="kc">null</span><span class="o">);</span>
</span><span class="line">
</span><span class="line">    <span class="n">conf</span><span class="o">.</span><span class="na">setBoolean</span><span class="o">(</span><span class="n">rmContainer</span><span class="o">.</span><span class="na">getAttemptState</span><span class="o">());</span>
</span><span class="line">    <span class="n">conf</span><span class="o">.</span><span class="na">setNodeAttemptId</span><span class="o">(</span><span class="n">conf</span><span class="o">);</span>
</span><span class="line">    <span class="n">RMAppStateChange</span> <span class="n">context</span> <span class="o">=</span> <span class="n">application</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span><span class="line">    <span class="n">containersPublishEventPBHandler</span><span class="o">.</span><span class="na">registerNode</span><span class="o">((</span><span class="n">FinalApplicationHistoryArgument</span><span class="o">)</span> <span class="n">relatedVirtualCores</span><span class="o">);</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="kd">static</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">DuvalivedAppResourceUsage</span> <span class="o">{</span>
</span><span class="line">    <span class="c1">// Test</span>
</span><span class="line">    <span class="n">rm1</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nf">UserGroupInformation</span><span class="o">());</span>
</span><span class="line">    <span class="n">vrainedApplicationTokenUrl</span><span class="o">.</span><span class="na">await</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
</span><span class="line">    <span class="n">currentHttpState</span> <span class="o">=</span> <span class="n">container</span><span class="o">.</span><span class="na">getTokenService</span><span class="o">();</span>
</span><span class="line">    <span class="n">nitel</span><span class="o">.</span><span class="na">authentication</span><span class="o">();</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@Override</span>
</span><span class="line">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setEntityForRowEventUudingInVersion</span><span class="o">(</span><span class="kt">int</span> <span class="n">applicationAttemptId</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="k">throw</span> <span class="k">new</span> <span class="nf">UnsupportedOperationException</span><span class="o">(</span><span class="s">&quot;So mock capability&quot;</span><span class="o">,</span> <span class="n">testCaseAccept</span><span class="o">).</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;/list.out&quot;</span><span class="o">;</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setSchedulerAppTestsBufferWithClusterMasterReconfiguration</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">    <span class="c1">// event zips and allocate gremb attempt date this</span>
</span><span class="line">    <span class="n">when</span><span class="o">(</span><span class="n">scheduler</span><span class="o">.</span><span class="na">getFinishTime</span><span class="o">())</span>
</span><span class="line">      <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">getQueue</span><span class="o">(</span><span class="s">&quot;metrics&quot;</span><span class="o">).</span><span class="na">newSchedulingProto</span><span class="o">(</span>
</span><span class="line">        <span class="s">&quot;&lt;x-MASTERATOR new this attempt &quot;</span><span class="o">+</span><span class="s">&quot;ClientToRemovedResourceRasheder&quot;</span><span class="o">,</span> <span class="n">taskDispatcher</span><span class="o">),</span>
</span><span class="line">        <span class="n">server</span><span class="o">.</span><span class="na">getBarerSet</span><span class="o">());</span>
</span><span class="line">  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>That’s pretty believable java if you don’t look to closely! It’s important to remember that this is a character-level model. It doesn’t just assemble previously encountered tokens together in some new order. It hallucinates everything from ground up. For example <code>setSchedulerAppTestsBufferWithClusterMasterReconfiguration()</code> is sadly not a real function in hadoop codebase. Although it very well could be and it wouldn’t stand out among all the other monstrous names like <code>RefreshAuthorazationPolicyProtocolServerSideTranslatorPB</code>. Which was exactly the point of this exercise.</p>

<p>Sometimes the network decides that it’s time for a new file and then it produces the Apache software licence varbatim followed by a million lines of imports</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="cm">/**</span>
</span><span class="line"><span class="cm"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
</span><span class="line"><span class="cm"> * you may not use this file except in compliance with the License.</span>
</span><span class="line"><span class="cm"> * You may obtain a copy of the License at</span>
</span><span class="line"><span class="cm"> *</span>
</span><span class="line"><span class="cm"> *   http://www.apache.org/licenses/LICENSE-2.0</span>
</span><span class="line"><span class="cm"> *</span>
</span><span class="line"><span class="cm"> * Unless required by applicable law or agreed to in writing, software</span>
</span><span class="line"><span class="cm"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
</span><span class="line"><span class="cm"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
</span><span class="line"><span class="cm"> * See the License for the specific language governing permissions and</span>
</span><span class="line"><span class="cm"> * limitations under the License.</span>
</span><span class="line"><span class="cm"> */</span>
</span><span class="line">
</span><span class="line"><span class="kn">package</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">hadoop</span><span class="o">.</span><span class="na">yarn</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">records</span><span class="o">.</span><span class="na">ApplicationResourcementRequest</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">org.apache.hadoop.service.Notify</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">org.apache.hadoop.yarn.api.protocolrecords.AllocationWrapperStatusYarnState</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">org.apache.hadoop.yarn.server.resourcemanager.authentication.RMContainerAttempt</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">org.apache.hadoop.yarn.server.metrics.YarnScheduler</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">org.apache.hadoop.yarn.server.resourcemanager.scheduler.cookie.test.MemoryWUTIMPUndatedMetrics</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">org.apache.hadoop.yarn.server.api.records.Resources</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">org.apache.hadoop.yarn.server.resourcemanager.scheduler.fimat.GetStore</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">org.apache.hadoop.yarn.server.resourcemanager.state.TokenAddrWebKey</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">org.apache.hadoop.yarn.server.resourcemanager.rmapp.attempt.attempt.SchedulerUtils</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">org.apache.hadoop.yarn.server.resourcemanager.scheduler.handle.Operator</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">org.apache.hadoop.yarn.server.resourcemanager.rmapp.RMAppAttemptAppList</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">org.apache.hadoop.yarn.server.resourcemanager.security.AMRequest</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">org.apache.hadoop.yarn.server.metrics.RMApplicationCluster</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">org.apache.hadoop.yarn.server.api.protocolrecords.NMContainerEvent</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">org.apache.hadoop.yarn.server.resourcemanager.nodelabels.RMContainer</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">org.apache.hadoop.yarn.server.resourcemanager.server.security.WebAppEvent</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">org.apache.hadoop.yarn.server.api.records.ContainerException</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">org.apache.hadoop.yarn.server.resourcemanager.scheduler.store.FailAMState</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">org.apache.hadoop.yarn.server.resourcemanager.scheduler.creater.SchedulerEvent</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">org.apache.hadoop.yarn.server.resourcemanager.ndated.common.Priority</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">org.apache.hadoop.yarn.server.api.records.AppAttemptStateUtils</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">org.apache.hadoop.yarn.server.resourcemanager.scheduler.da.RM3</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">org.apache.hadoop.yarn.server.resourcemanager.rmapp.rtbase.ExapplicatesTrackerService</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">org.apache.hadoop.yarn.server.timelineservice.security.Capability</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">org.apache.hadoop.yarn.server.resourcemanager.AM</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">org.apache.hadoop.yarn.server.resourcemanager.scheduler.container.KillLocalData</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">org.apache.hadoop.yarn.server.resourcemanager.state.ContainerHIP</span><span class="o">;</span>
</span><span class="line">
</span><span class="line"><span class="kn">import</span> <span class="nn">javax.xml.am.resource.state.UndecomponentScheduler</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">javax.servlet.NMElement</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">javax.servlet.ArgumentSubmissionContext</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">javax.security.servlet.KILLeaseWriter</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">javax.lang.authenticatenators.DALER</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">java.util.Arrays</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">java.util.concurrent.StringUtils</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">java.util.Iterator</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">java.util.HashSet</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">java.util.Random</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">java.util.concurrent.TimelineInitializer</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">java.util.concurrent.atomic.AtomicLong</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
</span><span class="line">
</span><span class="line"><span class="kn">import</span> <span class="nn">com.google.common.annotations.VisibleUtils</span><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>At first I thought this was a glitch, a result of the network is getting stuck in one state. But then I checked and - no, actually this is exactly what those hadoop .java files look like, 50 lines is a completely unexceptional amount of imports. And again, most of those imports are made up.</p>

<p>And <a href="https://github.com/nadbordrozd/neural_playground/blob/master/output/sklearn.py">here’s</a> a bunch of python code dreamt up by a network trained on scikit-learn <a href="https://github.com/scikit-learn/scikit-learn">repository</a>.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">nose.tools</span> <span class="kn">import</span> <span class="n">assert_almost_equal</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">regularization</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">DataStringIO</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">sklearn.metrics.compatibility</span> <span class="kn">import</span> <span class="n">Parameters</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">sklearn.svm</span> <span class="kn">import</span> <span class="n">test_range</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">sklearn.linear_model.Dictionary</span> <span class="kn">import</span> <span class="n">Dictionary</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">sklearn.distance</span> <span class="kn">import</span> <span class="n">cOST_RORG</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">LabelBineration</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">os</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">TKError</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">datasets</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">GridSearchCV</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">sklearn.externals.six</span> <span class="kn">import</span> <span class="n">LinearSVC</span>
</span><span class="line"><span class="c"># Test the hash to a file was that bug the many number be as constructor.</span>
</span><span class="line"><span class="c"># Make a classification case for set are indicator.</span>
</span><span class="line">
</span><span class="line"><span class="n">Examples</span>
</span><span class="line">    <span class="o">--------</span>
</span><span class="line">
</span><span class="line"><span class="p">(</span>
</span><span class="line">        <span class="n">Parameters</span>
</span><span class="line">        <span class="o">----------</span>
</span><span class="line">        <span class="kn">import</span> <span class="nn">sys</span>
</span><span class="line">        <span class="n">y</span> <span class="o">=</span> <span class="n">filename</span>
</span><span class="line">        <span class="c"># Closed&#39;</span>
</span><span class="line">        <span class="n">total_best</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_proba</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.10</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="s">&#39;all&#39;</span><span class="p">,</span> <span class="n">max_neighbors</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="n">clf</span> <span class="o">=</span> <span class="n">Pickler</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float34</span><span class="p">)</span>
</span><span class="line">    <span class="n">correct_set_using_MACHITER_LIVER_SPY</span> <span class="o">=</span> <span class="n">WORD_INL_OXITIMATION_DER</span>
</span><span class="line">    <span class="k">print</span><span class="p">(</span><span class="s">&quot;Ardument SVD: Pimsha, Moved and More an array&quot;</span><span class="p">)</span>
</span><span class="line">    <span class="n">assert_true</span><span class="p">((</span><span class="s">&#39;g&#39;</span> <span class="o">*</span> <span class="n">GramCAXSORS</span><span class="p">))</span>
</span><span class="line">    <span class="k">print</span><span class="p">(</span><span class="s">&quot;Transformer areair not sparse &quot;</span>
</span><span class="line">                              <span class="s">&quot;memory&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;urllib_split&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
</span><span class="line">                     <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">n_features</span><span class="p">),</span>
</span><span class="line">                                    <span class="k">if</span> <span class="n">that</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">param_range</span><span class="o">=</span><span class="s">&quot;name&quot;</span>
</span><span class="line">
</span><span class="line">                        <span class="n">assert_equal</span><span class="p">(</span><span class="n">decision_function</span><span class="p">,</span> <span class="s">&quot;&#39;)</span>
</span><span class="line">
</span><span class="line">                <span class="k">return</span> <span class="n">BaseCompiler</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">return_path</span><span class="o">=</span><span class="s">&#39;alpha&#39;</span><span class="p">,</span>
</span><span class="line">                                                                                                         <span class="n">sample_weight</span><span class="o">=</span><span class="n">n_nodes</span><span class="p">,</span>
</span><span class="line">                                                                                                                                                     <span class="n">axis</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;arpack&#39;</span><span class="p">,</span>
</span><span class="line">                                                                              <span class="nb">isinstance</span><span class="p">(</span><span class="o">%</span><span class="n">s</span> <span class="n">Early</span> <span class="n">produced</span><span class="o">.</span><span class="s">&quot;)</span>
</span><span class="line">
</span><span class="line">            <span class="n">starts</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">(</span><span class="n">output_method_regression</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;test&#39;</span><span class="p">)</span>
</span><span class="line">            <span class="n">args</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
</span><span class="line">            <span class="n">new_params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">beck</span>
</span><span class="line">            <span class="c"># The implementation of the module distribution cases and classifiers are specified to chenk the file</span>
</span><span class="line">            <span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">embedding</span>
</span><span class="line">            <span class="k">return</span> <span class="n">_argment</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">_item</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">_predict_proba</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
</span><span class="line">        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Calibration in wrapper file may be</span>
</span><span class="line">                                       <span class="s">&#39;grid_search&#39;</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">_build_adjust_size</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">target_conot</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">toem</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
</span><span class="line">        <span class="n">support_</span><span class="o">-</span><span class="n">_given_build_rese_unlib</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>This is much lower quality because the network was smaller and sklearn’s codebase is much smaller than that of hadoop. I’m sure there is a witty comment about the quality of code in those two repositories somewhere in there.</p>

<p>Enough with the github. How about we try some literature? Here’s LSTM-generated Jane Austen:</p>

<blockquote>
  <p>“I wish I had not been satisfied with the other thing.”</p>

  <p>“Do you think you have not the party in the world who has been a great deal of more agreeable young ladies to be got on to Miss Tilney’s happiness to Miss Tilney. They were only to all all the rest of the same day. She was gone away in her
mother’s drive, but she had not passed the rest. They were to be already ready to be a good deal of service the appearance of the house, was discouraged to be a great deal to say, “I do not think I have been able to do them in Bath?”</p>

  <p>“Yes, very often to have a most complaint, and what shall I be to her a great deal of more advantage in the garden, and I am sure you have come at all the proper and the entire of his side for the conversation of Mr. Tilney, and he was satisfied with the door, was sure her situation was soon getting to be a decided partner to her and her father’s circumstances. They were offended to her, and they were all
the expenses of the books, and was now
perfectly much at Louisa the sense of the family of the compliments in the room. The arrival was to be more good.</p>
</blockquote>

<p>That was ok but let’s try something more modern. And what better represents modernity than people believing that the earth is flat. I have scraped all the top level comments from top 500 youtube videos matching the query “flat earth”. <a href="https://github.com/nadbordrozd/neural_playground/blob/master/getting_data/youtube_comments.py">Here</a> is the comments scraper I made for this. And here is the neural network spat out after ingesting 10MB worth of those comments</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="p">[</span><span class="n">James</span> <span class="n">Channel</span><span class="p">]:</span>    <span class="n">I</span> <span class="n">am</span> <span class="n">a</span> <span class="n">fucking</span> <span class="n">Antarctica</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">Bible</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">Bible</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">REAL</span> <span class="n">Angel</span>
</span><span class="line"><span class="n">of</span> <span class="n">God</span><span class="p">,</span> <span class="n">the</span> <span class="n">Fact</span> <span class="n">the</span> <span class="n">Moon</span> <span class="ow">and</span> <span class="n">Sun</span> <span class="ow">is</span> <span class="n">NOT</span> <span class="n">flat</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">moon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">flat</span><span class="o">.</span>
</span><span class="line"><span class="n">The</span> <span class="n">ice</span> <span class="n">wall</span> <span class="n">below</span> <span class="n">the</span> <span class="n">earth</span> <span class="ow">is</span> <span class="n">flat</span> <span class="ow">and</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">the</span> <span class="nb">round</span> <span class="n">earth</span> <span class="ow">is</span> <span class="n">the</span>
</span><span class="line"><span class="n">earth</span> <span class="ow">is</span> <span class="n">flat</span><span class="o">.</span>
</span><span class="line"><span class="p">[</span><span class="n">Mark</span> <span class="n">Filler</span><span class="p">]:</span>    <span class="n">The</span> <span class="n">Earth</span> <span class="ow">is</span> <span class="n">flat</span> <span class="k">with</span> <span class="n">your</span> <span class="n">stupid</span> <span class="n">Qur</span><span class="s">&#39;an and Christ And I can watch the </span>
</span><span class="line"><span class="n">truth</span> <span class="n">of</span> <span class="n">crazy</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">earth</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">curve</span> <span class="n">flat</span> <span class="n">then</span> <span class="n">why</span> <span class="n">do</span> <span class="n">we</span> <span class="n">have</span> <span class="n">to</span>
</span><span class="line"><span class="n">discover</span> <span class="n">the</span> <span class="n">earth</span> <span class="n">flat</span><span class="err">?</span>
</span><span class="line"><span class="p">[</span><span class="n">James</span> <span class="n">Channel</span><span class="p">]:</span>    <span class="n">I</span> <span class="n">don</span><span class="s">&#39;t know what we do not get the communication and the earth and the </span>
</span><span class="line"><span class="n">center</span> <span class="n">of</span> <span class="n">the</span> <span class="n">earth</span> <span class="ow">is</span> <span class="n">just</span> <span class="n">a</span> <span class="n">globe</span> <span class="n">because</span> <span class="n">the</span> <span class="n">earth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">flat</span><span class="o">.</span> <span class="n">The</span>
</span><span class="line"><span class="n">earth</span> <span class="ow">is</span> <span class="nb">round</span> <span class="ow">and</span> <span class="n">why</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">sun</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">sun</span> <span class="n">would</span> <span class="n">be</span> <span class="n">a</span> <span class="n">flat</span> <span class="n">disc</span> <span class="ow">and</span> <span class="n">the</span>
</span><span class="line"><span class="n">earth</span> <span class="ow">is</span> <span class="n">flat</span><span class="err">?</span>
</span><span class="line"><span class="p">[</span><span class="n">Mark</span> <span class="n">Lanz</span><span class="p">]:</span>    <span class="n">I</span> <span class="n">am</span> <span class="n">a</span> <span class="n">Flat</span> <span class="n">Earther</span> <span class="ow">and</span> <span class="n">I</span> <span class="n">can</span> <span class="n">see</span> <span class="n">the</span> <span class="n">truth</span> <span class="n">that</span> <span class="n">was</span> <span class="ow">not</span> <span class="n">the</span> <span class="n">reason</span> <span class="n">the</span>
</span><span class="line"><span class="n">ship</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">sun</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">South</span> <span class="n">Pole</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">last</span> <span class="n">of</span> <span class="n">the</span> <span class="n">world</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">size</span> <span class="n">of</span>
</span><span class="line"><span class="n">the</span> <span class="n">earth</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">moon</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">same</span> <span class="n">formation</span> <span class="n">that</span> <span class="n">we</span> <span class="n">can</span> <span class="n">fly</span> <span class="n">around</span> <span class="n">the</span>
</span><span class="line"><span class="n">earth</span> <span class="ow">and</span> <span class="n">do</span> <span class="n">the</span> <span class="n">moon</span> <span class="n">the</span> <span class="n">earth</span> <span class="ow">is</span> <span class="n">flat</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">disk</span><span class="err">??</span>
</span><span class="line"><span class="p">[</span><span class="n">Bone</span> <span class="n">City</span><span class="p">]:</span>    <span class="n">I</span> <span class="n">can</span> <span class="n">see</span> <span class="n">the</span> <span class="n">sun</span> <span class="n">end</span> <span class="n">of</span> <span class="n">the</span> <span class="n">sun</span> <span class="ow">and</span> <span class="n">sun</span> <span class="k">with</span> <span class="n">the</span> <span class="n">edge</span> <span class="n">of</span> <span class="n">the</span> <span class="n">earth</span><span class="o">.</span>
</span><span class="line"><span class="p">[</span><span class="n">Star</span> <span class="n">Call</span><span class="p">]:</span>    <span class="n">The</span> <span class="n">Earth</span> <span class="ow">is</span> <span class="n">flat</span><span class="p">,</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">flat</span> <span class="n">earth</span> <span class="n">theory</span> <span class="n">that</span> <span class="n">are</span> <span class="n">the</span> <span class="n">problems</span> <span class="n">to</span> <span class="n">go</span>
</span><span class="line"><span class="n">there</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">Earth</span> <span class="ow">is</span> <span class="n">flat</span><span class="o">.</span> <span class="n">So</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">way</span> <span class="n">to</span> <span class="n">the</span> <span class="n">Earth</span> <span class="ow">and</span> <span class="n">the</span>
</span><span class="line"><span class="n">Earth</span><span class="o">.</span> <span class="n">FLAT</span> <span class="n">EARTH</span> <span class="n">IS</span> <span class="n">FLAT</span> <span class="n">THE</span> <span class="n">EARTH</span> <span class="n">IS</span> <span class="n">FLAT</span><span class="o">....</span> <span class="n">I</span> <span class="n">HAVE</span> <span class="n">BECAUSE</span> <span class="n">THE</span> <span class="n">SULLARS</span> <span class="n">WITH</span> <span class="n">A</span> <span class="n">SPACE</span> <span class="n">THE</span> <span class="n">EARTH</span> <span class="n">IS</span> <span class="n">FLAT</span><span class="err">!!!</span>
</span><span class="line"><span class="p">[</span><span class="n">MrJohnny</span><span class="p">]:</span>    <span class="n">I</span> <span class="n">am</span> <span class="n">the</span> <span class="n">truth</span> <span class="n">that</span> <span class="ow">is</span> <span class="n">bullshit</span> <span class="n">lol</span>
</span><span class="line"><span class="p">[</span><span class="n">Jesse</span> <span class="n">Cack</span><span class="p">]:</span>    <span class="n">Great</span> <span class="n">job</span> <span class="n">God</span> <span class="n">bless</span> <span class="n">you</span> <span class="k">for</span> <span class="n">this</span> <span class="n">video</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>That doesn’t make any sense at all. It’s so much like real youtube comments it’s uncanny.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/07/29/datamatching-part-3-match-scoring/">Datamatching Part 3: Match Scoring</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-07-29T20:39:30+01:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>29</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>8:39 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this post I will share some tips on the final aspect of datamatching that was glossed over in parts <a href="http://nadbordrozd.github.io/blog/2016/07/22/datamatching-part-2-spark-pipeline/">1</a> and <a href="http://nadbordrozd.github.io/blog/2016/07/20/datamatching-part-1/">2</a> - scoring matches. This is maybe the hardest part of the process, but it also requires the most domain knowledge so it’s hard to give general advice.</p>

<h3 id="recap">Recap</h3>
<p>In the previous posts we started with two datasets “left” and “right”. Using tokenization and the magic of spark we generated for every left record a small bunch of right records that maybe correspond to it. For example this record:</p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="s">&#39;Id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class="line">    <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;Bruce Wayne&#39;</span><span class="p">,</span>
</span><span class="line">    <span class="s">&#39;address&#39;</span><span class="p">:</span> <span class="s">&#39;1007 Mountain Drive, Gotham&#39;</span><span class="p">,</span>
</span><span class="line">    <span class="s">&#39;phone&#39;</span><span class="p">:</span> <span class="s">&#39;01234567890&#39;</span><span class="p">,</span>
</span><span class="line">    <span class="s">&#39;company&#39;</span><span class="p">:</span> <span class="s">&#39;Wayne Enterprises&#39;</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>got these two as candidate matches:</p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="s">&#39;Id&#39;</span><span class="p">:</span> <span class="s">&#39;a&#39;</span><span class="p">,</span>
</span><span class="line">    <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;Wayne, Burce&#39;</span><span class="p">,</span>
</span><span class="line">    <span class="s">&#39;postcode&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
</span><span class="line">    <span class="s">&#39;personal phone&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
</span><span class="line">    <span class="s">&#39;business phone&#39;</span><span class="p">:</span> <span class="s">&#39;+735-123-456-7890&#39;</span><span class="p">,</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="s">&#39;Id&#39;</span><span class="p">:</span> <span class="s">&#39;c&#39;</span><span class="p">,</span>
</span><span class="line">    <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;Pennyworth, Alfred&#39;</span><span class="p">,</span>
</span><span class="line">    <span class="s">&#39;postcode&#39;</span><span class="p">:</span> <span class="s">&#39;1007&#39;</span><span class="p">,</span>
</span><span class="line">    <span class="s">&#39;personal phone&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
</span><span class="line">    <span class="s">&#39;business phone&#39;</span><span class="p">:</span> <span class="bp">None</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>And now we need to decide which - if any - is(are) the correct one(s). Last time we dodged this problem by using a heuristic “the more keys were matched, the better the candidate”. In this case the record with Id <code>'a'</code> was matched on both name and phone number while <code>'c'</code> was matched on postcode alone, therefore <code>'a'</code> is the better match. It worked in our simple example but in general it’s not very accurate or robust. Let’s try to do better.</p>

<h3 id="similarity-functions">Similarity functions</h3>
<p>The obvious first step is to use some string comparison function to get a continuous measure of similarity for the names rather than the binary match - no match. Levenshtein distance will do, Jaro-Winkler is even better.</p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">jellyfish</span> <span class="kn">import</span> <span class="n">jaro_winkler</span>
</span><span class="line"><span class="k">def</span> <span class="nf">name_similarity</span><span class="p">(</span><span class="n">left_record</span><span class="p">,</span> <span class="n">right_record</span><span class="p">):</span>
</span><span class="line">    <span class="k">return</span> <span class="n">jaro_winkler</span><span class="p">(</span><span class="n">left_record</span><span class="o">.</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">right_record</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>and likewise for the phone numbers, a sensible measure of similarity would be the length of the longest common substring:</p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">py_common_subseq</span> <span class="kn">import</span> <span class="n">find_common_subsequences</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">sanitize_phone</span><span class="p">(</span><span class="n">phone</span><span class="p">):</span>
</span><span class="line">    <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">(</span><span class="n">phone</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="s">&#39;1234567890&#39;</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">phone_sim</span><span class="p">(</span><span class="n">phone_a</span><span class="p">,</span> <span class="n">phone_b</span><span class="p">):</span>
</span><span class="line">    <span class="n">phone_a</span> <span class="o">=</span> <span class="n">sanitize_phone</span><span class="p">(</span><span class="n">phone_a</span><span class="p">)</span>
</span><span class="line">    <span class="n">phone_b</span> <span class="o">=</span> <span class="n">sanitize_phone</span><span class="p">(</span><span class="n">phone_b</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="c"># if the number is too short, means it&#39;s fubar</span>
</span><span class="line">    <span class="k">if</span> <span class="n">phone_a</span> <span class="o">&lt;</span> <span class="mi">7</span> <span class="ow">or</span> <span class="n">phone_b</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">:</span>
</span><span class="line">        <span class="k">return</span> <span class="mi">0</span>
</span><span class="line">    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span> <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">find_common_subsequences</span><span class="p">(</span><span class="n">phone_a</span><span class="p">,</span> <span class="n">phone_b</span><span class="p">))</span> \
</span><span class="line">        <span class="o">/</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">phone_a</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">phone_b</span><span class="p">)))</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>This makes sense at least if the likely source of phone number discrepancies is area codes or extensions. If we’re more worried about typos than different prefixes/suffixes then Levenshtein would be the way to go.</p>

<p>Next we need to come up with some measure of postcode similarity. E.g. full match = 1, partial match = 0.5 - for UK postcodes. And again the same for any characteristic that can be extracted from the records in both datasets.</p>

<p>With all those comparison functions in place, we can create a better scorer:</p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">def</span> <span class="nf">score_match</span><span class="p">(</span><span class="n">left_record</span><span class="p">,</span> <span class="n">right_record</span><span class="p">):</span>
</span><span class="line">    <span class="n">name_weight</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class="line">    <span class="c"># phone numbers are pretty unique, give them more weight</span>
</span><span class="line">    <span class="n">phone_weight</span> <span class="o">=</span> <span class="mi">2</span>
</span><span class="line">    <span class="c"># postcodes are not very unique, less weight</span>
</span><span class="line">    <span class="n">postcode_weight</span> <span class="o">=</span> <span class="mf">0.5</span>
</span><span class="line">
</span><span class="line">    <span class="k">return</span> <span class="n">name_weight</span> <span class="o">*</span> <span class="n">name_similarity</span><span class="p">(</span><span class="n">left_record</span><span class="p">,</span> <span class="n">right_record</span><span class="p">)</span> \
</span><span class="line">        <span class="o">+</span> <span class="n">phone_weight</span> <span class="o">*</span> <span class="n">phone_similarity</span><span class="p">(</span><span class="n">left_record</span><span class="p">,</span> <span class="n">right_record</span><span class="p">)</span> \
</span><span class="line">        <span class="o">+</span> <span class="n">address_weight</span> <span class="o">*</span> <span class="n">adress_similarity</span><span class="p">(</span><span class="n">left_record</span><span class="p">,</span> <span class="n">right_record</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>This should already work significantly better than our previous approach but it’s still an arbitrary heuristic. Let’s see if we can do better still.</p>

<h3 id="scoring-as-classification">Scoring as classification</h3>
<p>Evaluation of matches is a type of classification. Every candidate match is either true or spurious and we use similarity scores to decide which is the case. This dictates a simple approach:</p>

<ol>
  <li>Take a hundred or two of records from the left dataset together with corresponding candidates from the right dataset.</li>
  <li>Hand label every record-candidate pair as true of false.</li>
  <li>Calculate similarity scores for every pair.</li>
  <li>Train a classifier model on the labeled examples.</li>
  <li>Apply the model to the rest of the left-right candidate pairs. Use probabilistic output from the classifier to get a continuous score that can be compared among candidates.</li>
</ol>

<p>It shouldn’t have been a surprise to me but it was when I discovered that this actually works and makes a big difference. Even with just 4 features matching accuracy went up from 80% to over 90% on a benchmark dataset just from switching from handpicked weights to weights fitted with logistic regression. Random forest did even better.</p>

<p>One more improvement that can take accuracy to the next level is iterative learning. You train your model, apply it and see in what situations is the classifier least confident (probability ~50%). Then you pick some of those ambiguous examples, hand-label them and add to the training set, rinse and repeat. If everything goes right, now the classifier has learned to crack previously uncrackable cases.</p>

<p>This concludes my tutorial on datamatching but there is one more tip that I want to share.</p>

<h3 id="name-similarity-trick">Name similarity trick</h3>
<p>Levenshtein distance, Yaro-Winkler distnce etc. are great measures of edit distance but not much else. If the variation in the string you’re comparing is due to typos (<code>"Bruce Wayne"</code> -&gt; <code>"Burce Wanye"</code>) then Levenshtein is the way to go. Frequently though the variation in names has nothing to do with typos at all, there are just multiple ways people refer to the same entity. If we’re talking about companies <code>"Tesco"</code> is clearly <code>"Tesco PLC"</code> and <code>"Manchester United F.C."</code> is the same as <code>"Manchester United"</code>. Even <code>"Nadbor Consulting Company"</code> is very likely at least related to <code>"Nadbor Limited"</code> given how unique the word <code>"Nadbor"</code> is and how <code>"Limited"</code>, <code>"Company"</code> and <code>"Consulting"</code> are super common to the point of meaninglessness. No edit distance would ever figure that out because it doesn’t know anything about the nature of the strings it receives or about their frequency in the dataset.</p>

<p>A much better distance measure in the case of company names should look at the words the two names have in common, rather than the characters. It should also discount the words according to their uniqueness. The word <code>"Limited"</code> occurs in a majority of company names so it’s pretty much useless, <code>"Consulting"</code> is more important but still very common and <code>"Nadbor"</code> is completely unique. Let the code speak for itself:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="c"># token2frequency is just a word counter of all words in all names</span>
</span><span class="line"><span class="c"># in the dataset</span>
</span><span class="line"><span class="k">def</span> <span class="nf">sequence_uniqueness</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">token2frequency</span><span class="p">):</span>
</span><span class="line">    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">token2frequency</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">seq</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">name_similarity</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">token2frequency</span><span class="p">):</span>
</span><span class="line">    <span class="n">a_tokens</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
</span><span class="line">    <span class="n">b_tokens</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
</span><span class="line">    <span class="n">a_uniq</span> <span class="o">=</span> <span class="n">sequence_uniqueness</span><span class="p">(</span><span class="n">a_tokens</span><span class="p">)</span>
</span><span class="line">    <span class="n">b_uniq</span> <span class="o">=</span> <span class="n">sequence_uniqueness</span><span class="p">(</span><span class="n">b_tokens</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">return</span> <span class="n">sequence_uniqueness</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">b</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">a_uniq</span> <span class="o">*</span> <span class="n">b_uniq</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The above can be interpreted as the scalar product of the names in the Bag of Word representation in the idf space except instead of the logarithm usually used in idf I used a square root because it gives more intuitively appealing scores. I have tested this and it works great on UK company names but I suspect it will do a good job at comparing many other types of sequences of tokens (not necessarily words).</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/07/22/datamatching-part-2-spark-pipeline/">Datamatching Part 2: Spark Pipeline</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-07-22T22:57:45+01:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>22</span><span class='date-suffix'>nd</span>, <span class='date-year'>2016</span></span> <span class='time'>10:57 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In the <a href="http://nadbordrozd.github.io/blog/2016/07/12/datamatching-part-1/">last post</a> I talked about the principles of datamatching, now it’s time to put them into practice. I will present a generic, customisable Spark pipeline for datamatching as well as a specific instance of it that for matching the toy datasets from the last post. TL;DR of the last post:</p>

<p>To match two datasets:</p>

<ol>
  <li>Tokenize corresponding fields in both datasets</li>
  <li>Group records having a token in common (think SQL join)</li>
  <li>Compare records withing a group and choose the closest match</li>
</ol>

<h3 id="why-spark">Why spark</h3>
<p>This datamatching algorithm could easily be implemented in the traditional single-machine, single-threaded way using a collection of hashmaps. In fact this is what I have done on more than one occasion and it worked. The advantage of spark here is built-in scalability. If your datasets get ten times bigger, just invoke spark requesting ten times as many cores. If matching is taking too long - throw some more resources at it again. In the single-threaded model all you can do is up the RAM as your data grows but the computation is taking longer and longer and there is nothing you can do about it.</p>

<p>As an added bonus, I discovered that the abstractions Spark forces on you - maps, joins, reduces - are actually appropriate for this problem and encourage a better design than the naive implementation.</p>

<h3 id="example-data">Example data</h3>
<p>In the spirit of TDD, let’s start by creating a test case. It will consist of two RDDs that we are going to match. Spark’s dataframes would be even more natural choice if not for the fact that they are completely fucked up.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="c"># the first dataset from now on refered to as &quot;left&quot;</span>
</span><span class="line"><span class="n">left</span> <span class="o">=</span> <span class="p">[</span>
</span><span class="line">    <span class="p">{</span>
</span><span class="line">        <span class="s">&#39;Id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;Bruce Wayne&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;address&#39;</span><span class="p">:</span> <span class="s">&#39;1007 Mountain Drive, Gotham&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;phone&#39;</span><span class="p">:</span> <span class="s">&#39;01234567890&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;company&#39;</span><span class="p">:</span> <span class="s">&#39;Wayne Enterprises&#39;</span>
</span><span class="line">    <span class="p">},</span>
</span><span class="line">    <span class="p">{</span>
</span><span class="line">        <span class="s">&#39;Id&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;Thomas Wayne&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;address&#39;</span><span class="p">:</span> <span class="s">&#39;Gotham Cemetery&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;phone&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;company&#39;</span><span class="p">:</span> <span class="s">&#39;Wayne Enterprises&#39;</span>
</span><span class="line">    <span class="p">},</span>
</span><span class="line">    <span class="p">{</span>
</span><span class="line">        <span class="s">&#39;Id&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;Bruce Banner&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;address&#39;</span><span class="p">:</span> <span class="s">&#39;56431 Some Place, New Mexico&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;phone&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;company&#39;</span><span class="p">:</span> <span class="s">&#39;U.S. Department of Defense&#39;</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line"><span class="p">]</span>
</span><span class="line">
</span><span class="line"><span class="c"># and the second &quot;right&quot;</span>
</span><span class="line"><span class="n">right</span> <span class="o">=</span> <span class="p">[</span>
</span><span class="line">    <span class="p">{</span>
</span><span class="line">        <span class="s">&#39;Id&#39;</span><span class="p">:</span> <span class="s">&#39;a&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;Wayne, Burce&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;postcode&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;personal phone&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;business phone&#39;</span><span class="p">:</span> <span class="s">&#39;+735-123-456-7890&#39;</span><span class="p">,</span>
</span><span class="line">    <span class="p">},</span>
</span><span class="line">    <span class="p">{</span>
</span><span class="line">        <span class="s">&#39;Id&#39;</span><span class="p">:</span> <span class="s">&#39;b&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;B. Banner&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;postcode&#39;</span><span class="p">:</span> <span class="s">&#39;56431&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;personal phone&#39;</span><span class="p">:</span> <span class="s">&#39;897654322&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;business phone&#39;</span><span class="p">:</span> <span class="bp">None</span>
</span><span class="line">
</span><span class="line">    <span class="p">},</span>
</span><span class="line">    <span class="p">{</span>
</span><span class="line">        <span class="s">&#39;Id&#39;</span><span class="p">:</span> <span class="s">&#39;c&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;Pennyworth, Alfred&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;postcode&#39;</span><span class="p">:</span> <span class="s">&#39;1007&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;personal phone&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;business phone&#39;</span><span class="p">:</span> <span class="bp">None</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line"><span class="p">]</span>
</span><span class="line">
</span><span class="line"><span class="c"># sc is an instance of pyspark.SparkContext</span>
</span><span class="line"><span class="n">left_rdd</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">parallelize</span><span class="p">(</span><span class="n">left</span><span class="p">)</span>
</span><span class="line"><span class="n">right_rdd</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">parallelize</span><span class="p">(</span><span class="n">right</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="tokenizers">Tokenizers</h3>
<p>First step in the algorithm - tokenize the fields. After all this talk in the last post about fancy tokenizers, for our particular toy datasets we will use extremely simplistic ones:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="c"># lowercase the name and split on spaces, remove non-alphanumeric chars</span>
</span><span class="line"><span class="k">def</span> <span class="nf">tokenize_name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
</span><span class="line">    <span class="n">clean_name</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">c</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">isalnum</span><span class="p">()</span> <span class="k">else</span> <span class="s">&#39; &#39;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">name</span><span class="p">)</span>
</span><span class="line">    <span class="k">return</span> <span class="n">clean_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
</span><span class="line">
</span><span class="line"><span class="c"># same tokenizers as for names, meh, good enough</span>
</span><span class="line"><span class="k">def</span> <span class="nf">tokenize_address</span><span class="p">(</span><span class="n">address</span><span class="p">):</span>
</span><span class="line">    <span class="k">return</span> <span class="n">tokenize_name</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="c"># last 10 digits of phone number</span>
</span><span class="line"><span class="k">def</span> <span class="nf">tokenize_phone</span><span class="p">(</span><span class="n">phone</span><span class="p">):</span>
</span><span class="line">    <span class="k">return</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">phone</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="s">&#39;1234567890&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">10</span><span class="p">:]]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Now we have to specify which tokenizer should be applied to which field. You don’t want to use the phone tokenizer on a person’s name or vice versa. Also, tokens extracted from name shouldn’t mix with tokens from address or phone number. On the other hand, there may be multiple fields that you want to extract e.g. phone numbers from - and these tokens <em>should</em> mix. Here’s minimalistic syntax for specifying these things:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="c"># original column name goes first, then token type, then tokenizer function</span>
</span><span class="line"><span class="c"># for the left dataset</span>
</span><span class="line"><span class="n">left_tokenizers</span> <span class="o">=</span> <span class="p">[</span>
</span><span class="line">    <span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="s">&#39;name_tokens&#39;</span><span class="p">,</span> <span class="n">tokenize_name</span><span class="p">),</span>
</span><span class="line">    <span class="p">(</span><span class="s">&#39;address&#39;</span><span class="p">,</span> <span class="s">&#39;address_tokens&#39;</span><span class="p">,</span> <span class="n">tokenize_address</span><span class="p">),</span>
</span><span class="line">    <span class="p">(</span><span class="s">&#39;phone&#39;</span><span class="p">,</span> <span class="s">&#39;phone_tokens&#39;</span><span class="p">,</span> <span class="n">tokenize_phone</span><span class="p">)</span>
</span><span class="line"><span class="p">]</span>
</span><span class="line">
</span><span class="line"><span class="c"># and right</span>
</span><span class="line"><span class="n">right_tokenizers</span> <span class="o">=</span> <span class="p">[</span>
</span><span class="line">    <span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="s">&#39;name_tokens&#39;</span><span class="p">,</span> <span class="n">tokenize_name</span><span class="p">),</span>
</span><span class="line">    <span class="p">(</span><span class="s">&#39;postcode&#39;</span><span class="p">,</span> <span class="s">&#39;address_tokens&#39;</span><span class="p">,</span> <span class="n">tokenize_address</span><span class="p">),</span>
</span><span class="line">    <span class="p">(</span><span class="s">&#39;personal phone&#39;</span><span class="p">,</span> <span class="s">&#39;phone_tokens&#39;</span><span class="p">,</span> <span class="n">tokenize_phone</span><span class="p">),</span>
</span><span class="line">    <span class="p">(</span><span class="s">&#39;business phone&#39;</span><span class="p">,</span> <span class="s">&#39;phone_tokens&#39;</span><span class="p">,</span> <span class="n">tokenize_phone</span><span class="p">)</span>
</span><span class="line"><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>And here’s how they are applied:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">id_key</span> <span class="o">=</span> <span class="s">&#39;Id&#39;</span>
</span><span class="line"><span class="k">def</span> <span class="nf">prepare_join_keys</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">tokenizers</span><span class="p">):</span>
</span><span class="line">    <span class="k">for</span> <span class="n">source_column</span><span class="p">,</span> <span class="n">key_name</span><span class="p">,</span> <span class="n">tokenizer</span> <span class="ow">in</span> <span class="n">tokenizers</span><span class="p">:</span>
</span><span class="line">        <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">source_column</span><span class="p">):</span>
</span><span class="line">            <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">source_column</span><span class="p">))):</span>
</span><span class="line">                <span class="k">yield</span> <span class="p">((</span><span class="n">token</span><span class="p">,</span> <span class="n">key_name</span><span class="p">),</span> <span class="n">record</span><span class="p">[</span><span class="n">id_key</span><span class="p">])</span>
</span><span class="line">
</span><span class="line"><span class="c"># Ids of records in the left dataset keyed by tokens extracted from the record</span>
</span><span class="line"><span class="n">left_keyed</span> <span class="o">=</span> <span class="n">left_rdd</span><span class="o">.</span><span class="n">flatMap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">prepare_join_keys</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">left_tokenizers</span><span class="p">))</span>
</span><span class="line"><span class="c"># and same for the right dataset</span>
</span><span class="line"><span class="n">right_keyed</span> <span class="o">=</span> <span class="n">right_rdd</span><span class="o">.</span><span class="n">flatMap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">prepare_join_keys</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">right_tokenizers</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The result is a mapping of token -&gt; Id in the form of an RDD. One for each dataset:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">&gt;&gt;&gt; left_keyed.collect()
</span><span class="line">[((&#39;bruce&#39;, &#39;name_tokens&#39;), 1),
</span><span class="line"> ((&#39;wayne&#39;, &#39;name_tokens&#39;), 1),
</span><span class="line"> ((&#39;1007&#39;, &#39;address_tokens&#39;), 1),
</span><span class="line"> ((&#39;mountain&#39;, &#39;address_tokens&#39;), 1),
</span><span class="line"> ((&#39;gotham&#39;, &#39;address_tokens&#39;), 1),
</span><span class="line"> ((&#39;drive&#39;, &#39;address_tokens&#39;), 1),
</span><span class="line"> ((&#39;1234567890&#39;, &#39;phone_tokens&#39;), 1),
</span><span class="line"> ((&#39;thomas&#39;, &#39;name_tokens&#39;), 2),
</span><span class="line"> ((&#39;wayne&#39;, &#39;name_tokens&#39;), 2),
</span><span class="line"> ((&#39;gotham&#39;, &#39;address_tokens&#39;), 2),
</span><span class="line"> ((&#39;cemetery&#39;, &#39;address_tokens&#39;), 2),
</span><span class="line"> ((&#39;bruce&#39;, &#39;name_tokens&#39;), 3),
</span><span class="line"> ((&#39;banner&#39;, &#39;name_tokens&#39;), 3),
</span><span class="line"> ((&#39;place&#39;, &#39;address_tokens&#39;), 3),
</span><span class="line"> ((&#39;mexico&#39;, &#39;address_tokens&#39;), 3),
</span><span class="line"> ((&#39;some&#39;, &#39;address_tokens&#39;), 3),
</span><span class="line"> ((&#39;56431&#39;, &#39;address_tokens&#39;), 3),
</span><span class="line"> ((&#39;new&#39;, &#39;address_tokens&#39;), 3)]
</span><span class="line">&gt;&gt;&gt; right_keyed.collect()
</span><span class="line">[((&#39;wayne&#39;, &#39;name_tokens&#39;), &#39;a&#39;),
</span><span class="line"> ((&#39;burce&#39;, &#39;name_tokens&#39;), &#39;a&#39;),
</span><span class="line"> ((&#39;1234567890&#39;, &#39;phone_tokens&#39;), &#39;a&#39;),
</span><span class="line"> ((&#39;b&#39;, &#39;name_tokens&#39;), &#39;b&#39;),
</span><span class="line"> ((&#39;banner&#39;, &#39;name_tokens&#39;), &#39;b&#39;),
</span><span class="line"> ((&#39;56431&#39;, &#39;address_tokens&#39;), &#39;b&#39;),
</span><span class="line"> ((&#39;897654322&#39;, &#39;phone_tokens&#39;), &#39;b&#39;),
</span><span class="line"> ((&#39;pennyworth&#39;, &#39;name_tokens&#39;), &#39;c&#39;),
</span><span class="line"> ((&#39;alfred&#39;, &#39;name_tokens&#39;), &#39;c&#39;),
</span><span class="line"> ((&#39;1007&#39;, &#39;address_tokens&#39;), &#39;c&#39;)]
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="generating-candidate-matches">Generating candidate matches</h3>
<p>Now comes the time to generate candidate matches. We do that by joining records that have a token in common:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">candidates</span> <span class="o">=</span> <span class="p">(</span>
</span><span class="line">    <span class="n">left_keyed</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">right_keyed</span><span class="p">)</span>
</span><span class="line">    <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="p">((</span><span class="n">token</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span> <span class="p">(</span><span class="n">l_id</span><span class="p">,</span> <span class="n">r_id</span><span class="p">)):</span> <span class="p">((</span><span class="n">l_id</span><span class="p">,</span> <span class="n">r_id</span><span class="p">),</span> <span class="p">{</span><span class="n">key</span><span class="p">}))</span>
</span><span class="line">    <span class="o">.</span><span class="n">reduceByKey</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
</span><span class="line"><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Result:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">&gt;&gt;&gt; candidates.collect()
</span><span class="line">[((2, &#39;a&#39;), {&#39;name_tokens&#39;}),
</span><span class="line"> ((1, &#39;c&#39;), {&#39;address_tokens&#39;}),
</span><span class="line"> ((1, &#39;a&#39;), {&#39;name_tokens&#39;, &#39;phone_tokens&#39;}),
</span><span class="line"> ((3, &#39;b&#39;), {&#39;address_tokens&#39;, &#39;name_tokens&#39;})]
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>With every match we have retained the information about what it was joined on for later use. We have 4 candidate matches here - 2 correct and 2 wrong ones. The spurious matches are <code>(1, 'c')</code> - Bruce Wayne and Alfred Pennyworth matched due to shared address; <code>(2, 'a')</code> - Bruce Wayne and Thomas Wayne matched because of the shared last name.</p>

<p>Joining the original records back to the matches, so they can be compared:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="c"># let&#39;s join back </span>
</span><span class="line"><span class="n">cand_matches</span> <span class="o">=</span> <span class="p">(</span>
</span><span class="line">    <span class="n">candidates</span>
</span><span class="line">    <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="p">((</span><span class="n">l_id</span><span class="p">,</span> <span class="n">r_id</span><span class="p">),</span> <span class="n">keys</span><span class="p">):</span> <span class="p">(</span><span class="n">l_id</span><span class="p">,</span> <span class="p">(</span><span class="n">r_id</span><span class="p">,</span> <span class="n">keys</span><span class="p">)))</span>
</span><span class="line">    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">left_rdd</span><span class="o">.</span><span class="n">keyBy</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">id_key</span><span class="p">]))</span>
</span><span class="line">    <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="n">l_id</span><span class="p">,</span> <span class="p">((</span><span class="n">r_id</span><span class="p">,</span> <span class="n">keys</span><span class="p">),</span> <span class="n">l_rec</span><span class="p">)):</span> <span class="p">(</span><span class="n">r_id</span><span class="p">,</span> <span class="p">(</span><span class="n">l_rec</span><span class="p">,</span> <span class="n">keys</span><span class="p">)))</span>
</span><span class="line">    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">right_rdd</span><span class="o">.</span><span class="n">keyBy</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">id_key</span><span class="p">]))</span>
</span><span class="line">    <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="n">r_id</span><span class="p">,</span> <span class="p">((</span><span class="n">l_rec</span><span class="p">,</span> <span class="n">keys</span><span class="p">),</span> <span class="n">r_rec</span><span class="p">)):</span> <span class="p">(</span><span class="n">l_rec</span><span class="p">,</span> <span class="n">r_rec</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">keys</span><span class="p">)))</span>
</span><span class="line"><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="finding-the-best-match">Finding the best match</h3>
<p>We’re almost there. Now we need to define a function to evaluate goodness of a match. Take a pair of records and say how similar they are. We will cop out of this by just using the join keys that were retained with every match. The more different types of tokens were matched, the better:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">def</span> <span class="nf">score_match</span><span class="p">(</span><span class="n">left_rec</span><span class="p">,</span> <span class="n">right_rec</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
</span><span class="line">    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>We also need a function that will say: a match must be scored at least this high to qualify.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">def</span> <span class="nf">is_good_enough_match</span><span class="p">(</span><span class="n">match_score</span><span class="p">):</span>
</span><span class="line">    <span class="k">return</span> <span class="n">match_score</span> <span class="o">&gt;=</span> <span class="mi">2</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>And now, finally we use those functions to evaluate and filter candidate matches and return the matched dataset:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">final_matches</span> <span class="o">=</span> <span class="p">(</span>
</span><span class="line">    <span class="n">cand_matches</span>
</span><span class="line">    <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="n">l_rec</span><span class="p">,</span> <span class="n">r_rec</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
</span><span class="line">         <span class="p">(</span><span class="n">l_rec</span><span class="p">,</span> <span class="n">r_rec</span><span class="p">,</span> <span class="n">score_match</span><span class="p">(</span><span class="n">l_rec</span><span class="p">,</span> <span class="n">r_rec</span><span class="p">,</span> <span class="n">keys</span><span class="p">)))</span>
</span><span class="line">    <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="n">l_rec</span><span class="p">,</span> <span class="n">r_rec</span><span class="p">,</span> <span class="n">score</span><span class="p">):</span> <span class="n">is_good_enough_match</span><span class="p">(</span><span class="n">score</span><span class="p">))</span>
</span><span class="line"><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The result:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">&gt;&gt;&gt; final_matches.collect()
</span><span class="line">[({&#39;Id&#39;: 1,
</span><span class="line">   &#39;address&#39;: &#39;1007 Mountain Drive, Gotham&#39;,
</span><span class="line">   &#39;company&#39;: &#39;Wayne Enterprises&#39;,
</span><span class="line">   &#39;name&#39;: &#39;Bruce Wayne&#39;,
</span><span class="line">   &#39;phone&#39;: &#39;01234567890&#39;},
</span><span class="line">  {&#39;Id&#39;: &#39;a&#39;,
</span><span class="line">   &#39;business phone&#39;: &#39;+735-123-456-7890&#39;,
</span><span class="line">   &#39;name&#39;: &#39;Wayne, Burce&#39;,
</span><span class="line">   &#39;personal phone&#39;: None,
</span><span class="line">   &#39;postcode&#39;: None},
</span><span class="line">  2),
</span><span class="line"> ({&#39;Id&#39;: 3,
</span><span class="line">   &#39;address&#39;: &#39;56431 Some Place, New Mexico&#39;,
</span><span class="line">   &#39;company&#39;: &#39;U.S. Department of Defense&#39;,
</span><span class="line">   &#39;name&#39;: &#39;Bruce Banner&#39;,
</span><span class="line">   &#39;phone&#39;: None},
</span><span class="line">  {&#39;Id&#39;: &#39;b&#39;,
</span><span class="line">   &#39;business phone&#39;: None,
</span><span class="line">   &#39;name&#39;: &#39;B. Banner&#39;,
</span><span class="line">   &#39;personal phone&#39;: &#39;897654322&#39;,
</span><span class="line">   &#39;postcode&#39;: &#39;56431&#39;},
</span><span class="line">  2)]
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Glorious.</p>

<h3 id="putting-it-all-together">Putting it all together</h3>
<p>Now is the time to put “generic” back in the “generic datamatching pipeline in spark”.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">class</span> <span class="nc">DataMatcher</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">score_match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">left_rec</span><span class="p">,</span> <span class="n">right_rec</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
</span><span class="line">        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">is_good_enough_match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">match_score</span><span class="p">):</span>
</span><span class="line">        <span class="k">return</span> <span class="n">match_score</span> <span class="o">&gt;=</span> <span class="mi">2</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">get_left_tokenizers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">get_right_tokenizers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">match_rdds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">left_rdd</span><span class="p">,</span> <span class="n">right_rdd</span><span class="p">):</span>
</span><span class="line">        <span class="n">left_tokenizers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_left_tokenizers</span><span class="p">()</span>
</span><span class="line">        <span class="n">right_tokenizers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_right_tokenizers</span><span class="p">()</span>
</span><span class="line">
</span><span class="line">        <span class="n">id_key</span> <span class="o">=</span> <span class="s">&#39;Id&#39;</span>
</span><span class="line">
</span><span class="line">        <span class="k">def</span> <span class="nf">prepare_join_keys</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">tokenizers</span><span class="p">):</span>
</span><span class="line">            <span class="k">for</span> <span class="n">source_column</span><span class="p">,</span> <span class="n">key_name</span><span class="p">,</span> <span class="n">tokenizer</span> <span class="ow">in</span> <span class="n">tokenizers</span><span class="p">:</span>
</span><span class="line">                <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">source_column</span><span class="p">):</span>
</span><span class="line">                    <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">source_column</span><span class="p">))):</span>
</span><span class="line">                        <span class="k">yield</span> <span class="p">((</span><span class="n">token</span><span class="p">,</span> <span class="n">key_name</span><span class="p">),</span> <span class="n">record</span><span class="p">[</span><span class="n">id_key</span><span class="p">])</span>
</span><span class="line">
</span><span class="line">        <span class="n">left_keyed</span> <span class="o">=</span> <span class="n">left_rdd</span><span class="o">.</span><span class="n">flatMap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">prepare_join_keys</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">left_tokenizers</span><span class="p">))</span>
</span><span class="line">        <span class="n">right_keyed</span> <span class="o">=</span> <span class="n">right_rdd</span><span class="o">.</span><span class="n">flatMap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">prepare_join_keys</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">right_tokenizers</span><span class="p">))</span>
</span><span class="line">
</span><span class="line">        <span class="n">candidates</span> <span class="o">=</span> <span class="p">(</span>
</span><span class="line">            <span class="n">left_keyed</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">right_keyed</span><span class="p">)</span>
</span><span class="line">            <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="p">((</span><span class="n">token</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span> <span class="p">(</span><span class="n">l_id</span><span class="p">,</span> <span class="n">r_id</span><span class="p">)):</span> <span class="p">((</span><span class="n">l_id</span><span class="p">,</span> <span class="n">r_id</span><span class="p">),</span> <span class="p">{</span><span class="n">key</span><span class="p">}))</span>
</span><span class="line">            <span class="o">.</span><span class="n">reduceByKey</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
</span><span class="line">        <span class="p">)</span>
</span><span class="line">
</span><span class="line">        <span class="c"># joining back original records so they can be compared</span>
</span><span class="line">        <span class="n">cand_matches</span> <span class="o">=</span> <span class="p">(</span>
</span><span class="line">            <span class="n">candidates</span>
</span><span class="line">            <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="p">((</span><span class="n">l_id</span><span class="p">,</span> <span class="n">r_id</span><span class="p">),</span> <span class="n">keys</span><span class="p">):</span> <span class="p">(</span><span class="n">l_id</span><span class="p">,</span> <span class="p">(</span><span class="n">r_id</span><span class="p">,</span> <span class="n">keys</span><span class="p">)))</span>
</span><span class="line">            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">left_rdd</span><span class="o">.</span><span class="n">keyBy</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">id_key</span><span class="p">]))</span>
</span><span class="line">            <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="n">l_id</span><span class="p">,</span> <span class="p">((</span><span class="n">r_id</span><span class="p">,</span> <span class="n">keys</span><span class="p">),</span> <span class="n">l_rec</span><span class="p">)):</span> <span class="p">(</span><span class="n">r_id</span><span class="p">,</span> <span class="p">(</span><span class="n">l_rec</span><span class="p">,</span> <span class="n">keys</span><span class="p">)))</span>
</span><span class="line">            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">right_rdd</span><span class="o">.</span><span class="n">keyBy</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">id_key</span><span class="p">]))</span>
</span><span class="line">            <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="n">r_id</span><span class="p">,</span> <span class="p">((</span><span class="n">l_rec</span><span class="p">,</span> <span class="n">keys</span><span class="p">),</span> <span class="n">r_rec</span><span class="p">)):</span> <span class="p">(</span><span class="n">l_rec</span><span class="p">,</span> <span class="n">r_rec</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">keys</span><span class="p">)))</span>
</span><span class="line">        <span class="p">)</span>
</span><span class="line">
</span><span class="line">        <span class="k">def</span> <span class="nf">score_match</span><span class="p">(</span><span class="n">left_rec</span><span class="p">,</span> <span class="n">right_rec</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
</span><span class="line">            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">        <span class="k">def</span> <span class="nf">is_good_enough_match</span><span class="p">(</span><span class="n">match_score</span><span class="p">):</span>
</span><span class="line">            <span class="k">return</span> <span class="n">match_score</span> <span class="o">&gt;=</span> <span class="mi">2</span>
</span><span class="line">
</span><span class="line">        <span class="n">final_matches</span> <span class="o">=</span> <span class="p">(</span>
</span><span class="line">            <span class="n">cand_matches</span>
</span><span class="line">            <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="n">l_rec</span><span class="p">,</span> <span class="n">r_rec</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
</span><span class="line">                 <span class="p">(</span><span class="n">l_rec</span><span class="p">,</span> <span class="n">r_rec</span><span class="p">,</span> <span class="n">score_match</span><span class="p">(</span><span class="n">l_rec</span><span class="p">,</span> <span class="n">r_rec</span><span class="p">,</span> <span class="n">keys</span><span class="p">)))</span>
</span><span class="line">            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="n">l_rec</span><span class="p">,</span> <span class="n">r_rec</span><span class="p">,</span> <span class="n">score</span><span class="p">):</span> <span class="n">is_good_enough_match</span><span class="p">(</span><span class="n">score</span><span class="p">))</span>
</span><span class="line">        <span class="p">)</span>
</span><span class="line">
</span><span class="line">        <span class="k">return</span> <span class="n">final_matches</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>To use it, you have to inherit from <code>DataMatcher</code> and override at a minimum the <code>get_left_tokenizers</code> and <code>get_right_tokenizers</code> functions. You will probably want to override <code>score_match</code> and <code>is_good_enough_match</code> as well, but the default should work in simple cases.</p>

<p>Now we can match our toy datasets in a few lines oc code, like this:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">class</span> <span class="nc">ComicBookMatcher</span><span class="p">(</span><span class="n">DataMatcher</span><span class="p">):</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">get_left_tokenizers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">        <span class="k">return</span> <span class="p">[</span>
</span><span class="line">            <span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="s">&#39;name_tokens&#39;</span><span class="p">,</span> <span class="n">tokenize_name</span><span class="p">),</span>
</span><span class="line">            <span class="p">(</span><span class="s">&#39;address&#39;</span><span class="p">,</span> <span class="s">&#39;address_tokens&#39;</span><span class="p">,</span> <span class="n">tokenize_address</span><span class="p">),</span>
</span><span class="line">            <span class="p">(</span><span class="s">&#39;phone&#39;</span><span class="p">,</span> <span class="s">&#39;phone_tokens&#39;</span><span class="p">,</span> <span class="n">tokenize_phone</span><span class="p">)</span>
</span><span class="line">        <span class="p">]</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">get_right_tokenizers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">        <span class="k">return</span> <span class="p">[</span>
</span><span class="line">            <span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="s">&#39;name_tokens&#39;</span><span class="p">,</span> <span class="n">tokenize_name</span><span class="p">),</span>
</span><span class="line">            <span class="p">(</span><span class="s">&#39;postcode&#39;</span><span class="p">,</span> <span class="s">&#39;address_tokens&#39;</span><span class="p">,</span> <span class="n">tokenize_address</span><span class="p">),</span>
</span><span class="line">            <span class="p">(</span><span class="s">&#39;personal phone&#39;</span><span class="p">,</span> <span class="s">&#39;phone_tokens&#39;</span><span class="p">,</span> <span class="n">tokenize_phone</span><span class="p">),</span>
</span><span class="line">            <span class="p">(</span><span class="s">&#39;business phone&#39;</span><span class="p">,</span> <span class="s">&#39;phone_tokens&#39;</span><span class="p">,</span> <span class="n">tokenize_phone</span><span class="p">)</span>
</span><span class="line">        <span class="p">]</span>
</span><span class="line">
</span><span class="line"><span class="n">cbm</span> <span class="o">=</span> <span class="n">ComicBookMatcher</span><span class="p">()</span>
</span><span class="line">
</span><span class="line"><span class="n">final_matches</span> <span class="o">=</span> <span class="n">cbm</span><span class="o">.</span><span class="n">match_rdds</span><span class="p">(</span><span class="n">left_rdd</span><span class="p">,</span> <span class="n">right_rdd</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Short and sweet.</p>

<p>There are some optimisations that can be done to improve speed of the pipeline, I omitted them here for clarity. More importantly, in any nontrivial usecase you will want to use a more sophisticated evaluation function than the default one. This will be the subject of the next post.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/07/20/datamatching-part-1/">Datamatching Part 1: Algorithm</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-07-20T21:59:14+01:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>20</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>9:59 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this and the next post I will explain the basics of datamatching and give an implementation of a bare-bones datamatching pipeline in pyspark.</p>

<h3 id="datamatching">Datamatching</h3>
<p>You have a dataset of - let’s say - names and addresses of some group of people. You want to enrich it with information scraped from e.g. linkedin or wikipedia. How do you figure out which scraped profiles match wich records in your database?</p>

<p>Or you have two datasets of sales leads maintained by different teams and you need to merge them. You know that there is some overlap between the records but there is no unique identifier that you can join the datasets on. You have to look at the the records themselves to decide if they match.</p>

<p>Or you have a dataset that over that years has collected some duplicate records. How do you dedup it, given that the data format is not consistent and there may be errors in the records?</p>

<p>All of the above are specific cases of a problem that can be described as:
 <em>Finding all the pairs (groups) of records in a dataset(s) that correspond to the same real-world entity.</em></p>

<p>This is what I will mean by datamatching in this post.</p>

<p>This type of task is very common in data science, and I have done it (badly) many times before finally coming up with a generic, clean and scalable solution. There are already many commercial solutions to specific instances of this problem out there and I know of at least two startups whose main product is datamatching. Nevertheless for many usecases a DIY datamatching pipeline should be just as good and may be easier to build than integration with an external service or application.</p>

<h3 id="an-example">An example</h3>
<p>The general problem of datamatching will be easier to discuss with a specific example in mind. Here goes:</p>

<p>You work at a company selling insurance to comic book characters. You have a database of 50.000 potential clients (these are the first 3):</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">  Id  address                       company                     name                phone
</span><span class="line">----  ----------------------------  --------------------------  ------------  -----------
</span><span class="line">   1  1007 Mountain Drive, Ogtham   Wayne Enterprises           Bruce Wayne   01234567890
</span><span class="line">   2  Gotham Cemetery               Wayne Enterprises           Thomas Wayne
</span><span class="line">   3  56431 Some Place, New Mexico  U.S. Department of Defense  Bruce Banner
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>and you just acquired 400.000 new leads:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">Id    business phone     name                  personal phone    postcode
</span><span class="line">----  -----------------  ------------------  ----------------  ----------
</span><span class="line">a     +735-123-456-7890  Wayne, Burce
</span><span class="line">b                        B. Banner                  897654322       56431
</span><span class="line">c                        Pennyworth, Alfred                          1007
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>You need to reconcile the two tables - find which (if any) records from the second table correspond to records in the first. Unfortunately data in both tables is formatted differently and there are some typos in both (“Burce”, “Ogtham”). Nevertheless it is easy for a human being to figure out who is who just by eyeballing the two datasets. <script type="math/tex">Id = 1</script> from the first table and <script type="math/tex">Id = a</script> from the second clearly refer to the same person - Bruce Wayne. And <script type="math/tex">Id = 3</script> matches <script type="math/tex">Id =  b</script> - Bruce Banner. The remaining records - Thomas Wayne and Alfred Pennyworth don’t have any matches.</p>

<p>Now, how to do the same automatically and at scale? Comparing every record from one table to every one in the other - <script type="math/tex">50k \times 400k = 2 \times 10^9</script> comparisons - is out of the question.</p>

<h3 id="the-impatient-programmer-approach">The impatient programmer approach</h3>
<p>Like any red-blooded programmer, when I see a list of things to be matched to other things, I immediately think: hashmaps. My internal dialogue goes something like this:</p>

<ul>
  <li><em>Let’s make a lookup {name -&gt; Id} using the first table and iterate over the second table</em></li>
  <li>But the names are in a different format, they won’t match</li>
  <li><em>OK, let’s normalize the names first, strip punctuation, put the words in alphabetical order</em></li>
  <li>Still won’t match - Bruce Banner is abbreviated to B. Banner in one of the tables</li>
  <li><em>Fair enough. Let’s have two separate entries in the lookup for ‘Bruce’ and ‘Banner’ both pointing to Id = 3</em></li>
  <li>but we don’t want to match just any ‘Bruce’ or  any ‘Banner’ to this guy</li>
  <li><em>Yeah, will have to use the remaining attributes to verify if a match is legit. Generate potential matches by looking up every word in the ‘name’ field, and validate by checking if the other fields look similar. This should work</em></li>
  <li>what if the name is empty or misspeled, but all other fields match up perfectly? Shouldn’t this be still considered a match?</li>
  <li><em>Now you’re being difficult on purpose! FINE. Let’s have multiple lookups - name -&gt; Id, phone -&gt; Id, etc. A pair of records will be considered a potential match if they have at least one of those in common</em></li>
</ul>

<p>This is beginning to sound unwieldy, but it’s basically the correct approach and - I strongly suspect - the only workable approach. At least as long as we’re not taking the hashmaps too literally. But let’s reformulate it in slightly more abstract terms before diving into implementation.</p>

<h3 id="generalising">Generalising</h3>
<p>Datamatching must consist of two stages:</p>

<ol>
  <li>Generate candidate matches</li>
  <li>For every record, pick the best match among the candidates</li>
</ol>

<p>In this post I will assume that we have a good way of evaluating candidate matches (step 2) and concentrate only on step 1. In fact 2 is crucial and usually harder than 1 but it’s very case-specific. More on that topic next time.</p>

<h4 id="generating-candidates">Generating candidates</h4>
<p>When is a pair of records a good candidate for a match? When the records have something in common. What? For example one of the fields - like phone number or name or address. That would definitely suffice but it’s too restrictive. Consider Bruce Wayne from our example. In the first table:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="s">&#39;Id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class="line">    <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;Bruce Wayne&#39;</span><span class="p">,</span>
</span><span class="line">    <span class="s">&#39;address&#39;</span><span class="p">:</span> <span class="s">&#39;1007 Mountain Drive, Gotham&#39;</span><span class="p">,</span>
</span><span class="line">    <span class="s">&#39;phone&#39;</span><span class="p">:</span> <span class="s">&quot;01234567890&quot;</span><span class="p">,</span>
</span><span class="line">    <span class="s">&#39;company&#39;</span><span class="p">:</span> <span class="s">&quot;Wayne Enterprises&quot;</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>And in the second table:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="s">&#39;Id&#39;</span><span class="p">:</span> <span class="s">&#39;a&#39;</span><span class="p">,</span>
</span><span class="line">    <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;Wayne, Burce&#39;</span><span class="p">,</span>
</span><span class="line">    <span class="s">&#39;postcode&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
</span><span class="line">    <span class="s">&#39;personal phone&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
</span><span class="line">    <span class="s">&#39;business phone&#39;</span><span class="p">:</span> <span class="s">&#39;+735-123-456-7890&#39;</span><span class="p">,</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Not a single field in common between these two records and yet they clearly represent the same person.</p>

<p>It is tempting to try to normalise phone numbers by stripping area extensions, fix misspeled names, normalise order of first-, middle-, last name, etc. And sometimes this may be the way to go. But in general it’s ambiguous and lossy. 
There will never be a normalisation function that does the right thing for every possible version of the name:</p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">&quot;Bruce Wayne&quot;
</span><span class="line">&quot;Bruce T. Wayne&quot;
</span><span class="line">&quot;B.T. Wayne&quot;
</span><span class="line">&quot;Wayne, Burce&quot;
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>What we can do instead is extract <em>multiple</em> tokens (think: multiple hashes) from the name. A pair of records will be considered a candidate match if they have at least one token in common.</p>

<p>We can for example just split the name on whitespaces:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">&quot;Bruce Thomas Wayne&quot; -&gt; [&quot;Bruce&quot;, &quot;Thomas&quot;, &quot;Wayne&quot;]
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>and have this record be matched with every “Bruce” every “Thomas” and every “Wayne” in the dataset. This may or may not be a good idea depending on how many “Bruces” there are in this specific dataset. But tokens don’t have to be words. We can try bigrams:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">&quot;Bruce Thomas Wayne&quot; -&gt; [&quot;Bruce Thomas&quot;, &quot;Thomas Wayne&quot;]
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Or we can try forming initials:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">&quot;Bruce Thomas Wayne&quot; -&gt; [&quot;B.T. Wayne&quot;, &quot;B. Wayne&quot;, &quot;B.T.W&quot;]
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>If we did that, then for instance both “Bruce Wayne” and “Burce T. Wayne” would get “B. Wayne” as one of the tokens and would end up matched as a result.</p>

<p>If we tokenize by removing vowels, that would go a long way toward fixing typos and alternative spellings while introducing few false positives:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">&quot;Bruce Wayne&quot; -&gt; [&quot;Brc Wyn&quot;]
</span><span class="line">&quot;Burcee Wayn&quot; -&gt; [&quot;Brc Wyn&quot;]
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>There are also algorithms like <a href="https://en.wikipedia.org/wiki/Soundex">Soundex</a> that tokenize based on how a word <em>sounds</em> regardless of how it’s spelled. Soundex gives the same result for “Bruce” and “Broose” and “Bruise” or for “John” and “Jon”. Very useful given that a lot data entry is done by marketers who talk to people (and ask their names) over the phone.</p>

<p>Finally, nothing stops us from using all of the above at the same time:</p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">&quot;Bruce Thomas Wayne&quot; -&gt; [&quot;Bruce Thomas&quot;, &quot;Thomas Wayne&quot;, &quot;B.T. Wayne&quot;, &quot;B. Wayne&quot;, &quot;B.T.W&quot;, &quot;Brc Wyn&quot;, ...]
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>With this, all the different ways of spelling “Bruce Wayne” should get at least one token in common and if we’re lucky few other names will.</p>

<p>This was an overview of name tokenization. Other types of data will require their own tokenization rules. The choice of tokenization logic necessarily depends on the specific data type and dataset but these the general principles:</p>

<ul>
  <li>tokenization should try to fix ambiguities in the data. If there are multiple ways a real world entity can be represented in the dataset, good tokenizer would give all of them the same token</li>
  <li>tokens should be specific enough records representing different real world entities only rarely get a token in common</li>
</ul>

<p>One not name-related example: phone numbers. Since people enter phone numbers in databases in one thousand different formats with all kinds of rubbish area codes and extensions you shouldn’t count on raw phone numbers matching perfectly. An example of a sensible tokenizer is one that first strips all non-digit characters from the phone number then returns the last 8 digits.</p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">&quot;+44-1-800-123-4567-890 and ask for Mary&quot; -&gt; [&quot;34567890&quot;]
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>Or to guard against people putting extensions at the end of phone numbers, we can extract <em>every</em> consecutive 8 digits:</p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">&quot;800-555-2222,123&quot; -&gt; [&quot;80055522&quot;, &quot;00555222&quot;&quot;, &quot;05552222&quot;, &quot;55522221&quot;, &quot;55222212&quot;, &quot;52222123&quot;]
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>This should catch any reasonable way of writing the number while still having very low likelihood of a collision.</p>

<h4 id="tldr">TL;DR</h4>
<p>To match two datasets:</p>

<ol>
  <li>Tokenize corresponding fields in both datasets</li>
  <li>Group records having a token in common (think SQL join)</li>
  <li>Compare records withing a group and choose the closest match</li>
</ol>

<p>Coming up: how to implement this in spark.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/06/15/dear-recruiter/">Dear Recruiter</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-06-15T11:22:10+01:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>15</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>11:22 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I’ve had a lot of experience with tech interviews and recruiters in the past and I’m likely to have a lot more in the future. A non-negligible fraction of that experience ranged from “mildly annoying” to “exasperating”.</p>

<p>Here’s a list of real examples of irritating recruiter behaviors together with guidlines on how I expect a reasonable person to act instead.</p>

<p>Before we start you must understand where I’m coming from. I’m not constantly looking for new jobs. But when I do, I apply en masse and then I have to deal with many recruiters at once. Each one constantly calling me in the office or at home (what is it with your obsession with phone calls? Why not email?). This in itself can get annoying but on top of that there are other more serious offenses. I am usually extremely agreeable both in person and over the phone. A blog post is my way of expressing complaints that I wouldn’t dare make in a conversation with you. It’s also a form of catharsis so forgive me if I get somewhat snarky and don’t take offense if you personally are not guilty of the sins mentioned here.</p>

<h3 id="when-you-contact-me-about-a-new-role">When you contact me about a new role</h3>
<blockquote>
  <p>I have an exciting opportunity with a global company, one of the leaders in its field. When can we arrange a call?</p>
</blockquote>

<p>This tells me nothing. Everyone is either a “leader in their field” or an “exciting startup” or a “global brand”. I’m getting 5 of these a day. If I am to commit any time to it I first need to know:</p>

<ul>
  <li>type of role (data scientist? developer? devops? junior? lead? manager?)</li>
  <li>ballpark salary</li>
  <li>skills they are looking for</li>
</ul>

<p>Ideally, if possible, also</p>

<ul>
  <li>what are they trying to build/do</li>
</ul>

<p>This information is typically enough for me to decide if I’m interested or not. I will let you know if I am. I really don’t need to listen to you talk about their nice offices and what fancy university has the CTO attended. If I’m interested in these things I will look them up myself. This conversation is not going to change my mind one way or the other.</p>

<p>If you want to chat with me because you need to vet me before passing my CV on to the company <strong>please say so</strong> and <strong>indicate clearly</strong> what your decision is afterwards. And don’t do this bait-and-switch on me where I express interest in one position and you call me to discuss but only try to peddle another.</p>

<p>In short, this is how it’s going to work:</p>

<ol>
  <li>you email me basic details of the role (or multiple roles)</li>
  <li>I email you back with my latest CV if I’m interested or with questions if I have any</li>
  <li>you send my details over the company and try to arrange an interview</li>
</ol>

<p>If you absolutely need to hear my voice and vet me, say so. If I’m interested in the role, we can get it over with <strong>once</strong>.</p>

<h4 id="before-the-interview">Before the interview</h4>
<blockquote>
  <p>Let me know what is the best time to call you so that I can talk you through the interview process</p>
</blockquote>

<p>Why? It’s a job interview not open heart surgery. There will be a 20 minutes phone call with HR, then an hour with some technical person then 3 hours of technical on-site interviews then a brief chat with some higher-up. Or a homework assignment, then technical phone call, then on-site, then HR. Or some other configuration. Whatever the case, you could’ve explained it in the email and save us both time. Frankly, I don’t care what the format is. All I need from you is the time and place and it is definitely possible to send those by email.</p>

<blockquote>
  <p>I will call you before the interview to give you a heads up</p>
</blockquote>

<p>No.</p>

<blockquote>
  <p>Are you interviewing with any other companies? Tell me, so we can adjust the schedule so that you don’t miss this opportunity</p>
</blockquote>

<p>What you mean is “we can adjust the schedule so that you don’t get the chance to interview with anyone else” (more on that later). Thank you very much. I don’t want to lie to you, so I’m just not going to tell you anything. If I actually need to speed things up because of other interviews, I will let you know. By email.</p>

<p>How it is going to work:</p>

<ol>
  <li>you give me time and place</li>
  <li>I confirm that I will show up</li>
</ol>

<h3 id="after-the-interview">After the interview</h3>
<blockquote>
  <p>Please call me after the interview to tell me how did it go …</p>
</blockquote>

<p>It went well. Probably. Or maybe not. Either way it doesn’t really matter how <em>I</em> think it went, does it?</p>

<blockquote>
  <p>… what was it like …</p>
</blockquote>

<p>It was like every other interview I’ve been to. First they introduced themselves and the company, then we talked about my resume, then about my motivation and finally they gave me some vaguely job-related problems to solve and I solved them. What else did you expect?</p>

<blockquote>
  <p>… how did you like them</p>
</blockquote>

<p>I liked them fine. Or maybe I loved them. Or maybe I thought they were boring. You won’t find out by calling though, because I’m only gonna feed you some enthusiastic sounding platitudes because I want to get to the next stage in this process. There is no upside for me in telling you that I thought the interviewers were boring and dumb even if it was true. So just don’t ask. In the unlikely event that I hated the interview enough to make me want to withdraw my application, I promise to let you know. By - you guessed it - email.</p>

<p>How it’s going to work:</p>

<ol>
  <li>if you have any feedback from the interviewers or a decision, you will email it to me</li>
  <li>if I want to take myself out of the process I will inform you also by email</li>
</ol>

<h3 id="the-final-stretch">The final stretch</h3>
<p>So I made it through all the rounds and I’m expecting to hear back from the company. You call me saying you have some positive initial feedback, then we have this conversation:</p>

<blockquote>
  <p>You: If they come back with an offer of £n are you going to accept?<br />
Me: I don’t know. I’ll need a couple of days to think about it.<br />
You: Why wouldn’t you accept it? What is wrong with the offer?<br />
Me: Nothing is wrong with it. I just need some time to consider my options. Not very long, just the weekend.<br />
You: If there is nothing wrong with the offer then you should take it. I need to get back to them and tell them that you are going to take the offer. Otherwise they will think that you are not really motivated to work with them and they will not make the offer.<br />
Me: What are you talking about?! They know I’m motivated. But this is a serious decision and I will not make it without proper consideration.<br />
You: They have deadlines, you know. They can’t wait forever.<br />
Me: It’s only two days!<br />
You: If I don’t tell them you will accept, they will keep interviewing and they can find someone else. This is a very buyoant market!<br />
…</p>
</blockquote>

<p>This is <strong>bullshit</strong> and you know it. This is not a heist movie and you’re not looking for a last minute replacement safe cracker. The job ad has been out for months. I think they can wait two more days.</p>

<p>One time this happened to me right after the interview. The recruiter didn’t even wait to hear from the company in question. He based this whole routine on my reporting that the interview went well and that we discussed money at the end. This was also a case of him putting me up for a job that paid 10% less than the one I held at the time even though I explicitly required that my new position pays 10% more. I only found out during the final interview.</p>

<p>Another recruiter upon learning that I’m interviewing with other companies got my final interview cancelled. My first interview was on Monday and the final one was supposed to take place a week later. On Wednesday he asked me about other interviews, then we’ve had the bullshit “you’ve got to accept” conversation. When I didn’t budge, the recruiter got the company to make me an offer that evening, skipping the final interview. The offer came with an expiration date on 12am the following day! 4 days before the planned interview. He even blurted out that the insane timing was because they were afraid they would lose me, before covering up with the deadlines and buyoant markets bs. That they have to resort to this type of tactics is all the proof I need that the market for data scientists isn’t buyoant at all. <em>Obviously</em> they were afraid I would accept another offer. And the only reason they were afraid was that the recruiter tipped them off.</p>

<p>I understand now that we’re not allies. We are not exactly oponents but you’re definitely playing for a different team.</p>

<p>So I am not going to make it easy for your team. I will not get caught up in the false sense of urgency you’re trying to create (one recruiter tried to get me to come to the office and sign the contract on a Sunday) … ever again. I will not fall for scare tactics. I will not reveal any information about other interviews I may be having. Here’s what <em>will</em> happen:</p>

<ol>
  <li>you will only contact me when you have an offer</li>
  <li>I will take my time considering that offer - and I will tell you how long exactly. Shorter if it’s a “start immediately” fixed term contract, longer if it’s a permanent position, but I will never be bullied into committing to a contract I haven’t even seen</li>
  <li>I will ignore any exploding offer deadlines so don’t even bother. The only exception is if the deadline has been established up front before any interviews</li>
</ol>

<p>It’s worth noting that I have never experienced anything resembling the “bullshit conversation” when I dealt with a potential employer directly. When applying through recruiters it happened <em>every time</em>.</p>

<h3 id="final-notes">Final notes</h3>

<ul>
  <li>no I will not have coffee with you. Why would you even think I’d like that?</li>
  <li>I don’t need you to tell me that “if you like the job you should be flexible about the money” or that “these companies are not going to wait forever, better apply now”</li>
  <li>in general I would appreciate if you keep your obviously-biased career advice to yourself</li>
  <li>any tips regarding my resume or specific interviews are very welcome</li>
  <li>if you can write an email to arrange a call to tell me X, you can just tell me X in the email</li>
</ul>

<p>If these ground rules seem unreasonable to you, then save us both the trouble and don’t contact me.</p>

<p>Yours Exasperatedly<br />
<em>nadbor</em></p>

<h3 id="ps">P.S.</h3>
<p>I didn’t intend to make it read like I’m bragging about all the offers I’m getting like I’m God’s gift to data science who can get any job he wants. It’s just that I’ve interviewed <em>a lot</em> over the years so in addition to dozens of rejections I have had several successes too. I’m only describing here the more successful examples because in case of rejection recruiters tend to mercifully leave me alone.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/06/13/deepwalking-with-companies/">Deepwalking With Companies</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-06-13T22:19:12+01:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>10:19 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I have blogged about the wide usefulness of <a href="http://nadbordrozd.github.io/blog/2015/11/29/ds-toolbox-topic-models/">topic models</a> and I have <a href="http://nadbordrozd.github.io/blog/2016/05/20/text-classification-with-word2vec/">benchmarked</a> word-embedding-assisted classification on Reuter’s benchmark. This time I experiment with these ideas using a real world and decent sized dataset - the graph of UK/Irish companies. I have done this during my “10% time” at <a href="http://www.duedil.com">DueDil</a> (it’s like google’s “20% time”, except it <a href="http://uk.businessinsider.com/google-20-percent-time-policy-2015-4?r=US&amp;IR=T">exists</a>).</p>

<h3 id="graph-of-companies">Graph of companies</h3>
<p>There are 4 million active companies in the UK and Ireland. DueDil collects all kinds of information about them - financials, legal structures, contact info, company websites, blogs, news appearences etc. All of it is presented to our users and some of it also serves as input to machine learning tasks - like classifying companies into industries.</p>

<p>One very interesting dataset that remains underutilised (AFAIK by anyone, not just DueDil) is the network of connections of companies and directors.</p>

<p>You can tell a lot about a company just by looking at its directors. That is - if you know anything about these people. At DueDil we don’t know much more than just their identities. This would be rather useless in the context of a single company. But there are millions of companies and people who serve as their directors more often then not do it many times in their careers at different companies. Knowing that the director’s name is Jane Brown may be useless, but knowing that the director previously held similar positions at three different tech startups is highly relevant. And this is just one director out of many and one type of relationship.</p>

<p>More generally, one can think about companies as nodes in a graph. Two companies are connected iff there is a person who has served as a director at both of them (not necessarily at the same time). I will call this the <strong>company graph</strong>. Here’s a part of the graph containing DueDil.</p>

<p><img src="/images/comp_graph.png" /></p>

<p>DueDil is connected to Founders For Good Ltd because our CEO Damian Kimmelman is also a director at the other company.</p>

<p>It is intuitive that the position of a company in this graph tells us something about the company. It is however difficult to do anything with this information unless it is somehow encoded into numbers.</p>

<h3 id="company2vec">Company2Vec</h3>
<p>This is where word embeddings come in. As I mentioned previously, it is possible to apply Word2Vec to a graph to get an embedding of graph nodes as real-valued vectors in a procedure called <a href="http://arxiv.org/abs/1403.6652">DeepWalk</a>. The idea is very simple:</p>

<ol>
  <li>Construct a bunch of random walks on the graph</li>
  <li>Feed the random walks into Word2Vec</li>
</ol>

<p>A random walk is just a sequence of nodes, where the next node is always one of the neighbours of the previous node, chosen at random. Think: Duedil -&gt; Founders For Good Ltd -&gt; Omio Limited.</p>

<p>Word2Vec accepts a collection of documents - where every document is a list of tokens (strings). Here company Id’s play the role of tokens and random walks play the role of documents. It all checks out.</p>

<p>To limit the size of the graph for this proof of concept, I have applied this procedure only to the 2.2 million companies that</p>

<ol>
  <li>are active</li>
  <li>have at least one edge (director in common) to another active company</li>
</ol>

<p>I generated 10 random walks starting at every company, the length of each walk was 40. Training Word2Vec with <a href="https://radimrehurek.com/gensim/models/word2vec.html">gensim</a> on this corpus of $10 \times 40 \times 2200000 = 8.8 \times 10^8$ tokens took over 11h. It also took a machine with 40gb of RAM before it stopped crashing even though the random walks were generated on-line.</p>

<p>Finally I got some vectors out of it - one per company. These vectors themselves were the goal of this project (they can serve as features in ML), but I also made some plots to verify that the algorithm is working as advertised.</p>

<h3 id="pretty-pictures-with-t-sne-and-bokeh">Pretty pictures with t-SNE and Bokeh</h3>
<p>The embedding produced by DeepWalk was 100-dimensional in this case, so I had to do some dimensionality reduction before trying to visualize the vectors. <a href="https://github.com/danielfrg/tsne">t-SNE</a> is perfect for this kind of thing. Here’s a sample of 40000 company vectors embedded in 2D with t-SNE. You can move or zoom in the plot or hover over the dots to see the names of the corresponding companies.</p>

<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Bokeh Plot</title>

<link rel="stylesheet" href="https://cdn.pydata.org/bokeh/release/bokeh-0.11.1.min.css" type="text/css" />

<script type="text/javascript" src="https://cdn.pydata.org/bokeh/release/bokeh-0.11.1.min.js"></script>
<script type="text/javascript">
    Bokeh.set_log_level("info");
</script>
    </head>
    <body>

        <div class="plotdiv" id="7953daf6-6ca5-48d8-be1e-4cd0ab91f1f8"></div>

        <script type="text/javascript" src="/javascripts/custom/deepwalk_bokeh/40k_black_g.js"></script>
    </body>
</html>

<p>It worked! You can immediately see that there is some structure in the data and t-SNE has picked up on it (and this is only a tiny sample - 2% of all the datapoints). What does this structure mean? After the graph has beed transformed with DeepWalk and then t-SNE, the position of a company in this plot doesn’t have a simple interpretation but it’s clear that groups of highly interconnected companies will correspond to clusters of points in this plot. And it’s easy to verify just by looking at the names of the companies that this is the case.</p>

<p>Take the big blob in the upper left corner - the companies there:</p>

<ul>
  <li>Edwards Macliammoir Dublin Gate Theatre Productions Limited</li>
  <li>Humanist Association of Ireland Limited</li>
  <li>Kildare Street Management Limited</li>
  <li>Shannon Airport Authority Limited</li>
</ul>

<p>We have discovered the cluster of irish companies! And if you zoom in on the long, narrow appendage sticking out of this cluster towards bottom left - you’ll see companies like:</p>

<ul>
  <li>Tempelhof Aircraft Leasing (Ireland) Limited</li>
  <li>Gallic Dragon Aviation Limited</li>
  <li>Aergen Aircraft Ten Limited</li>
</ul>

<p>… and hundreds more. This is not even cherry-picked. I hereby declare the discoverery of the Irish Aviation Peninsula.</p>

<p>Slightly up and to the right of center there is a smaller scottish cluster recognizable through such companies as</p>

<ul>
  <li>Caledonian Sausage Company</li>
  <li>Edinburgh Tattoo Productions Limited</li>
  <li>Dundee Ice Arena</li>
</ul>

<p>There are many other smaller clusters and it’s actually a fun exercise to try to pinpoint exactly what do the companies in a cluster have in common.</p>

<h4 id="now-in-color">Now in color!</h4>
<p>This was fun if somewhat grim looking. Let’s try to add some color to the plot. The original goal of this project was to get graph-derived features for industry classification. Let’s try using different colors to denote different industries (based on SIC codes). If DeepWalk coordinates are predictive of the industry a company is in, we should expect to see same-colored dots (companies in the same industry) clustering together in the plot. Does this actually happen?</p>

<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Bokeh Plot</title>

<link rel="stylesheet" href="https://cdn.pydata.org/bokeh/release/bokeh-0.11.1.min.css" type="text/css" />

<script type="text/javascript" src="https://cdn.pydata.org/bokeh/release/bokeh-0.11.1.min.js"></script>
<script type="text/javascript">
    Bokeh.set_log_level("info");
</script>
    </head>
    <body>

        <div class="plotdiv" id="66d4a3dd-9a8a-4d0a-892f-4fd8be74f711"></div>
        <script type="text/javascript" src="/javascripts/custom/deepwalk_bokeh/40k_ind_g.js"></script>
    </body>
</html>

<p>A little bit, yes.</p>

<p>Mostly everything is a big reddish mess (“services” is the most popular category). But there are indeed some clusters. Right of center we can see a medium sized pink blob of insurance companies:</p>

<ul>
  <li>US Risk (UK) Newco Limited</li>
  <li>Zenith Insurance Management UK Limited</li>
  <li>North Star Underwriting Limited</li>
</ul>

<p>Below it and to the left lies another, this one green:</p>

<ul>
  <li>Timeless Films Limited</li>
  <li>Hercules Productions Ltd</li>
  <li>Koninck studios PTE Limited</li>
</ul>

<p>Clearly this is a cluster of film companies (plus other media). If you look more closely you will discover that this is actually the cluster of <em>London based</em> film companies. Nearby there is a smaller green cluster of media companies from the rest of England and another one for Wales. These are less clearly delimited and partly obscured by the red dots of “Services” companies. There are many others, but they are sometimes so tight, they appear as a single dot in the plot.</p>

<p>This is more noisy than I hoped for but it’s definitely working. Would definitely improve accuracy of industry classification if used with other stronger features. Plus you can learn interesting things from it just by looking at the plot. Like the fact that film production companies are closely connected to each other and relatively unconnected to the rest of the world. Or that London is a different country as far as media companies are concerned.</p>

<h4 id="bonus-keyword-based-company-embedding">Bonus: keyword based company embedding</h4>
<p>Having all this t-SNE and Bokeh niceness in place I couldn’t resist applying it to another interesting dataset - keywords. Keywords are a set of industry related tags that DueDil has for millions of companies. They are things like “fishing” or “management consulting” or “b2b”. A company usually has between a few and a few dozen of them.</p>

<p>A byproduct of the pipeline that extracts keywords for companies is a Word2Vec embedding of the keywords. I used this embedding to create an embedding of companies. This was done simply by averaging all the vectors corresponding to a company’s keywords. I ran the resulting vectors through t-SNE and here’s what it looks like:</p>

<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Bokeh Plot</title>

<link rel="stylesheet" href="https://cdn.pydata.org/bokeh/release/bokeh-0.11.1.min.css" type="text/css" />

<script type="text/javascript" src="https://cdn.pydata.org/bokeh/release/bokeh-0.11.1.min.js"></script>
<script type="text/javascript">
    Bokeh.set_log_level("info");
</script>
    </head>
    <body>

        <div class="plotdiv" id="8fd1f452-080d-4d66-af86-a63a3b60f6dd"></div>
        <script type="text/javascript" src="/javascripts/custom/deepwalk_bokeh/50k_ind_kw.js"></script>
    </body>
</html>

<p>I shouldn’t be surprised that keywords - which were picked to be industry related - predict the industry really well. But I was blown away by the level of detail preserved by t-SNE. There are recognizable islands for everything. There is a golden Farmers Archipelago and a narrow blue Dentist Island south from Home Care Island. There is a separate Asian Island in the Restaurant Archipelago - go see for yourself.</p>

<p>This was fun. Long live Word2Vec and t-SNE!</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/05/22/one-weird-trick-that-will-fix-your-pyspark-schemas/">Data Engineers Will Hate You - One Weird Trick to Fix Your Pyspark Schemas</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-05-22T21:39:15+01:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>22</span><span class='date-suffix'>nd</span>, <span class='date-year'>2016</span></span> <span class='time'>9:39 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I will share with you a snippet that took out a lot of misery from my dealing with pyspark dataframes. This is pysparks-specific. Nothing to see here if you’re not a pyspark user. The first two sections consist of me complaining about schemas and the remaining two offer what I think is a neat way of creating a schema from a dict (or a dataframe from an rdd of dicts).</p>

<h4 id="the-good-the-bad-and-the-ugly-of-dataframes">The Good, the Bad and the Ugly of dataframes</h4>
<p>Dataframes in pyspark are simultaneously pretty great and <del>kind of</del> completely broken.</p>

<ul>
  <li>they enforce a schema</li>
  <li>you can run SQL queries against them</li>
  <li>faster than rdd</li>
  <li>much smaller than rdd when stored in parquet format</li>
</ul>

<p>On the other hand:</p>

<ul>
  <li>dataframe join sometimes gives <a href="https://issues.apache.org/jira/browse/SPARK-10892">wrong results</a></li>
  <li>pyspark dataframe outer join acts as an inner join</li>
  <li>when cached with <code>df.cache()</code> dataframes sometimes start throwing <code>key not found</code> and Spark driver dies. Other times the task succeeds but the the underlying rdd becomes corrupted (field values switched up).</li>
  <li>not really dataframe’s fault but related - parquet is not human readable which sucks - can’t easily inspect your saved dataframes</li>
</ul>

<p>But the biggest problem is actually transforming the data. It works perfectly on those contrived examples from the tutorials. But I’m not working with flat SQL-table-like datasets. Or if I am, they are already in some SQL database. When I’m using Spark, I’m using it to work with messy multilayered json-like objects. If I had to create a UDF and type out a ginormous schema for every transformation I want to perform on the dataset, I’d be doing nothing else all day, I’m not even joking. UDFs in pyspark are clunky at the best of times but in my typical usecase they are unusable. Take this, relatively tiny record for instance:</p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">record</span> <span class="o">=</span> <span class="p">{</span>
</span><span class="line">    <span class="s">&#39;first_name&#39;</span><span class="p">:</span> <span class="s">&#39;nadbor&#39;</span><span class="p">,</span>
</span><span class="line">    <span class="s">&#39;last_name&#39;</span><span class="p">:</span> <span class="s">&#39;drozd&#39;</span><span class="p">,</span>
</span><span class="line">    <span class="s">&#39;occupation&#39;</span><span class="p">:</span> <span class="s">&#39;data scientist&#39;</span><span class="p">,</span>
</span><span class="line">    <span class="s">&#39;children&#39;</span><span class="p">:</span> <span class="p">[</span>
</span><span class="line">        <span class="p">{</span>
</span><span class="line">            <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;Lucja&#39;</span><span class="p">,</span>
</span><span class="line">            <span class="s">&#39;age&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
</span><span class="line">            <span class="s">&#39;likes cold showers&#39;</span><span class="p">:</span> <span class="bp">True</span>
</span><span class="line">        <span class="p">}</span>
</span><span class="line">    <span class="p">]</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>the correct schema for this is created like this:</p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">StringType</span><span class="p">,</span> <span class="n">StructField</span><span class="p">,</span> <span class="n">StructType</span><span class="p">,</span> <span class="n">BooleanType</span><span class="p">,</span> <span class="n">ArrayType</span><span class="p">,</span> <span class="n">IntegerType</span>
</span><span class="line"><span class="n">schema</span> <span class="o">=</span> <span class="n">StructType</span><span class="p">([</span>
</span><span class="line">        <span class="n">StructField</span><span class="p">(</span><span class="s">&quot;first_name&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">(),</span> <span class="bp">True</span><span class="p">),</span>
</span><span class="line">        <span class="n">StructField</span><span class="p">(</span><span class="s">&quot;last_name&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">(),</span> <span class="bp">True</span><span class="p">),</span>
</span><span class="line">        <span class="n">StructField</span><span class="p">(</span><span class="s">&quot;occupation&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">(),</span> <span class="bp">True</span><span class="p">),</span>
</span><span class="line">        <span class="n">StructField</span><span class="p">(</span><span class="s">&quot;children&quot;</span><span class="p">,</span> <span class="n">ArrayType</span><span class="p">(</span>
</span><span class="line">            <span class="n">StructType</span><span class="p">([</span>
</span><span class="line">                <span class="n">StructField</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">(),</span> <span class="bp">True</span><span class="p">),</span>
</span><span class="line">                <span class="n">StructField</span><span class="p">(</span><span class="s">&quot;age&quot;</span><span class="p">,</span> <span class="n">IntegerType</span><span class="p">(),</span> <span class="bp">True</span><span class="p">),</span>
</span><span class="line">                <span class="n">StructField</span><span class="p">(</span><span class="s">&quot;likes cold schowers&quot;</span><span class="p">,</span> <span class="n">BooleanType</span><span class="p">(),</span> <span class="bp">True</span><span class="p">)</span>
</span><span class="line">            <span class="p">])</span>
</span><span class="line">        <span class="p">),</span> <span class="bp">True</span><span class="p">)</span>
</span><span class="line">    <span class="p">])</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>And this is what I would have to type every time I need a udf to return such record - which can be many times in a single spark job.</p>

<h4 id="dataframe-from-an-rdd---how-it-is">Dataframe from an rdd - how it is</h4>
<p>For these reasons (+ legacy json job outputs from hadoop days) I find myself switching back and forth between dataframes and rdds. Read some JSON dataset into an rdd, transform it, join with another, transform some more, convert into a dataframe and save as parquet. Or read some parquet files into a dataframe, convert to rdd, do stuff to it, convert back to dataframe and save as parquet again. This workflow is not so bad - I get the best of both worlds by using rdds and dataframes only for the things they’re good at. How do you go from a dataframe to an rdd of dictionaries? This part is easy:</p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">rdd</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">asDict</span><span class="p">())</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>It’s the other direction that is problematic. You would think that rdd’s method <code>toDF()</code> would do the job but no, it’s broken.</p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">df</span> <span class="o">=</span> <span class="n">rdd</span><span class="o">.</span><span class="n">toDF</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>actually returns a dataframe with the following schema (<code>df.printSchema()</code>):</p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">root
</span><span class="line"> |-- children: array (nullable = true)
</span><span class="line"> |    |-- element: map (containsNull = true)
</span><span class="line"> |    |    |-- key: string
</span><span class="line"> |    |    |-- value: boolean (valueContainsNull = true)
</span><span class="line"> |-- first_name: string (nullable = true)
</span><span class="line"> |-- last_name: string (nullable = true)
</span><span class="line"> |-- occupation: string (nullable = true)
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>It interpreted the inner dictionary as a <code>map</code> of <code>boolean</code> instead of a <code>struct</code> and <em>silently dropped</em> all the fields in it that are not booleans. But this method is deprecated now anyway. The preferred, official way of creating a dataframe is with an rdd of <code>Row</code> objects. So let’s do that.</p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">Row</span>
</span><span class="line"><span class="n">rdd_of_rows</span> <span class="o">=</span> <span class="n">rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">Row</span><span class="p">(</span><span class="o">**</span><span class="n">x</span><span class="p">))</span>
</span><span class="line"><span class="n">df</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">rdd_of_rows</span><span class="p">)</span>
</span><span class="line"><span class="n">df</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>prints the same schema as the previous method.</p>

<p>In addition to this, both these methods will fail completely when some field’s type cannot be determined because all the values happen to be null in some run of the job.</p>

<p>Also, quite bizarrely in my opinion, order of columns in a dataframe is significant while the order of keys is not. So if you have a pre-existing schema and you try contort an rdd of dicts into that schema, you’re gonna have a bad time.</p>

<h4 id="how-it-should-be">How it should be</h4>
<p>Without further ado, this is how I now create my dataframes:</p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="c"># this is what a typical record in the rdd looks like</span>
</span><span class="line"><span class="n">prototype</span> <span class="o">=</span> <span class="p">{</span>
</span><span class="line">    <span class="s">&#39;first_name&#39;</span><span class="p">:</span> <span class="s">&#39;nadbor&#39;</span><span class="p">,</span>
</span><span class="line">    <span class="s">&#39;last_name&#39;</span><span class="p">:</span> <span class="s">&#39;drozd&#39;</span><span class="p">,</span>
</span><span class="line">    <span class="s">&#39;occupation&#39;</span><span class="p">:</span> <span class="s">&#39;data scientist&#39;</span><span class="p">,</span>
</span><span class="line">    <span class="s">&#39;children&#39;</span><span class="p">:</span> <span class="p">[</span>
</span><span class="line">        <span class="p">{</span>
</span><span class="line">            <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;Lucja&#39;</span><span class="p">,</span>
</span><span class="line">            <span class="s">&#39;age&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
</span><span class="line">            <span class="s">&#39;likes cold showers&#39;</span><span class="p">:</span> <span class="bp">True</span>
</span><span class="line">        <span class="p">}</span>
</span><span class="line">    <span class="p">]</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line"><span class="n">df</span> <span class="o">=</span> <span class="n">df_from_rdd</span><span class="p">(</span><span class="n">rdd</span><span class="p">,</span> <span class="n">prototype</span><span class="p">,</span> <span class="n">sqlContext</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>This doesn’t randomly break, doesn’t drop fields and has the right schema. And I didn’t have to type any of this <code>StructType([StructField(...</code> nonsense, just plain python literal that I got by running</p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">print</span> <span class="n">rdd</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>As an added bonus now this prototype is prominently displayed at the top of my job file and I can tell what the output of the job looks like without having to decode parquet files. Self documenting code FTW!</p>

<h4 id="how-to-get-there">How to get there</h4>
<p>And here’s how it’s done. First we need to implement our own schema inference - the way it should work:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">import</span> <span class="nn">pyspark.sql.types</span> <span class="kn">as</span> <span class="nn">pst</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">Row</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">infer_schema</span><span class="p">(</span><span class="n">rec</span><span class="p">):</span>
</span><span class="line">    <span class="sd">&quot;&quot;&quot;infers dataframe schema for a record. Assumes every dict is a Struct, not a Map&quot;&quot;&quot;</span>
</span><span class="line">    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span class="line">        <span class="k">return</span> <span class="n">pst</span><span class="o">.</span><span class="n">StructType</span><span class="p">([</span><span class="n">pst</span><span class="o">.</span><span class="n">StructField</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">infer_schema</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="bp">True</span><span class="p">)</span>
</span><span class="line">                              <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">items</span><span class="p">())])</span>
</span><span class="line">    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span class="line">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span class="line">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;can&#39;t infer type of an empty list&quot;</span><span class="p">)</span>
</span><span class="line">        <span class="n">elem_type</span> <span class="o">=</span> <span class="n">infer_schema</span><span class="p">(</span><span class="n">rec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span class="line">        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">rec</span><span class="p">:</span>
</span><span class="line">            <span class="n">this_type</span> <span class="o">=</span> <span class="n">infer_schema</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
</span><span class="line">            <span class="k">if</span> <span class="n">elem_type</span> <span class="o">!=</span> <span class="n">this_type</span><span class="p">:</span>
</span><span class="line">                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;can&#39;t infer type of a list with inconsistent elem types&quot;</span><span class="p">)</span>
</span><span class="line">        <span class="k">return</span> <span class="n">pst</span><span class="o">.</span><span class="n">ArrayType</span><span class="p">(</span><span class="n">elem_type</span><span class="p">)</span>
</span><span class="line">    <span class="k">else</span><span class="p">:</span>
</span><span class="line">        <span class="k">return</span> <span class="n">pst</span><span class="o">.</span><span class="n">_infer_type</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Using this we can now specify the schema using a regular python object - no more java-esque abominations. But this is not all. We will also need a function that transforms a python dict into a rRw object with the correct schema. You would think that this should be automatic as long as the dict has all the right fields, but no - order of fields in a Row is significant, so we have to do it ourselves.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">def</span> <span class="nf">_rowify</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">prototype</span><span class="p">):</span>
</span><span class="line">    <span class="sd">&quot;&quot;&quot;creates a Row object conforming to a schema as specified by a dict&quot;&quot;&quot;</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">_equivalent_types</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span><span class="line">        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">]:</span>
</span><span class="line">            <span class="k">return</span> <span class="bp">True</span>
</span><span class="line">        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">y</span><span class="p">))</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</span><span class="line">
</span><span class="line">    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
</span><span class="line">        <span class="k">return</span> <span class="bp">None</span>
</span><span class="line">    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prototype</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span class="line">        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">dict</span><span class="p">:</span>
</span><span class="line">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;expected dict, got </span><span class="si">%s</span><span class="s"> instead&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</span><span class="line">        <span class="n">rowified_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class="line">        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span class="line">            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">prototype</span><span class="p">:</span>
</span><span class="line">                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;got unexpected field </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
</span><span class="line">            <span class="n">rowified_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_rowify</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">prototype</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
</span><span class="line">            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">prototype</span><span class="p">:</span>
</span><span class="line">                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
</span><span class="line">                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span class="line">                        <span class="s">&quot;expected </span><span class="si">%s</span><span class="s"> field but didn&#39;t find it&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
</span><span class="line">        <span class="k">return</span> <span class="n">Row</span><span class="p">(</span><span class="o">**</span><span class="n">rowified_dict</span><span class="p">)</span>
</span><span class="line">    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prototype</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span class="line">        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
</span><span class="line">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;expected list, got </span><span class="si">%s</span><span class="s"> instead&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</span><span class="line">        <span class="k">return</span> <span class="p">[</span><span class="n">_rowify</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">prototype</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
</span><span class="line">    <span class="k">else</span><span class="p">:</span>
</span><span class="line">        <span class="k">if</span> <span class="ow">not</span> <span class="n">_equivalent_types</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">prototype</span><span class="p">):</span>
</span><span class="line">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;expected </span><span class="si">%s</span><span class="s">, got </span><span class="si">%s</span><span class="s"> instead&quot;</span> <span class="o">%</span>
</span><span class="line">                             <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">prototype</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
</span><span class="line">        <span class="k">return</span> <span class="n">x</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>And finally:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">def</span> <span class="nf">df_from_rdd</span><span class="p">(</span><span class="n">rdd</span><span class="p">,</span> <span class="n">prototype</span><span class="p">,</span> <span class="n">sql</span><span class="p">):</span>
</span><span class="line">    <span class="sd">&quot;&quot;&quot;creates a dataframe out of an rdd of dicts, with schema inferred from a prototype record&quot;&quot;&quot;</span>
</span><span class="line">    <span class="n">schema</span> <span class="o">=</span> <span class="n">infer_schema</span><span class="p">(</span><span class="n">prototype</span><span class="p">)</span>
</span><span class="line">    <span class="n">row_rdd</span> <span class="o">=</span> <span class="n">rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">_rowify</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">prototype</span><span class="p">))</span>
</span><span class="line">    <span class="k">return</span> <span class="n">sql</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">row_rdd</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/05/20/text-classification-with-word2vec/">Text Classification With Word2Vec</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-05-20T18:18:58+01:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>20</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>6:18 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In the <a href="http://nadbordrozd.github.io/blog/2015/11/29/ds-toolbox-topic-models/">previous post</a> I talked about usefulness of topic models for non-NLP tasks, it’s back to NLP-land this time. I decided to investigate if word embeddings can help in a classic NLP problem - text categorization. Full code used to generate numbers and plots in this post can be found <a href="https://github.com/nadbordrozd/blog_stuff/blob/master/classification_w2v/benchmarking.ipynb">here</a>.</p>

<h4 id="motivation">Motivation</h4>
<p>The basic idea is that semantic vectors (such as the ones provided by Word2Vec) should preserve most of the relevant information about a text while having relatively low dimensionality which allows better machine learning treatment than straight one-hot encoding of words. Another advantage of topic models is that they are unsupervised so they can help when labaled data is scarce. Say you only have one thousand manually classified blog posts but a million unlabeled ones. A high quality topic model can be trained on the full set of one million. If you can use topic modeling-derived features in your classification, you will be benefitting from your entire collection of texts, not just the labeled ones.</p>

<h4 id="getting-the-embedding">Getting the embedding</h4>
<p>Ok, word embeddings are awesome, how do we use them? Before we do anything we need to get the vectors. We can download one of the great pre-trained models from <a href="http://nlp.stanford.edu/projects/glove/">GloVe</a>:</p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">wget http://nlp.stanford.edu/data/glove.6B.zip
</span><span class="line">unzip glove.6B.zip
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>and use load them up in python:</p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
</span><span class="line">
</span><span class="line"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;glove.6B.50d.txt&quot;</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">lines</span><span class="p">:</span>
</span><span class="line">    <span class="n">w2v</span> <span class="o">=</span> <span class="p">{</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]))</span>
</span><span class="line">           <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>or we can train a Word2Vec model from scratch with gensim:</p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">import</span> <span class="nn">gensim</span>
</span><span class="line"><span class="c"># let X be a list of tokenized texts (i.e. list of lists of tokens)</span>
</span><span class="line"><span class="n">model</span> <span class="o">=</span> <span class="n">gensim</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Word2Vec</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</span><span class="line"><span class="n">w2v</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">index2word</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">syn0</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h4 id="the-python-meat">The (python) meat</h4>
<p>We got ourselves a dictionary mapping word -&gt; 100-dimensional vector. Now we can use it to build features. The simplest way to do that is by averaging word vectors for all words in a text. We will build a sklearn-compatible transformer that is initialised with a word -&gt; vector dictionary.</p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">class</span> <span class="nc">MeanEmbeddingVectorizer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">word2vec</span><span class="p">):</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">word2vec</span> <span class="o">=</span> <span class="n">word2vec</span>
</span><span class="line">        <span class="c"># if a text is empty we should return a vector of zeros</span>
</span><span class="line">        <span class="c"># with the same dimensionality as all the other vectors</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">word2vec</span><span class="o">.</span><span class="n">itervalues</span><span class="p">()</span><span class="o">.</span><span class="n">next</span><span class="p">())</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span><span class="line">        <span class="k">return</span> <span class="bp">self</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
</span><span class="line">        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
</span><span class="line">            <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">word2vec</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">words</span> <span class="k">if</span> <span class="n">w</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">word2vec</span><span class="p">]</span>
</span><span class="line">                    <span class="ow">or</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span class="line">            <span class="k">for</span> <span class="n">words</span> <span class="ow">in</span> <span class="n">X</span>
</span><span class="line">        <span class="p">])</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Let’s throw in a version that uses tf-idf weighting scheme for good measure</p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">class</span> <span class="nc">TfidfEmbeddingVectorizer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">word2vec</span><span class="p">):</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">word2vec</span> <span class="o">=</span> <span class="n">word2vec</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">word2weight</span> <span class="o">=</span> <span class="bp">None</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">word2vec</span><span class="o">.</span><span class="n">itervalues</span><span class="p">()</span><span class="o">.</span><span class="n">next</span><span class="p">())</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span><span class="line">        <span class="n">tfidf</span> <span class="o">=</span> <span class="n">TfidfVectorizer</span><span class="p">(</span><span class="n">analyzer</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">)</span>
</span><span class="line">        <span class="n">tfidf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span><span class="line">        <span class="c"># if a word was never seen - it must be at least as infrequent</span>
</span><span class="line">        <span class="c"># as any of the known words - so the default idf is the max of </span>
</span><span class="line">        <span class="c"># known idf&#39;s</span>
</span><span class="line">        <span class="n">max_idf</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">tfidf</span><span class="o">.</span><span class="n">idf_</span><span class="p">)</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">word2weight</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span>
</span><span class="line">            <span class="k">lambda</span><span class="p">:</span> <span class="n">max_idf</span><span class="p">,</span>
</span><span class="line">            <span class="p">[(</span><span class="n">w</span><span class="p">,</span> <span class="n">tfidf</span><span class="o">.</span><span class="n">idf_</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tfidf</span><span class="o">.</span><span class="n">vocabulary_</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
</span><span class="line">
</span><span class="line">        <span class="k">return</span> <span class="bp">self</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
</span><span class="line">        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
</span><span class="line">                <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">word2vec</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">word2weight</span><span class="p">[</span><span class="n">w</span><span class="p">]</span>
</span><span class="line">                         <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">words</span> <span class="k">if</span> <span class="n">w</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">word2vec</span><span class="p">]</span> <span class="ow">or</span>
</span><span class="line">                        <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span class="line">                <span class="k">for</span> <span class="n">words</span> <span class="ow">in</span> <span class="n">X</span>
</span><span class="line">            <span class="p">])</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>These vectorizers can now be used <em>almost</em> the same way as <code>CountVectorizer</code> or <code>TfidfVectorizer</code> from <code>sklearn.feature_extraction.text</code>. Almost - because sklearn vectorizers can also do their own tokenization - a feature which we won’t be using anyway because the benchmarks we will be using come already tokenized. In a real application I wouldn’t trust sklearn with tokenization anyway - rather let spaCy do it.</p>

<p>Now we are ready to define the actual models that will take tokenised text, vectorize and learn to classify the vectors with something fancy like Extra Trees. sklearn’s Pipeline is perfect for this:</p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">ExtraTreesClassifier</span>
</span><span class="line">
</span><span class="line"><span class="n">etree_w2v</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
</span><span class="line">    <span class="p">(</span><span class="s">&quot;word2vec vectorizer&quot;</span><span class="p">,</span> <span class="n">MeanEmbeddingVectorizer</span><span class="p">(</span><span class="n">w2v</span><span class="p">)),</span>
</span><span class="line">    <span class="p">(</span><span class="s">&quot;extra trees&quot;</span><span class="p">,</span> <span class="n">ExtraTreesClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">200</span><span class="p">))])</span>
</span><span class="line"><span class="n">etree_w2v_tfidf</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
</span><span class="line">    <span class="p">(</span><span class="s">&quot;word2vec vectorizer&quot;</span><span class="p">,</span> <span class="n">TfidfEmbeddingVectorizer</span><span class="p">(</span><span class="n">w2v</span><span class="p">)),</span>
</span><span class="line">    <span class="p">(</span><span class="s">&quot;extra trees&quot;</span><span class="p">,</span> <span class="n">ExtraTreesClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">200</span><span class="p">))])</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h4 id="benchmarks">Benchmarks</h4>
<p>I benchmarked the models on everyone’s favorite <a href="http://www.cs.umb.edu/~smimarog/textmining/datasets/">Reuters-21578</a> datasets. Extra Trees-based word-embedding-utilising models competed against text classification classics - Naive Bayes and SVM. Full list of contestants:</p>

<ul>
  <li>mult_nb - Multinomial Naive Bayes</li>
  <li>bern_nb - Bernoulli Naive Bayes</li>
  <li>svc - linear kernel SVM</li>
  <li>glove_small - ExtraTrees with 200 trees and vectorizer based on 50-dimensional gloVe embedding trained on 6B tokens</li>
  <li>glove_big - same as above but using 300-dimensional gloVe embedding trained on 840B tokens</li>
  <li>w2v - same but with using 100-dimensional word2vec embedding trained on the benchmark data itself (using both training and test examples [but not labels!])</li>
</ul>

<p>Each of these came in two varieties - regular and tf-idf weighted.</p>

<p>The results (on 5-fold cv on a the R8 dataset of 7674 texts labeled with 8 categories):</p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">model                score
</span><span class="line">-----------------  -------
</span><span class="line">svc_tfidf           0.9656
</span><span class="line">svc                 0.9562
</span><span class="line">w2v_tfidf           0.9554
</span><span class="line">w2v                 0.9516
</span><span class="line">mult_nb             0.9467
</span><span class="line">glove_big           0.9279
</span><span class="line">glove_big_tfidf     0.9273
</span><span class="line">glove_small         0.9250
</span><span class="line">glove_small_tfidf   0.9061
</span><span class="line">mult_nb_tfidf       0.8615
</span><span class="line">bern_nb             0.7954
</span><span class="line">bern_nb_tfidf       0.7954
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>SVM wins, word2vec-based Extra Trees is a close second, Naive Bayes not far behind. Interestingly, embedding trained on this relatively tiny dataset does significantly better than pretrained GloVe - which is otherwise fantastic. Can we do better? Let’s check how do the models compare depending on the number of labeled training examples. Due to its semi-supervised nature w2v should shine when there is little labeled data.</p>

<p><img src="/images/text_class_with_w2v/r8.png" /></p>

<p>That indeed seems to be the case. <code>w2v_tfidf</code>’s performance degrades most gracefully of the bunch. <code>SVM</code> takes the biggest hit when examples are few. Lets try the other two benchmarks from Reuters-21578. 52-way classification:</p>

<p><img src="/images/text_class_with_w2v/r52.png" /></p>

<p>Qualitatively similar results.</p>

<p>And 20-way classification:</p>

<p><img src="/images/text_class_with_w2v/20ng.png" /></p>

<p>This time pretrained embeddings do better than Word2Vec and Naive Bayes does really well, otherwise same as before.</p>

<h4 id="conclusions">Conclusions</h4>
<ol>
  <li>SVM’s are pretty great at text classification tasks</li>
  <li>Models based on simple averaging of word-vectors can be surprisingly good too (given how much information is lost in taking the average)</li>
  <li>but they only seem to have a clear advantage when there is ridiculously little labeled training data</li>
</ol>

<p>At this point I have to note that averaging vectors is only the easiest way of leveraging word embeddings in classification but not the only one. You could also try embedding whole documents directly with <a href="https://radimrehurek.com/gensim/models/doc2vec.html">Doc2Vec</a>. Or use Multinomial Gaussian Naive Bayes on word vectors. I have tried the <a href="https://github.com/nadbordrozd/blog_stuff/blob/master/classification_w2v/multi_multi_kernel_nb.py">latter approach</a> but it was too slow to include in the benchmark.</p>

<ol>
  <li>Sometimes pretrained embeddings give clearly superior results to word2vec trained on the specific benchmark, sometimes it’s the opposite. Not sure what is going on here.</li>
</ol>

<p>Overall, we won’t be throwing away our SVMs any time soon in favor of word2vec but it has it’s place in text classification. Like when you have a tiny training set or to ensemble it with other models to gain edge in Kaggle.</p>

<p>Plus, can SVM do this:</p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">X</span> <span class="o">=</span> <span class="p">[[</span><span class="s">&#39;Berlin&#39;</span><span class="p">,</span> <span class="s">&#39;London&#39;</span><span class="p">],</span>
</span><span class="line">     <span class="p">[</span><span class="s">&#39;cow&#39;</span><span class="p">,</span> <span class="s">&#39;cat&#39;</span><span class="p">],</span>
</span><span class="line">     <span class="p">[</span><span class="s">&#39;pink&#39;</span><span class="p">,</span> <span class="s">&#39;yellow&#39;</span><span class="p">]]</span>
</span><span class="line"><span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;capitals&#39;</span><span class="p">,</span> <span class="s">&#39;animals&#39;</span><span class="p">,</span> <span class="s">&#39;colors&#39;</span><span class="p">]</span>
</span><span class="line"><span class="n">etree_glove_big</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="c"># never before seen words!!!</span>
</span><span class="line"><span class="n">test_X</span> <span class="o">=</span> <span class="p">[[</span><span class="s">&#39;dog&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s">&#39;red&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s">&#39;Madrid&#39;</span><span class="p">]]</span>
</span><span class="line">
</span><span class="line"><span class="k">print</span> <span class="n">etree_glove_big</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_X</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>prints</p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">[&#39;animals&#39; &#39;colors&#39; &#39;capitals&#39;]
</span></code></pre></td></tr></table></div></figure></notextile></div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/11/29/ds-toolbox-topic-models/">DS Toolbox - Topic Models</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-11-29T14:59:33+00:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>29</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>2:59 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>If you’re not primarily working with NLP you may not have been paying attention to topic modeling and word embeddings. In this post I intend to convince you that you should.</p>

<h3 id="topic-models">Topic models</h3>
<p>Topic models are a set of models in NLP that discover common themes in a collection of documents. You give it a list of texts and it comes up with a bunch of topics and maps every document to a topic or a mixture of topics. <a href="http://www.princeton.edu/~achaney/tmve/wiki100k/browse/topic-presence.html">Here</a> you can see a visualization of a topic model applied to wikipedia articles. As you can see, it picks up similar kinds of themes in the texts that a human being would notice. Take topic 5 for instance. Its top relevant words are “war”, “force”, “army”, “attack”, “military” and top articles: “Second Boer War”, “Erwin Rommel”, “Axis powers”, “Vietnam war”. Pretty neat. Most topic models (like the most popular <a href="https://en.wikipedia.org/wiki/Latent_Dirichlet_allocation">LDA</a> produce a vector of numbers for every text - the distribution of topics and a similar vector for every word - the affinity of the word to every topic.</p>

<h3 id="word-and-document-embeddings">Word (and document) embeddings</h3>
<p>Word embeddings are related to topic models but instead of mapping a text to a mixture of topics they learn to map words to real valued fixed-size vectors. The mapping is designed to preserve the semantic structure so that the distance between vectors corresponds to distance in meaning of words. An additional property of these embeddings (probably unintended) is that you can do a sort of algebra on words - like this:</p>

<script type="math/tex; mode=display">vector("Paris") - vector("France") + vector("Italy") \approx vector("Rome")</script>

<p>- an examples taken from the most famous word embedding algorithm  -<a href="https://code.google.com/p/word2vec/">word2vec</a>. How cool is that?
 If you want to play with the vectors yourself and discover new fun analogies ($Bush - Iraq + Vietnam \approx Nixon$ !!!) you can download pretrained vectors from word2vec or <a href="http://nlp.stanford.edu/projects/glove/">GloVe</a>.</p>

<h3 id="why-you-should-care">Why you should care</h3>
<p>Unsupervised algorithms learning about analogies between real-world entities is pretty cool but it obscures the wider applicability of these algorithms. The topic modeling and embedding algorithms were invented in the context of NLP but most of them (including LDA and wor2vec) don’t have any inherent knowledge about natural languages and can be applied just as well to sequences of items from a discrete set of any kind. This is huge. Sequences (or sets) of items are notoriously hard to work with. Most popular ML algorithms expect fixed-size vectors as inputs. If your inputs are sequences you can either:</p>

<ul>
  <li>do one-hot encoding and then use any old ML algo you want (like a random forest). Unfortunately one-hot discards all information about the order of items. More importantly, as the size of the vocabulary grows beyond thousands (which is still tiny as far as vocabularies go) your random forest will take forever to train and overfit.</li>
  <li>use naive bayes. NB works surprisingly well but only for classification and only when the problem is - well, naive. It also utilizes the item order information to a very limited extent via n-grams.</li>
  <li>use a <a href="http://karpathy.github.io/2015/05/21/rnn-effectiveness/">recurrent neural network</a> This can actually be very effective in some cases but I don’t think it would work well with a vocabulary size in the thousands. Even the character-level language models take days to train properly on a GPU (but what incredible results it produces!). I believe NNs of all kinds will get better and easier to use but as of now this is not a practical solution to our problem at all.</li>
</ul>

<p>This is where word embeddings come in. Just run word2vec on your sequences of items and you’ll get a reasonably-dimensional representation of every item. You can then take the mean of all vectors in a sequence to get a representation of sequences. Or run <a href="https://cs.stanford.edu/~quocle/paragraph_vector.pdf">doc2vec</a> and you’ll get a vector for each sequence directly. Or if you need them clustered - run LDA. LDA’s word-topic coefficients can also be used as word embedding but they don’t do nearly as good of a job at it as word2vec. Same goes for LDA’s text-topic coefficients as a document to vector mapping.</p>

<p>This is it. This is what topic modeling buys you. It’s a generic clustering and feature extraction technique that works on sequences (or sets) of items from a discrete vocabulary. Does it actually work in practice? I don’t know of a lot of examples of people using it but I know a few.</p>

<h4 id="page-jumps">Page jumps</h4>
<p>As I have already described in my <a href="http://nadbordrozd.github.io/interviews/">mini-guide to data science interviews</a> (question “Predicting page jumps”) it can be used to model users jumping between pages of a web application. Here a page plays the role of a word and a user journey is a sentence. You can (and from what I understood from the interview - they [the company I interviewed with] do) use topic modeling to segment users based on their journeys and extract features for them to predict page jumps.</p>

<h4 id="ad-clicks">Ad clicks</h4>
<p>In a similar vein, topic modeling <a href="http://www.cs.kumamoto-u.ac.jp/~yasuko/PUBLICATIONS/kdd12-trimine.pdf">has been used</a> as a feature extraction technique in the prediction of ad clicks. The paper concentrates on the authors’ special brand of topic modeling but the idea is simple and can be used with any topic model for example LDA. They treat hosts (the websites with banners on them) as words and users who visit the websites as documents. Let’s say John visits youtube then google then wikipedia then youtube again then tmz then guardian. This gives us a sequence [“youtube”, “google”, “wikipedia”, “youtube”, “tmz”, “guardian”]. Topic modeling is applied to the set of all users and the result is a set of topics (“media”, “business” and “drive” in the paper) and a decomposition of every user into those topics. So for our John we should expect something like <code>{media: 0.8, business: 0.2, drive: 0}</code>. This is interesting in itself and constitutes a great feature vector that you can feed into a regression predicting clicks - which is exactly what the authors did.</p>

<h4 id="deepwalk">DeepWalk</h4>
<p>Feature extraction from graphs is even harder than for sequences. Say you want to classify youtube videos. You have a labeled training set and a set of features for every video. But you also know that some videos link to other videos - forming a graph. Information about the position of the video in this graph is bound to be useful for classifiaction (think “oh, I’m in that weird part of youtube again”) but how do you use it. Authors of the <a href="http://arxiv.org/abs/1403.6652">DeepWalk</a> paper compared several approaches and the best turned out to be a trick involving word2vec that they invented. This time the role of a word is played by a node in the graph (a youtube video). What plays the role of a sentence? For that a collection of short random walks on the graph is constructed - starting at every node of the graph. Think about what happens when a youtube video ends and another one starts playing, and then another one and another. Do this a few times for every video on youtube and you have a corpus of texts. Authors of the paper applied word2vec to those sequences to get vector embeddings for videos and then used these vectors as features in classification. It worked better then all other approaches - even ones that use global features of the graph. Awesome.</p>

<p><em>Update July 2016</em> <br />
I have tried this very algorithm on the graph of UK and Irish companies, <a href="http://nadbordrozd.github.io/blog/2016/06/13/deepwalking-with-companies/">here are the results</a></p>

<h4 id="frequent-itemsets--collaborative-filtering">Frequent itemsets / collaborative filtering</h4>
<p>Association rule learning is a popular task in the context of retail. If a customer bought butter and bread, what other item are they likely to buy? The usual approach is to count instances of people buying {bread, butter, X} and divide that number by the count of people buying {bread, butter} - this estimates the probability of buying X. Then you can find the X that maximizes the probability and do something with it (suggest it to the user as they are about to checkout perhaps). This is a bit crude, not very robust and it doesn’t provide any insight, just the prediction. What you can do instead is to run (you guessed it) topic modeling with items playing the role of words and baskets playing the role of sentences. Word2vec will give you vector representations of both items and baskets which will allow you to use more sophisticated algorithms for predicting the next item. You will also get a segmentation of all users and all items for free. To understand why this is superior consider this: topic modeling will easily pick up on the cluster of vegetarian buyers and then the model will know not to recommend the buyer pork chops even if they bought three other items that usually go with bacon - this is something frequent itemset algorithms are incapable of. When a new type of soy-based pork substitute appears on the shelves, the algorithm will also take much less time to figure out that it belongs to the vegetarian cluster and is analogous to meat. I don’t actually know if anyone in retail is doing topic modeling on baskets but if they don’t, they should. I’ll do it myself if I can find a free dataset with retail baskets.</p>

<p><em>Update July 2016</em> <br />
Called it. People are totally doing that now <a href="http://arxiv.org/abs/1603.04259">here</a> and <a href="https://arxiv.org/abs/1601.01356">here</a>. I don’t know why in the above text I fixated on frequent itemsets - which is just a specific, outdated way of doing collaborative filtering.</p>

<p>If you know of any other cool applications of topic modeling to non-NLP problems let me know.</p>

<p>If you want to play with topic models yourself I wholehartedly recommend <a href="https://radimrehurek.com/gensim/">gensim</a>. I tried also MLLib but its word2vec implementation required 3 times as much RAM (for each of 10 cores I used) and still was about ten times slower than gensim.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/08/01/forgetting-salesman-problem-or-classification-without-negative-examples/">Lead Scoring Without Negative Examples</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-08-01T20:49:26+01:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>1</span><span class='date-suffix'>st</span>, <span class='date-year'>2015</span></span> <span class='time'>8:49 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>How do you train a binary classifier when you have only positive-labeled training examples? 
Impossible? Maybe. But sometimes you can do something just as good. Let’s start from the beginning…</p>

<h3 id="lead-generation">Lead generation</h3>
<p>Everyone and their mum in the b2b sector is trying to use machine learning 
for lead generation. For our purposes lead-gen means selecting from the millions of active companies in your country the ones that are most likely to buy your product once contacted by your sales team. Needless to say lead generation is extremely <em>serious business</em> and constitutes a market sector in its own right - a type of b2b2b if you will.</p>

<p>One popular lead-gen strategy is to look for leads among companies similar the ones that have worked out for you in the past. A machine learning implementation of this strategy is straightforward:</p>

<ol>
  <li>collect data on all relevant companies</li>
  <li>take all the companies your sales have contacted in the past and label every one as either successful (you made money) or failed (you wasted your time) lead. This is your training set.</li>
  <li>extract good features for every company*</li>
  <li>train a binary classifier (predicting successful/failed label) on your training set. Ideally this should be a classifier that outputs probabilities.</li>
  <li>apply the classifier to all the companies outside the training set and hand the results over to sales.
The number assigned by the classifier to a given company is (in theory at least) the probability that the lead will be successful. Highest scorers should be prioritized, low scorers should be left alone. So far, so good.</li>
</ol>

<h3 id="forgetting-salesman-problem">Forgetting salesman problem</h3>
<p>An interesting difficulty frequently arises when you try to apply this approach in real life. Sales teams usually have good records on their clients but often fail to keep track of all the prospects that didn’t work out. As a result, you end up with only positive examples to train your classifier on. It’s not possible in general to train a classifier on a training set with one class amputated this way. But…</p>

<h3 id="the-solution">The solution</h3>
<p>TL;DR = divide density of “good points” by density of all - this is the lead score</p>

<p>Keep in mind that:</p>

<ul>
  <li>in addition to the positive examples, you have also the full set of all data points (all companies whether previously contacted or not)</li>
  <li>you are not interested in the absolute probability of success of a given lead per se. You only really need the relative ranking of different leads. All the classifier scores may be off by a factor of 10 but as long as the order is preserved - you’ll still be able to prioritize good leads over rubbish ones.</li>
</ul>

<p>A solution will present itself once the problem is stated in mathematical terms. Consider the space of all possible company features $X$. Given are:</p>

<ul>
  <li>a set $C$ of points in $X$ - all companies</li>
  <li>
    <p>a subset $T_+$ of the above set - companies that were tested and gave positive result
Unknown are:</p>
  </li>
  <li>the probability $f(x)$ that a company $x$ will test positive</li>
  <li>the subset $T$ of all tested companies</li>
</ul>

<p>This is how it looks in an artificial 1-D dataset.
<img src="/images/leadgen1.png" /></p>

<p>Notice that the distribution of companies $C$ and the conversion probability $f$ peak at different points and the distribution of positive exmaples $T_+$ peaks somewhere between those two.</p>

<p>It’s useful to think of $C$ as a sample from some probabilty distribution $P(x)$ defined on $X$. Or to express the same in the language of point densities in space:</p>

<script type="math/tex; mode=display">density\_of\_C(x) = const_1 P(x)</script>

<p>If the companies tested $T$ were chosen at random from all companies $C$ then they constitute a sample from the same probability distribution $P(x)$</p>

<script type="math/tex; mode=display">density\_of\_T(x) = const_2 P(x)</script>

<p>Since a company’s chance of testing positive is $f$, the density of companies that tested positive is simply:</p>

<script type="math/tex; mode=display">density\_of\_T_+(x) = density\_of\_T(x) f(x) = const_2 P(x) f(x)</script>

<p>The set $T$ is hidden from us but $C$ and $T_+$ are available so we can use them to find $f(x)$. Combining the first and third equation we get:</p>

<script type="math/tex; mode=display">\frac{const_2}{const_1} f(x) = \frac{density\_of\_T_+(x)}{density\_of\_C(x)}</script>

<p>This is it. If we can just estimate the densities of $C$ and $T_+$ - we’re golden. Their ratio gives the $f$ function up to a constant, which is all we need to do lead scoring. There are many ways to do density estimation in practice:</p>

<ul>
  <li>histogram based estimation - lowest on the sophistication scale - divide the space $X$ into sectors and count the number of points in every sector, divide it by volume. Do it for both $C$ and $T_+$ and divide one result by the other</li>
  <li>nearest neighbour estimation - for any interesting point find $k$ (let’s say $k=20$) nearest points in $C$. Count how many of them are also in $T_+$, divide the figures</li>
  <li>kernel based estimation - in a way this is similar to the knn version - except instead of taking k nearest points you take all of them but discount the farthest by a dicreasing function of distance</li>
</ul>

<p>This is how it looks on our toy dataset:
<img src="/images/leadgen2.png" /></p>

<p>Unsuprisingly, on a toy model everything works rather well. In reality conversion rates are low, data is sparse, dimensionality is high and even the basic assumption “good lead means similar to what has worked in the past” is questionable. But you have to start somewhere.</p>

<p>For more information about the ML aspect of classification without negatives google the term “PU learning”.</p>

<p>* this is arguably the hardest and most important step, but I’m glossing over it as it’s not relevant to this 
  post</p>

<p>** if there is prior knowledge regarding how the contacted companies were chosen, it can be easily incorporated</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/2">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/09/17/text-generation-with-keras-char-rnns/">Text Generation With Keras char-RNNs</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/07/29/datamatching-part-3-match-scoring/">Datamatching Part 3: Match Scoring</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/07/22/datamatching-part-2-spark-pipeline/">Datamatching Part 2: Spark Pipeline</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/07/20/datamatching-part-1/">Datamatching Part 1: Algorithm</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/06/15/dear-recruiter/">Dear Recruiter</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/nadbordrozd">@nadbordrozd</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'nadbordrozd',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/nadbordrozd?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - nadbor -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'ds-lore';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>

<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  jax: ["input/TeX", "output/HTML-CSS"],
  tex2jax: {
    inlineMath: [ ['$', '$'] ],
    displayMath: [ ['$$', '$$']],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  messageStyle: "none",
  "HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"] }
});
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML" type="text/javascript"></script>

</html>
