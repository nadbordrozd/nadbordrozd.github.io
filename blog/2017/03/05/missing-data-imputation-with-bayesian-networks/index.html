
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Missing Data Imputation With Bayesian Networks in Pymc - DS lore</title>
  <meta name="author" content="nadbor">

  
  <meta name="description" content="Missing Data Imputation With Bayesian Networks in Pymc Mar 5th, 2017 3:15 pm This is the first of two posts about Bayesian networks, pymc and &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://nadbordrozd.github.io/blog/2017/03/05/missing-data-imputation-with-bayesian-networks/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="DS lore" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-65624880-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">DS lore</a></h1>
  
    <h2>words about stuff</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="nadbordrozd.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/interviews">Interviews</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Missing Data Imputation With Bayesian Networks in Pymc</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-03-05T15:15:17+00:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>5</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>3:15 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>This is the first of two posts about Bayesian networks, pymc and missing data. In the first post I will show how to do Bayesian networks in pymc* and how to use them to impute missing data. This part is boring and slightly horrible. In the second post I investigate how well it actually works in practice (not very well) and how it compares to a more traditional machine learning approach (poorly). <strong>Feel free to go straight to the <a href="http://nadbordrozd.github.io/blog/2017/03/23/missing-data-imputation-with-pymc-part-2/">second post</a>, it has plots in it</strong>.</p>

<p>This post assumes that the reader is already familiar with both bayesianism and pymc. If you aren’t, I recommend that you check out the fantastic <a href="https://github.com/CamDavidsonPilon/Probabilistic-Programming-and-Bayesian-Methods-for-Hackers">Bayesian Methods For Hackers</a>.</p>

<p>* technically, everything in pymc is a Bayesian network, I know</p>

<h3 id="the-problem">The problem</h3>
<p>We have observed 10 animals and noted 3 things about each of them:
- does it swim like a duck?
- does it quack like a duck?
- is it, in fact, a duck?</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
</span><span class="line">
</span><span class="line"><span class="c"># we use 1 and 0 to represent True and False for reasons that will become clear later</span>
</span><span class="line"><span class="n">full</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
</span><span class="line">    <span class="s">&#39;swims_like_a_duck&#39;</span><span class="p">:</span>  <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span class="line">    <span class="s">&#39;quacks_like_a_duck&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span class="line">    <span class="s">&#39;duck&#39;</span><span class="p">:</span>               <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</span><span class="line"><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>It is easy to notice that in this dataset an animal is a duck if and only if it both swims like a duck <strong>and</strong> quacks like a duck. So far so good.</p>

<p>But what if someone forgets to write down whether the duck number 10 did any quacking or whether the animal number 9 was a duck at all? Now we have missing data. Here denoted by <code>-1</code></p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">with_missing</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
</span><span class="line">    <span class="s">&#39;swims_like_a_duck&#39;</span><span class="p">:</span>  <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
</span><span class="line">    <span class="s">&#39;quacks_like_a_duck&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
</span><span class="line">    <span class="s">&#39;duck&#39;</span><span class="p">:</span>               <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">1</span><span class="p">]</span>
</span><span class="line"><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>This tells us about the last animal that it is a duck, but the information about swimming and quacking is missing. Nevertheless, having established the rule</p>

<script type="math/tex; mode=display">(swims \: like \: duck) \land (quacks \: like \:  duck) \Leftrightarrow (is \: duck)</script>

<p>we can infer that the values of <code>swims_like_a_duck</code> and <code>quacks_like_a_duck</code> must both be <code>1</code> for this animal.</p>

<p>This is what we will try to do here - learn the relationship between the variables and use it to fill in the missing ones.</p>

<h3 id="the-bayesian-solution">The Bayesian solution</h3>
<p>To be able to attack this problem, let’s make one simplifying assumption. Let’s assume that we know the causal structure of the problem upfront. That is - we know that swimming and quacking are independent random variables, while being a duck is a random variable that potentially depends on the other two.</p>

<p>This is the situation described by this Bayesian network:</p>

<p><img src="/images/bayesian_networks/ducknet1.png" /></p>

<p>This network is fully characterised by 6 parameters - prior probabilities of swimming and quacking -<br />
$P(swims)$, $P(quacks)$<br />
- and conditional probability of being a duck given values of the other 2 variables -<br />
$P(duck \mid swims \land quacks)$,<br />
$P(duck \mid \neg swims \land quacks)$<br />
- and so on. We don’t know anything about the values of these parameters, other than they must be between $0$ and $1$. The bayesian thing to do in such situations is to model the unknown parameters as random variables of their own and give them uniform priors.</p>

<p>Thus, the network expands:</p>

<p><img src="/images/bayesian_networks/ducknet3.png" /></p>

<p>This is the network describing a single animal, but actually we have observations of many animals, so the full network would look more like this:</p>

<p><img src="/images/bayesian_networks/ducknet4.png" /></p>

<p>There is only one node corresponding to each of the 6 parameters, but there are as many ‘swims’ and ‘quacks’ and ‘duck’ nodes as there are records in the dataset.</p>

<p>Some of the variables are observed (orange), others aren’t (white), but we have specified priors for all the parent variables and the model is fully defined. This is enough to (via    Bayes theorem) derive the formula for the posterior probability of every unobserved variable and the posterior distribution of every model parameter.</p>

<p>But instead of doing math, we will find a way to programmatically estimate all those probabilities with pymc. This way, we will have a solution that can be easily extended to arbitrarily complicated networks.</p>

<p>What could go wrong?</p>

<h3 id="pymc-implementation">pymc implementation</h3>

<p><strong>Disclaimer: this is all hacky and inefficient in ways I didn’t realise it would be when I started working on it. pymc is not the right tool for the job, if you want to do this seriously, in a production environment you should look for something else. pymc3 maybe?</strong></p>

<p>I will now demonstrate how to represent our quack-swim-duck Bayesian network in pymc and how to make predictions with it. pymc was confusing the hell out of me when I first started this project. I will be painstakingly explicit at every step of this tutorial to save the reader some of this confusion. Then at the end I will show how to achieve the same result with 1/10th as many lines of code using some utilities of my invention.</p>

<p>Let’s start with the unobserved variables:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">import</span> <span class="nn">pymc</span>
</span><span class="line"><span class="c"># prior probabilities for swimming and quacking</span>
</span><span class="line"><span class="n">swim_prior</span> <span class="o">=</span> <span class="n">pymc</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="s">&#39;P(swims)&#39;</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span class="line"><span class="n">quack_prior</span> <span class="o">=</span> <span class="n">pymc</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="s">&#39;P(quacks)&#39;</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="c"># probability of being a duck conditional on swimming and quacking</span>
</span><span class="line"><span class="c"># (or not swimming and quacking etc.)</span>
</span><span class="line"><span class="n">p_duck_swim_quack</span> <span class="o">=</span> <span class="n">pymc</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="s">&#39;P(duck | swims &amp; quacks)&#39;</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span class="line"><span class="n">p_duck_not_swim_not_quack</span> <span class="o">=</span> <span class="n">pymc</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="s">&#39;P(duck | not swims &amp; not quacks)&#39;</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span class="line"><span class="n">p_duck_not_swim_quack</span> <span class="o">=</span> <span class="n">pymc</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="s">&#39;P(duck | not swims &amp; quacks)&#39;</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span class="line"><span class="n">p_duck_swim_not_quack</span> <span class="o">=</span> <span class="n">pymc</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="s">&#39;P(duck | swims &amp; not quacks)&#39;</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Now the observed variables. pymc requires that we use masked arrays to represent missing values:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
</span><span class="line"><span class="n">swim_data</span> <span class="o">=</span> <span class="n">with_missing</span><span class="o">.</span><span class="n">swims_like_a_duck</span>
</span><span class="line"><span class="n">masked_swim_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">swim_data</span><span class="p">,</span> <span class="n">swim_data</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="n">quack_data</span> <span class="o">=</span> <span class="n">with_missing</span><span class="o">.</span><span class="n">quacks_like_a_duck</span>
</span><span class="line"><span class="n">masked_quack_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">quack_data</span><span class="p">,</span> <span class="n">quack_data</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="n">duck_data</span> <span class="o">=</span> <span class="n">with_missing</span><span class="o">.</span><span class="n">duck</span>
</span><span class="line"><span class="n">masked_duck_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">duck_data</span><span class="p">,</span> <span class="n">duck_data</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>This is what a masked array with two missing values looks like:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">masked_quack_data</span>
</span><span class="line"><span class="n">masked_array</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="mi">1</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">0</span> <span class="mi">1</span> <span class="o">--</span> <span class="o">--</span><span class="p">],</span>
</span><span class="line">             <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="bp">False</span> <span class="bp">False</span> <span class="bp">False</span> <span class="bp">False</span> <span class="bp">False</span> <span class="bp">False</span> <span class="bp">False</span> <span class="bp">False</span>  <span class="bp">True</span>  <span class="bp">True</span><span class="p">],</span>
</span><span class="line">       <span class="n">fill_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Quacking and swimming nodes:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="c"># number of animal observations</span>
</span><span class="line"><span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">with_missing</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="c"># with &#39;size=n&#39; with tell pymc that &#39;swims&#39; is actually a sequence of n Bernoulli variables</span>
</span><span class="line"><span class="n">swims</span> <span class="o">=</span> <span class="n">pymc</span><span class="o">.</span><span class="n">Bernoulli</span><span class="p">(</span><span class="s">&#39;swims&#39;</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">swim_prior</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">masked_swim_data</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
</span><span class="line"><span class="n">quacks</span> <span class="o">=</span> <span class="n">pymc</span><span class="o">.</span><span class="n">Bernoulli</span><span class="p">(</span><span class="s">&#39;quacks&#39;</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">quack_prior</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">masked_quack_data</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>And now the hard part. We have to construct a Bernoulli random variable ‘duck’, whose conditional probability given its parents is equal to a different random variable for very combination of values of the parents. That was a mouthful, but all it means is that there is a conditional probability table of ‘duck’ conditioned on ‘swims’ and ‘quacks’. This is literally the first example in every textbook on probabilistic models. And yet, there is no easy way to express this relationship with pymc. We are forced to roll our own custom function.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="c"># auxiliary pymc variable - probability of duck</span>
</span><span class="line"><span class="nd">@pymc.deterministic</span>
</span><span class="line"><span class="k">def</span> <span class="nf">duck_probability</span><span class="p">(</span>
</span><span class="line">        <span class="n">swims</span><span class="o">=</span><span class="n">swims</span><span class="p">,</span>
</span><span class="line">        <span class="n">quacks</span><span class="o">=</span><span class="n">quacks</span><span class="p">,</span>
</span><span class="line">        <span class="n">p_duck_swim_quack</span><span class="o">=</span><span class="n">p_duck_swim_quack</span><span class="p">,</span>
</span><span class="line">        <span class="n">p_duck_not_swim_quack</span><span class="o">=</span><span class="n">p_duck_not_swim_quack</span><span class="p">,</span>
</span><span class="line">        <span class="n">p_duck_swim_not_quack</span><span class="o">=</span><span class="n">p_duck_swim_not_quack</span><span class="p">,</span>
</span><span class="line">        <span class="n">p_duck_not_swim_not_quack</span><span class="o">=</span><span class="n">p_duck_not_swim_not_quack</span><span class="p">):</span>
</span><span class="line">
</span><span class="line">    <span class="n">d</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class="line">    <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">swims</span><span class="p">,</span> <span class="n">quacks</span><span class="p">):</span>
</span><span class="line">        <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="ow">and</span> <span class="n">q</span><span class="p">):</span>
</span><span class="line">            <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_duck_swim_quack</span><span class="p">)</span>
</span><span class="line">        <span class="k">elif</span> <span class="p">(</span><span class="n">s</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">q</span><span class="p">)):</span>
</span><span class="line">            <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_duck_swim_not_quack</span><span class="p">)</span>
</span><span class="line">        <span class="k">elif</span> <span class="p">((</span><span class="ow">not</span> <span class="n">s</span><span class="p">)</span> <span class="ow">and</span> <span class="n">q</span><span class="p">):</span>
</span><span class="line">            <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_duck_not_swim_quack</span><span class="p">)</span>
</span><span class="line">        <span class="k">elif</span> <span class="p">((</span><span class="ow">not</span> <span class="n">s</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">q</span><span class="p">)):</span>
</span><span class="line">            <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_duck_not_swim_not_quack</span><span class="p">)</span>
</span><span class="line">        <span class="k">else</span><span class="p">:</span>
</span><span class="line">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;this should never happen&#39;</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</span><span class="line">
</span><span class="line"><span class="c"># AND FINALLY</span>
</span><span class="line"><span class="n">duck</span> <span class="o">=</span> <span class="n">pymc</span><span class="o">.</span><span class="n">Bernoulli</span><span class="p">(</span><span class="s">&#39;duck&#39;</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">duck_probability</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">masked_duck_data</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>If you’re half as confused reading this code as I was when I was first writing it, you deserve some explanations.</p>

<ul>
  <li>‘swims’ and ‘quacks’ are of type <code>pymc.distributions.Bernoulli</code>, but here we treat them like numpy arrays.</li>
</ul>

<p>This is <code>@pymc.deterministic</code>’s doing. This decorator ensures that when this function is actually called it will be given <code>swims.value</code> and <code>quacks.value</code> as parameters - and these are indeed numpy arrays. Same goes for all the other parameters.</p>

<ul>
  <li>earlier we used a pymc random variable for the <code>p</code> parameter of a <code>pymc.Bernoulli</code> but now we’re using a function - <code>duck_probability</code></li>
</ul>

<p>Again, <code>@pymc.deterministic</code>. When applied to a function it returns an object of type <code>pymc.PyMCObjects.Deterministic</code>. At this point the thing bound to the name ‘duck_probability’ is no longer a function. It’s a pymc random variable. It has a <code>value</code> parameter and everything.</p>

<p>Ok, let’s put it all together in a pymc model:</p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="c"># putting it all together</span>
</span><span class="line"><span class="n">model</span> <span class="o">=</span> <span class="n">pymc</span><span class="o">.</span><span class="n">Model</span><span class="p">([</span><span class="n">swims</span><span class="p">,</span> <span class="n">quacks</span><span class="p">,</span> <span class="n">duck</span><span class="p">])</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>aaaand we’re done.</p>

<p>Not really. The network is ready, but there is still the small matter of extracting predictions out of it.</p>

<h4 id="making-predictions-with-map">Making predictions with MAP</h4>
<p>The obvious way to estimate the missing values is with a maximum a posteriori estimator. Thankfuly, pymc has just the thing - <code>pymc.MAP</code>. Calling <code>.fit</code> on a <code>pymc.MAP</code> object changes values of variables in place, so let’s print the values of some of our variables before and after fitting.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">swims</span><span class="o">.</span><span class="n">value</span>
</span><span class="line"><span class="p">[</span><span class="bp">False</span> <span class="bp">False</span>  <span class="bp">True</span>  <span class="bp">True</span> <span class="bp">False</span> <span class="bp">False</span>  <span class="bp">True</span>  <span class="bp">True</span>  <span class="bp">True</span> <span class="bp">False</span><span class="p">]</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">quacks</span><span class="o">.</span><span class="n">value</span>
</span><span class="line"><span class="p">[</span><span class="bp">False</span>  <span class="bp">True</span> <span class="bp">False</span>  <span class="bp">True</span> <span class="bp">False</span>  <span class="bp">True</span> <span class="bp">False</span>  <span class="bp">True</span> <span class="bp">False</span> <span class="bp">False</span><span class="p">]</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">duck</span><span class="o">.</span><span class="n">value</span>
</span><span class="line"><span class="p">[</span><span class="bp">False</span> <span class="bp">False</span> <span class="bp">False</span>  <span class="bp">True</span> <span class="bp">False</span> <span class="bp">False</span> <span class="bp">False</span>  <span class="bp">True</span> <span class="bp">False</span>  <span class="bp">True</span><span class="p">]</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">swim_prior</span><span class="o">.</span><span class="n">value</span>
</span><span class="line"><span class="p">[</span> <span class="mf">0.58298865</span><span class="p">]</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">quack_prior</span><span class="o">.</span><span class="n">value</span>
</span><span class="line"><span class="p">[</span> <span class="mf">0.58990097</span><span class="p">]</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">p_duck_not_swim_quack</span><span class="o">.</span><span class="n">value</span>
</span><span class="line"><span class="p">[</span> <span class="mf">0.96976671</span><span class="p">]</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">p_duck_swim_quack</span><span class="o">.</span><span class="n">value</span>
</span><span class="line"><span class="p">[</span> <span class="mf">0.12251178</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>optimise the values:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">pymc</span><span class="o">.</span><span class="n">MAP</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</span><span class="line"><span class="ne">Warning</span><span class="p">:</span> <span class="n">Stochastic</span> <span class="n">swims</span><span class="s">&#39;s value is neither numerical nor array with floating-point dtype. Recommend fitting method fmin (default).</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>and inspect the results:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">swims</span><span class="o">.</span><span class="n">value</span>
</span><span class="line"><span class="p">[</span><span class="bp">False</span> <span class="bp">False</span>  <span class="bp">True</span>  <span class="bp">True</span> <span class="bp">False</span> <span class="bp">False</span>  <span class="bp">True</span>  <span class="bp">True</span>  <span class="bp">True</span>  <span class="bp">True</span><span class="p">]</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">quacks</span><span class="o">.</span><span class="n">value</span>
</span><span class="line"><span class="p">[</span><span class="bp">False</span>  <span class="bp">True</span> <span class="bp">False</span>  <span class="bp">True</span> <span class="bp">False</span>  <span class="bp">True</span> <span class="bp">False</span>  <span class="bp">True</span> <span class="bp">False</span>  <span class="bp">True</span><span class="p">]</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">duck</span><span class="o">.</span><span class="n">value</span>
</span><span class="line"><span class="p">[</span><span class="bp">False</span> <span class="bp">False</span> <span class="bp">False</span>  <span class="bp">True</span> <span class="bp">False</span> <span class="bp">False</span> <span class="bp">False</span>  <span class="bp">True</span> <span class="bp">False</span>  <span class="bp">True</span><span class="p">]</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">swim_prior</span><span class="o">.</span><span class="n">value</span>
</span><span class="line"><span class="p">[</span> <span class="mf">0.6</span><span class="p">]</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">quack_prior</span><span class="o">.</span><span class="n">value</span>
</span><span class="line"><span class="p">[</span> <span class="mf">0.5</span><span class="p">]</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">p_duck_not_swim_quack</span><span class="o">.</span><span class="n">value</span>
</span><span class="line"><span class="p">[</span>  <span class="mf">9.42288677e-10</span><span class="p">]</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">p_duck_swim_quack</span><span class="o">.</span><span class="n">value</span>
</span><span class="line"><span class="p">[</span> <span class="mf">0.99999999</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The two <code>False</code> bits - in ‘swims’ and ‘quacks’ have flipped to <code>True</code> and the values of the conditional probabilities have moved in the right direction! This is good, but unfortunately it’s not reliable. Even in this simple example pymc’s MAP rarely gets everything right like it did this time. To some extent it depends on the optimisation method used - e.g. <code>pymc.MAP(model).fit(method='fmin')</code> vs <code>pymc.MAP(model).fit(method='fmin_powell')</code>. Despite the warning message recommending ‘fmin’, ‘fmin_powell’ gives better results. ‘fmin’ gets the (more or less) right values for continous parameters but it never seems to flip the booleans, even when it would clearly result in higher likelihood.</p>

<h4 id="making-predictions-with-mcmc">Making predictions with MCMC</h4>

<p>The other way of getting predictions out of pymc is to use it’s main workhorse - the MCMC sampler. We will generate 200 samples from the posterior using MCMC and for each missing value we will pick the value that is most frequent among the samples. Mathematically this is still just maximum a posteriori estimation but the implementation is very different and so are the results.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="c"># this will generate (10000 - 8000) / 10 = 200 samples</span>
</span><span class="line"><span class="n">sampler</span> <span class="o">=</span> <span class="n">pymc</span><span class="o">.</span><span class="n">MCMC</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</span><span class="line"><span class="n">sampler</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">iter</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">burn</span><span class="o">=</span><span class="mi">8000</span><span class="p">,</span> <span class="n">thin</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>This should have produced 200 samples from the posterior for each unobserved variable. To see them, we use <code>sampler.trace</code>.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">sampler</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;P(swims)&#39;</span><span class="p">)[:]</span><span class="o">.</span><span class="n">shape</span>
</span><span class="line"><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>200 samples of the <code>'P(swims)'</code> paramter - as promised</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">sampler</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;P(duck | not swims &amp; quacks)&#39;</span><span class="p">)[:]</span><span class="o">.</span><span class="n">shape</span>
</span><span class="line"><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>200 samples of a conditional probability parameter.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">sampler</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;swims&#39;</span><span class="p">)[:]</span><span class="o">.</span><span class="n">shape</span>
</span><span class="line"><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><code>swims</code> boolean variable also has 200 samples. But:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">sampler</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;quacks&#39;</span><span class="p">)[:]</span><span class="o">.</span><span class="n">shape</span>
</span><span class="line"><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><code>quacks</code> has <em>two times</em> 200 - because there were two missing values among <code>quacks</code> observations - and each is modeled as an unobserved variable.</p>

<p><code>sampler.trace('duck')</code> produces only a <code>KeyError</code> - there are no missing values in <code>duck</code>, hence no samples.</p>

<p>Finally, posterior probability for the missing <code>swims</code> observation:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">sampler</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;swims&#39;</span><span class="p">)[:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span class="line"><span class="n">array</span><span class="p">([</span> <span class="mf">0.62</span><span class="p">])</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Great! According to MCMC the missing value in <code>swims</code> is more likely than not to be <code>True</code>!</p>

<p>(<code>sampler.trace('swims')[:]</code> is an array of 200 booleans, counting the number of <code>True</code> and <code>False</code> is equivalent to simply taking the mean).</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">sampler</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;quacks&#39;</span><span class="p">)[:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span class="line"><span class="n">array</span><span class="p">([</span> <span class="mf">0.195</span><span class="p">,</span>  <span class="mf">0.6</span>  <span class="p">])</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>And the two missing values in <code>quacks</code> are predicted to be <code>False</code> and <code>True</code> - respectively. As they should be.</p>

<p>Unlike the MAP approach, this result is reliable. As long as you give MCMC enough iterations to burn in, you will get very similar numbers every time.</p>

<h4 id="the-clean-way">The clean way</h4>

<p>This was soul-crushingly tedious, I know. But it doesn’t have to be this way. I have created a few utility functions to get rid of the boilerplate - the creation of uniform priors for variables, the conditional probabilities, the trace, and so on. The utils can all be found <a href="https://github.com/nadbordrozd/flagpole">here</a> (along with some other stuff).</p>

<p>This is how to define the network using these utils:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">dstk.pymc_utils</span> <span class="kn">import</span> <span class="n">make_bernoulli</span><span class="p">,</span> <span class="n">cartesian_bernoulli_child</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">dstk.imputation</span> <span class="kn">import</span> <span class="n">BayesNetImputer</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">DuckImputer</span><span class="p">(</span><span class="n">BayesNetImputer</span><span class="p">):</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">construct_net</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
</span><span class="line">        <span class="n">quacks</span> <span class="o">=</span> <span class="n">make_bernoulli</span><span class="p">(</span><span class="s">&#39;quacks_like_a_duck&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">quacks_like_a_duck</span><span class="p">)</span>
</span><span class="line">        <span class="n">swims</span> <span class="o">=</span> <span class="n">make_bernoulli</span><span class="p">(</span><span class="s">&#39;swims_like_a_duck&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">swims_like_a_duck</span><span class="p">)</span>
</span><span class="line">        <span class="n">duck</span> <span class="o">=</span> <span class="n">cartesian_bernoulli_child</span><span class="p">(</span><span class="s">&#39;duck&#39;</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="p">[</span><span class="n">quacks</span><span class="p">,</span> <span class="n">swims</span><span class="p">],</span> <span class="n">value</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">duck</span><span class="p">)</span>
</span><span class="line">        <span class="k">return</span> <span class="n">pymc</span><span class="o">.</span><span class="n">Model</span><span class="p">([</span><span class="n">quacks</span><span class="p">,</span> <span class="n">swims</span><span class="p">,</span> <span class="n">duck</span><span class="p">])</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>(there are also versions of <code>make_bernoulli</code> and <code>cartesian_bernoulli_child</code> for categorical variables). And this is how to use it:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">DuckImputer</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s">&#39;MCMC&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">with_missing</span><span class="p">)</span>
</span><span class="line">    <span class="n">duck</span>  <span class="n">quacks_like_a_duck</span>  <span class="n">swims_like_a_duck</span>
</span><span class="line"><span class="mi">0</span>     <span class="mi">0</span>                   <span class="mi">0</span>                  <span class="mi">0</span>
</span><span class="line"><span class="mi">1</span>     <span class="mi">0</span>                   <span class="mi">1</span>                  <span class="mi">0</span>
</span><span class="line"><span class="mi">2</span>     <span class="mi">0</span>                   <span class="mi">0</span>                  <span class="mi">1</span>
</span><span class="line"><span class="mi">3</span>     <span class="mi">1</span>                   <span class="mi">1</span>                  <span class="mi">1</span>
</span><span class="line"><span class="mi">4</span>     <span class="mi">0</span>                   <span class="mi">0</span>                  <span class="mi">0</span>
</span><span class="line"><span class="mi">5</span>     <span class="mi">0</span>                   <span class="mi">1</span>                  <span class="mi">0</span>
</span><span class="line"><span class="mi">6</span>     <span class="mi">0</span>                   <span class="mi">0</span>                  <span class="mi">1</span>
</span><span class="line"><span class="mi">7</span>     <span class="mi">1</span>                   <span class="mi">1</span>                  <span class="mi">1</span>
</span><span class="line"><span class="mi">8</span>     <span class="mi">0</span>                   <span class="mi">0</span>                  <span class="mi">1</span>
</span><span class="line"><span class="mi">9</span>     <span class="mi">1</span>                   <span class="mi">0</span>                  <span class="mi">1</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Next post: how all this compares to good old xgboost.</p>
</div>



  <head>
    
  </head>

  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">nadbor</span></span>

      




<time class='entry-date' datetime='2017-03-05T15:15:17+00:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>5</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>3:15 pm</span></time>
      


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://nadbordrozd.github.io/blog/2017/03/05/missing-data-imputation-with-bayesian-networks/" data-via="" data-counturl="http://nadbordrozd.github.io/blog/2017/03/05/missing-data-imputation-with-bayesian-networks/" >Tweet</a>
  
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2016/09/17/text-generation-with-keras-char-rnns/" title="Previous Post: Text generation with Keras char-RNNs">&laquo; Text generation with Keras char-RNNs</a>
      
      
        <a class="basic-alignment right" href="/blog/2017/03/23/missing-data-imputation-with-pymc-part-2/" title="Next Post: Missing data imputation with pymc: part 2">Missing data imputation with pymc: part 2 &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2017/07/18/so-you-think-you-can-stats/">So You Think You Can Stats</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/07/07/loafing-around-with-xgboots/">Loafing Around With XGBoots</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/06/20/you-wont-believe-how-this-islington-single-dad-is-making-ps500-slash-day-working-from-home/">You Won't Believe How This Islington Single Dad Is Making £500/day While Working From Home</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/06/03/python-or-scala/">Python or Scala - Let the Neural Network Decide.</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/03/23/missing-data-imputation-with-pymc-part-2/">Missing Data Imputation With Pymc: Part 2</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/nadbordrozd">@nadbordrozd</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'nadbordrozd',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/nadbordrozd?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2017 - nadbor -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'ds-lore';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://nadbordrozd.github.io/blog/2017/03/05/missing-data-imputation-with-bayesian-networks/';
        var disqus_url = 'http://nadbordrozd.github.io/blog/2017/03/05/missing-data-imputation-with-bayesian-networks/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>

<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  jax: ["input/TeX", "output/HTML-CSS"],
  tex2jax: {
    inlineMath: [ ['$', '$'] ],
    displayMath: [ ['$$', '$$']],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  messageStyle: "none",
  "HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"] }
});
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML" type="text/javascript"></script>

</html>
