
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Datamatching Part 2: Spark Pipeline - DS lore</title>
  <meta name="author" content="nadbor">

  
  <meta name="description" content="Datamatching Part 2: Spark Pipeline Jul 22nd, 2016 10:57 pm In the last post I talked about the principles of datamatching, now it’s time to put &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://nadbordrozd.github.io/blog/2016/07/22/datamatching-part-2-spark-pipeline/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="DS lore" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-65624880-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">DS lore</a></h1>
  
    <h2>words about stuff</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="nadbordrozd.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/interviews">Interviews</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Datamatching Part 2: Spark Pipeline</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-07-22T22:57:45+01:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>22</span><span class='date-suffix'>nd</span>, <span class='date-year'>2016</span></span> <span class='time'>10:57 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>In the last post I talked about the principles of datamatching, now it’s time to put them into practice. I will present a generic, customisable Spark pipeline for datamatching as well as a specific instance of it that for matching the toy datasets from the last post. TL;DR of the last post:</p>

<p>To match two datasets:</p>

<ol>
  <li>Tokenize corresponding fields in both datasets</li>
  <li>Group records having a token in common (think SQL join)</li>
  <li>Compare records withing a group and choose the closest match</li>
</ol>

<h3 id="why-spark">Why spark</h3>
<p>This datamatching algorithm could easily be implemented in the traditional single-machine, single-threaded way using a collection of hashmaps. In fact this is what I have done on more than one occasion and it worked. The advantage of spark here is built-in scalability. If your datasets get ten times bigger, just invoke spark requesting ten times as many cores. If matching is taking too long - throw some more resources at it again. In the single-threaded model all you can do is up the RAM as your data grows but the computation is taking longer and longer and there is nothing you can do about it.</p>

<p>As an added bonus, I discovered that the abstractions Spark forces on you - maps, joins, reduces - are actually appropriate for this problem and encourage a better design than the naive implementation.</p>

<h3 id="example-data">Example data</h3>
<p>In the spirit of TDD, let’s start by creating a test case. It will consist of two RDDs that we are going to match. Spark’s dataframes would be even more natural choice if not for the fact that they are completely fucked up.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="c"># the first dataset from now on refered to as &quot;left&quot;</span>
</span><span class="line"><span class="n">left</span> <span class="o">=</span> <span class="p">[</span>
</span><span class="line">    <span class="p">{</span>
</span><span class="line">        <span class="s">&#39;Id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;Bruce Wayne&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;address&#39;</span><span class="p">:</span> <span class="s">&#39;1007 Mountain Drive, Gotham&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;phone&#39;</span><span class="p">:</span> <span class="s">&quot;01234567890&quot;</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;company&#39;</span><span class="p">:</span> <span class="s">&quot;Wayne Enterprises&quot;</span>
</span><span class="line">    <span class="p">},</span>
</span><span class="line">    <span class="p">{</span>
</span><span class="line">        <span class="s">&#39;Id&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&quot;Thomas Wayne&quot;</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;address&#39;</span><span class="p">:</span> <span class="s">&#39;Gotham Cemetery&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;phone&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;company&#39;</span><span class="p">:</span> <span class="s">&#39;Wayne Enterprises&#39;</span>
</span><span class="line">    <span class="p">},</span>
</span><span class="line">    <span class="p">{</span>
</span><span class="line">        <span class="s">&#39;Id&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;Bruce Banner&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;address&#39;</span><span class="p">:</span> <span class="s">&#39;56431 Some Place, New Mexico&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;phone&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;company&#39;</span><span class="p">:</span> <span class="s">&#39;U.S. Department of Defense&#39;</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line"><span class="p">]</span>
</span><span class="line">
</span><span class="line"><span class="c"># and the second &quot;right&quot;</span>
</span><span class="line"><span class="n">right</span> <span class="o">=</span> <span class="p">[</span>
</span><span class="line">    <span class="p">{</span>
</span><span class="line">        <span class="s">&#39;Id&#39;</span><span class="p">:</span> <span class="s">&#39;a&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;Wayne, Burce&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;postcode&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;personal phone&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;business phone&#39;</span><span class="p">:</span> <span class="s">&#39;+735-123-456-7890&#39;</span><span class="p">,</span>
</span><span class="line">    <span class="p">},</span>
</span><span class="line">    <span class="p">{</span>
</span><span class="line">        <span class="s">&#39;Id&#39;</span><span class="p">:</span> <span class="s">&#39;b&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;B. Banner&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;postcode&#39;</span><span class="p">:</span> <span class="s">&#39;56431&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;personal phone&#39;</span><span class="p">:</span> <span class="s">&#39;897654322&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;business phone&#39;</span><span class="p">:</span> <span class="bp">None</span>
</span><span class="line">
</span><span class="line">    <span class="p">},</span>
</span><span class="line">    <span class="p">{</span>
</span><span class="line">        <span class="s">&#39;Id&#39;</span><span class="p">:</span> <span class="s">&#39;c&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;Pennyworth, Alfred&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;postcode&#39;</span><span class="p">:</span> <span class="s">&#39;1007&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;personal phone&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;business phone&#39;</span><span class="p">:</span> <span class="bp">None</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line"><span class="p">]</span>
</span><span class="line">
</span><span class="line"><span class="c"># sc is an instance of pyspark.SparkContext</span>
</span><span class="line"><span class="n">left_rdd</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">parallelize</span><span class="p">(</span><span class="n">left</span><span class="p">)</span>
</span><span class="line"><span class="n">right_rdd</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">parallelize</span><span class="p">(</span><span class="n">right</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>And let’s use <code>tabulate</code> for pretty printing the datasets</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span> <span class="k">as</span> <span class="n">tab</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">print_table</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
</span><span class="line">    <span class="n">headers</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">k</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">table</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">d</span><span class="p">))</span>
</span><span class="line">    <span class="k">print</span> <span class="n">tab</span><span class="p">([[</span><span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">table</span><span class="p">],</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="tokenizers">Tokenizers</h3>
<p>First step in the algorithm - tokenize the fields. After all this talk in the last post about fancy tokenizers, for our particular toy datasets we will use extremely simplistic ones:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="c"># lowercase the name and split on spaces, remove non-alphanumeric chars</span>
</span><span class="line"><span class="k">def</span> <span class="nf">tokenize_name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
</span><span class="line">    <span class="n">clean_name</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">c</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">isalnum</span><span class="p">()</span> <span class="k">else</span> <span class="s">&quot; &quot;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">name</span><span class="p">)</span>
</span><span class="line">    <span class="k">return</span> <span class="n">clean_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
</span><span class="line">
</span><span class="line"><span class="c"># same tokenizers as for names, meh, good enough</span>
</span><span class="line"><span class="k">def</span> <span class="nf">tokenize_address</span><span class="p">(</span><span class="n">address</span><span class="p">):</span>
</span><span class="line">    <span class="k">return</span> <span class="n">tokenize_name</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="c"># last 10 digits of phone number</span>
</span><span class="line"><span class="k">def</span> <span class="nf">tokenize_phone</span><span class="p">(</span><span class="n">phone</span><span class="p">):</span>
</span><span class="line">    <span class="k">return</span> <span class="p">[</span><span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">phone</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="s">&#39;1234567890&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">10</span><span class="p">:]]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Now we have to specify which tokenizer should be applied to which field. You don’t want to use the phone tokenizer on a person’s name or vice versa. Also, tokens extracted from name shouldn’t mix with tokens from address or phone number. On the other hand, there may be multiple fields that you want to extract e.g. phone numbers from - and these tokens <em>should</em> mix. Here’s minimalistic syntax for specifying these things:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="c"># original column name goes first, then token type, then tokenizer function</span>
</span><span class="line"><span class="c"># for the left dataset</span>
</span><span class="line"><span class="n">left_tokenizers</span> <span class="o">=</span> <span class="p">[</span>
</span><span class="line">    <span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="s">&#39;name_tokens&#39;</span><span class="p">,</span> <span class="n">tokenize_name</span><span class="p">),</span>
</span><span class="line">    <span class="p">(</span><span class="s">&#39;address&#39;</span><span class="p">,</span> <span class="s">&#39;address_tokens&#39;</span><span class="p">,</span> <span class="n">tokenize_address</span><span class="p">),</span>
</span><span class="line">    <span class="p">(</span><span class="s">&#39;phone&#39;</span><span class="p">,</span> <span class="s">&#39;phone_tokens&#39;</span><span class="p">,</span> <span class="n">tokenize_phone</span><span class="p">)</span>
</span><span class="line"><span class="p">]</span>
</span><span class="line">
</span><span class="line"><span class="c"># and right</span>
</span><span class="line"><span class="n">right_tokenizers</span> <span class="o">=</span> <span class="p">[</span>
</span><span class="line">    <span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="s">&#39;name_tokens&#39;</span><span class="p">,</span> <span class="n">tokenize_name</span><span class="p">),</span>
</span><span class="line">    <span class="p">(</span><span class="s">&#39;postcode&#39;</span><span class="p">,</span> <span class="s">&#39;address_tokens&#39;</span><span class="p">,</span> <span class="n">tokenize_address</span><span class="p">),</span>
</span><span class="line">    <span class="p">(</span><span class="s">&#39;personal phone&#39;</span><span class="p">,</span> <span class="s">&#39;phone_tokens&#39;</span><span class="p">,</span> <span class="n">tokenize_phone</span><span class="p">),</span>
</span><span class="line">    <span class="p">(</span><span class="s">&#39;business phone&#39;</span><span class="p">,</span> <span class="s">&#39;phone_tokens&#39;</span><span class="p">,</span> <span class="n">tokenize_phone</span><span class="p">)</span>
</span><span class="line"><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>And here’s how they are applied:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">id_key</span> <span class="o">=</span> <span class="s">&quot;Id&quot;</span>
</span><span class="line"><span class="k">def</span> <span class="nf">prepare_join_keys</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">tokenizers</span><span class="p">):</span>
</span><span class="line">    <span class="k">for</span> <span class="n">source_column</span><span class="p">,</span> <span class="n">key_name</span><span class="p">,</span> <span class="n">tokenizer</span> <span class="ow">in</span> <span class="n">tokenizers</span><span class="p">:</span>
</span><span class="line">        <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">source_column</span><span class="p">):</span>
</span><span class="line">            <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">source_column</span><span class="p">))):</span>
</span><span class="line">                <span class="k">yield</span> <span class="p">((</span><span class="n">token</span><span class="p">,</span> <span class="n">key_name</span><span class="p">),</span> <span class="n">record</span><span class="p">[</span><span class="n">id_key</span><span class="p">])</span>
</span><span class="line">
</span><span class="line"><span class="c"># Ids of records in the left dataset keyed by tokens extracted from the record</span>
</span><span class="line"><span class="n">left_keyed</span> <span class="o">=</span> <span class="n">left_rdd</span><span class="o">.</span><span class="n">flatMap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">prepare_join_keys</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">left_tokenizers</span><span class="p">))</span>
</span><span class="line"><span class="c"># and same for the right dataset</span>
</span><span class="line"><span class="n">right_keyed</span> <span class="o">=</span> <span class="n">right_rdd</span><span class="o">.</span><span class="n">flatMap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">prepare_join_keys</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">right_tokenizers</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The result is a mapping of token -&gt; Id in the form of an RDD. One for each dataset:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">&gt;&gt;&gt; left_keyed.collect()
</span><span class="line">[((&#39;bruce&#39;, &#39;name_tokens&#39;), 1),
</span><span class="line"> ((&#39;wayne&#39;, &#39;name_tokens&#39;), 1),
</span><span class="line"> ((&#39;1007&#39;, &#39;address_tokens&#39;), 1),
</span><span class="line"> ((&#39;mountain&#39;, &#39;address_tokens&#39;), 1),
</span><span class="line"> ((&#39;gotham&#39;, &#39;address_tokens&#39;), 1),
</span><span class="line"> ((&#39;drive&#39;, &#39;address_tokens&#39;), 1),
</span><span class="line"> ((&#39;1234567890&#39;, &#39;phone_tokens&#39;), 1),
</span><span class="line"> ((&#39;thomas&#39;, &#39;name_tokens&#39;), 2),
</span><span class="line"> ((&#39;wayne&#39;, &#39;name_tokens&#39;), 2),
</span><span class="line"> ((&#39;gotham&#39;, &#39;address_tokens&#39;), 2),
</span><span class="line"> ((&#39;cemetery&#39;, &#39;address_tokens&#39;), 2),
</span><span class="line"> ((&#39;bruce&#39;, &#39;name_tokens&#39;), 3),
</span><span class="line"> ((&#39;banner&#39;, &#39;name_tokens&#39;), 3),
</span><span class="line"> ((&#39;place&#39;, &#39;address_tokens&#39;), 3),
</span><span class="line"> ((&#39;mexico&#39;, &#39;address_tokens&#39;), 3),
</span><span class="line"> ((&#39;some&#39;, &#39;address_tokens&#39;), 3),
</span><span class="line"> ((&#39;56431&#39;, &#39;address_tokens&#39;), 3),
</span><span class="line"> ((&#39;new&#39;, &#39;address_tokens&#39;), 3)]
</span><span class="line">&gt;&gt;&gt; right_keyed.collect()
</span><span class="line">[((&#39;wayne&#39;, &#39;name_tokens&#39;), &#39;a&#39;),
</span><span class="line"> ((&#39;burce&#39;, &#39;name_tokens&#39;), &#39;a&#39;),
</span><span class="line"> ((&#39;1234567890&#39;, &#39;phone_tokens&#39;), &#39;a&#39;),
</span><span class="line"> ((&#39;b&#39;, &#39;name_tokens&#39;), &#39;b&#39;),
</span><span class="line"> ((&#39;banner&#39;, &#39;name_tokens&#39;), &#39;b&#39;),
</span><span class="line"> ((&#39;56431&#39;, &#39;address_tokens&#39;), &#39;b&#39;),
</span><span class="line"> ((&#39;897654322&#39;, &#39;phone_tokens&#39;), &#39;b&#39;),
</span><span class="line"> ((&#39;pennyworth&#39;, &#39;name_tokens&#39;), &#39;c&#39;),
</span><span class="line"> ((&#39;alfred&#39;, &#39;name_tokens&#39;), &#39;c&#39;),
</span><span class="line"> ((&#39;1007&#39;, &#39;address_tokens&#39;), &#39;c&#39;)]
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="generating-candidate-matches">Generating candidate matches</h3>
<p>Now comes the time to generate candidate matches. We do that by joining records that have a token in common:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">candidates</span> <span class="o">=</span> <span class="p">(</span>
</span><span class="line">    <span class="n">left_keyed</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">right_keyed</span><span class="p">)</span>
</span><span class="line">    <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="p">((</span><span class="n">token</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span> <span class="p">(</span><span class="n">l_id</span><span class="p">,</span> <span class="n">r_id</span><span class="p">)):</span> <span class="p">((</span><span class="n">l_id</span><span class="p">,</span> <span class="n">r_id</span><span class="p">),</span> <span class="p">{</span><span class="n">key</span><span class="p">}))</span>
</span><span class="line">    <span class="o">.</span><span class="n">reduceByKey</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
</span><span class="line"><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Result:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">&gt;&gt;&gt; candidates.collect()
</span><span class="line">[((2, &#39;a&#39;), {&#39;name_tokens&#39;}),
</span><span class="line"> ((1, &#39;c&#39;), {&#39;address_tokens&#39;}),
</span><span class="line"> ((1, &#39;a&#39;), {&#39;name_tokens&#39;, &#39;phone_tokens&#39;}),
</span><span class="line"> ((3, &#39;b&#39;), {&#39;address_tokens&#39;, &#39;name_tokens&#39;})]
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>With every match we have retained the information about what it was joined on for later use. We have 4 candidate matches here - 2 correct and 2 wrong ones. The spurious matches are <code>(1, 'c')</code> - Bruce Wayne and Alfred Pennyworth matched due to shared address; <code>(2, 'a')</code> - Bruce Wayne and Thomas Wayne matched because of the shared last name.</p>

<p>Joining the original records back to the matches, so they can be compared:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="c"># let&#39;s join back </span>
</span><span class="line"><span class="n">cand_matches</span> <span class="o">=</span> <span class="p">(</span>
</span><span class="line">    <span class="n">candidates</span>
</span><span class="line">    <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="p">((</span><span class="n">l_id</span><span class="p">,</span> <span class="n">r_id</span><span class="p">),</span> <span class="n">keys</span><span class="p">):</span> <span class="p">(</span><span class="n">l_id</span><span class="p">,</span> <span class="p">(</span><span class="n">r_id</span><span class="p">,</span> <span class="n">keys</span><span class="p">)))</span>
</span><span class="line">    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">left_rdd</span><span class="o">.</span><span class="n">keyBy</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">id_key</span><span class="p">]))</span>
</span><span class="line">    <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="n">l_id</span><span class="p">,</span> <span class="p">((</span><span class="n">r_id</span><span class="p">,</span> <span class="n">keys</span><span class="p">),</span> <span class="n">l_rec</span><span class="p">)):</span> <span class="p">(</span><span class="n">r_id</span><span class="p">,</span> <span class="p">(</span><span class="n">l_rec</span><span class="p">,</span> <span class="n">keys</span><span class="p">)))</span>
</span><span class="line">    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">right_rdd</span><span class="o">.</span><span class="n">keyBy</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">id_key</span><span class="p">]))</span>
</span><span class="line">    <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="n">r_id</span><span class="p">,</span> <span class="p">((</span><span class="n">l_rec</span><span class="p">,</span> <span class="n">keys</span><span class="p">),</span> <span class="n">r_rec</span><span class="p">)):</span> <span class="p">(</span><span class="n">l_rec</span><span class="p">,</span> <span class="n">r_rec</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">keys</span><span class="p">)))</span>
</span><span class="line"><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="finding-the-best-match">Finding the best match</h3>
<p>We’re almost there. Now we need to define a function to evaluate goodness of a match. Take a pair of records and say how similar they are. We will cop out of this by just using the join keys that were retained with every match. The more different types of tokens were matched, the better:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">def</span> <span class="nf">score_match</span><span class="p">(</span><span class="n">left_rec</span><span class="p">,</span> <span class="n">right_rec</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
</span><span class="line">    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>We also need a function that will say: a match must be scored at least this high to qualify.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">def</span> <span class="nf">is_good_enough_match</span><span class="p">(</span><span class="n">match_score</span><span class="p">):</span>
</span><span class="line">    <span class="k">return</span> <span class="n">match_score</span> <span class="o">&gt;=</span> <span class="mi">2</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>And now, finally we use those functions to evaluate and filter candidate matches and return the matched dataset:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">final_matches</span> <span class="o">=</span> <span class="p">(</span>
</span><span class="line">    <span class="n">cand_matches</span>
</span><span class="line">    <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="n">l_rec</span><span class="p">,</span> <span class="n">r_rec</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
</span><span class="line">         <span class="p">(</span><span class="n">l_rec</span><span class="p">,</span> <span class="n">r_rec</span><span class="p">,</span> <span class="n">score_match</span><span class="p">(</span><span class="n">l_rec</span><span class="p">,</span> <span class="n">r_rec</span><span class="p">,</span> <span class="n">keys</span><span class="p">)))</span>
</span><span class="line">    <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="n">l_rec</span><span class="p">,</span> <span class="n">r_rec</span><span class="p">,</span> <span class="n">score</span><span class="p">):</span> <span class="n">is_good_enough_match</span><span class="p">(</span><span class="n">score</span><span class="p">))</span>
</span><span class="line"><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The result:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">&gt;&gt;&gt; final_matches.collect()
</span><span class="line">[({&#39;Id&#39;: 1,
</span><span class="line">   &#39;address&#39;: &#39;1007 Mountain Drive, Gotham&#39;,
</span><span class="line">   &#39;company&#39;: &#39;Wayne Enterprises&#39;,
</span><span class="line">   &#39;name&#39;: &#39;Bruce Wayne&#39;,
</span><span class="line">   &#39;phone&#39;: &#39;01234567890&#39;},
</span><span class="line">  {&#39;Id&#39;: &#39;a&#39;,
</span><span class="line">   &#39;business phone&#39;: &#39;+735-123-456-7890&#39;,
</span><span class="line">   &#39;name&#39;: &#39;Wayne, Burce&#39;,
</span><span class="line">   &#39;personal phone&#39;: None,
</span><span class="line">   &#39;postcode&#39;: None},
</span><span class="line">  2),
</span><span class="line"> ({&#39;Id&#39;: 3,
</span><span class="line">   &#39;address&#39;: &#39;56431 Some Place, New Mexico&#39;,
</span><span class="line">   &#39;company&#39;: &#39;U.S. Department of Defense&#39;,
</span><span class="line">   &#39;name&#39;: &#39;Bruce Banner&#39;,
</span><span class="line">   &#39;phone&#39;: None},
</span><span class="line">  {&#39;Id&#39;: &#39;b&#39;,
</span><span class="line">   &#39;business phone&#39;: None,
</span><span class="line">   &#39;name&#39;: &#39;B. Banner&#39;,
</span><span class="line">   &#39;personal phone&#39;: &#39;897654322&#39;,
</span><span class="line">   &#39;postcode&#39;: &#39;56431&#39;},
</span><span class="line">  2)]
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Glorious.</p>

<h3 id="putting-it-all-together">Putting it all together</h3>
<p>Now is the time to put “generic” back in the “generic datamatching pipeline in spark”.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">class</span> <span class="nc">DataMatcher</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">score_match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">left_rec</span><span class="p">,</span> <span class="n">right_rec</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
</span><span class="line">        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">is_good_enough_match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">match_score</span><span class="p">):</span>
</span><span class="line">        <span class="k">return</span> <span class="n">match_score</span> <span class="o">&gt;=</span> <span class="mi">2</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">get_left_tokenizers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">get_right_tokenizers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">match_rdds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">left_rdd</span><span class="p">,</span> <span class="n">right_rdd</span><span class="p">):</span>
</span><span class="line">        <span class="n">left_tokenizers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_left_tokenizers</span><span class="p">()</span>
</span><span class="line">        <span class="n">right_tokenizers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_right_tokenizers</span><span class="p">()</span>
</span><span class="line">
</span><span class="line">        <span class="n">id_key</span> <span class="o">=</span> <span class="s">&quot;Id&quot;</span>
</span><span class="line">
</span><span class="line">        <span class="k">def</span> <span class="nf">prepare_join_keys</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">tokenizers</span><span class="p">):</span>
</span><span class="line">            <span class="k">for</span> <span class="n">source_column</span><span class="p">,</span> <span class="n">key_name</span><span class="p">,</span> <span class="n">tokenizer</span> <span class="ow">in</span> <span class="n">tokenizers</span><span class="p">:</span>
</span><span class="line">                <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">source_column</span><span class="p">):</span>
</span><span class="line">                    <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">source_column</span><span class="p">))):</span>
</span><span class="line">                        <span class="k">yield</span> <span class="p">((</span><span class="n">token</span><span class="p">,</span> <span class="n">key_name</span><span class="p">),</span> <span class="n">record</span><span class="p">[</span><span class="n">id_key</span><span class="p">])</span>
</span><span class="line">
</span><span class="line">        <span class="n">left_keyed</span> <span class="o">=</span> <span class="n">left_rdd</span><span class="o">.</span><span class="n">flatMap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">prepare_join_keys</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">left_tokenizers</span><span class="p">))</span>
</span><span class="line">        <span class="n">right_keyed</span> <span class="o">=</span> <span class="n">right_rdd</span><span class="o">.</span><span class="n">flatMap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">prepare_join_keys</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">right_tokenizers</span><span class="p">))</span>
</span><span class="line">
</span><span class="line">        <span class="n">candidates</span> <span class="o">=</span> <span class="p">(</span>
</span><span class="line">            <span class="n">left_keyed</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">right_keyed</span><span class="p">)</span>
</span><span class="line">            <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="p">((</span><span class="n">token</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span> <span class="p">(</span><span class="n">l_id</span><span class="p">,</span> <span class="n">r_id</span><span class="p">)):</span> <span class="p">((</span><span class="n">l_id</span><span class="p">,</span> <span class="n">r_id</span><span class="p">),</span> <span class="p">{</span><span class="n">key</span><span class="p">}))</span>
</span><span class="line">            <span class="o">.</span><span class="n">reduceByKey</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
</span><span class="line">        <span class="p">)</span>
</span><span class="line">
</span><span class="line">        <span class="c"># joining back original records so they can be compared</span>
</span><span class="line">        <span class="n">cand_matches</span> <span class="o">=</span> <span class="p">(</span>
</span><span class="line">            <span class="n">candidates</span>
</span><span class="line">            <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="p">((</span><span class="n">l_id</span><span class="p">,</span> <span class="n">r_id</span><span class="p">),</span> <span class="n">keys</span><span class="p">):</span> <span class="p">(</span><span class="n">l_id</span><span class="p">,</span> <span class="p">(</span><span class="n">r_id</span><span class="p">,</span> <span class="n">keys</span><span class="p">)))</span>
</span><span class="line">            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">left_rdd</span><span class="o">.</span><span class="n">keyBy</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">id_key</span><span class="p">]))</span>
</span><span class="line">            <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="n">l_id</span><span class="p">,</span> <span class="p">((</span><span class="n">r_id</span><span class="p">,</span> <span class="n">keys</span><span class="p">),</span> <span class="n">l_rec</span><span class="p">)):</span> <span class="p">(</span><span class="n">r_id</span><span class="p">,</span> <span class="p">(</span><span class="n">l_rec</span><span class="p">,</span> <span class="n">keys</span><span class="p">)))</span>
</span><span class="line">            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">right_rdd</span><span class="o">.</span><span class="n">keyBy</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">id_key</span><span class="p">]))</span>
</span><span class="line">            <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="n">r_id</span><span class="p">,</span> <span class="p">((</span><span class="n">l_rec</span><span class="p">,</span> <span class="n">keys</span><span class="p">),</span> <span class="n">r_rec</span><span class="p">)):</span> <span class="p">(</span><span class="n">l_rec</span><span class="p">,</span> <span class="n">r_rec</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">keys</span><span class="p">)))</span>
</span><span class="line">        <span class="p">)</span>
</span><span class="line">
</span><span class="line">        <span class="k">def</span> <span class="nf">score_match</span><span class="p">(</span><span class="n">left_rec</span><span class="p">,</span> <span class="n">right_rec</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
</span><span class="line">            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">        <span class="k">def</span> <span class="nf">is_good_enough_match</span><span class="p">(</span><span class="n">match_score</span><span class="p">):</span>
</span><span class="line">            <span class="k">return</span> <span class="n">match_score</span> <span class="o">&gt;=</span> <span class="mi">2</span>
</span><span class="line">
</span><span class="line">        <span class="n">final_matches</span> <span class="o">=</span> <span class="p">(</span>
</span><span class="line">            <span class="n">cand_matches</span>
</span><span class="line">            <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="n">l_rec</span><span class="p">,</span> <span class="n">r_rec</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
</span><span class="line">                 <span class="p">(</span><span class="n">l_rec</span><span class="p">,</span> <span class="n">r_rec</span><span class="p">,</span> <span class="n">score_match</span><span class="p">(</span><span class="n">l_rec</span><span class="p">,</span> <span class="n">r_rec</span><span class="p">,</span> <span class="n">keys</span><span class="p">)))</span>
</span><span class="line">            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="n">l_rec</span><span class="p">,</span> <span class="n">r_rec</span><span class="p">,</span> <span class="n">score</span><span class="p">):</span> <span class="n">is_good_enough_match</span><span class="p">(</span><span class="n">score</span><span class="p">))</span>
</span><span class="line">        <span class="p">)</span>
</span><span class="line">
</span><span class="line">        <span class="k">return</span> <span class="n">final_matches</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>To use it, you have to inherit from <code>DataMatcher</code> and override at a minimum the <code>get_left_tokenizers</code> and <code>get_right_tokenizers</code> functions. You will probably want to override <code>score_match</code> and <code>is_good_enough_match</code> as well, but the default should work in simple cases.</p>

<p>Now we can match our toy datasets in a few lines oc code, like this:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">class</span> <span class="nc">ComicBookMatcher</span><span class="p">(</span><span class="n">DataMatcher</span><span class="p">):</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">get_left_tokenizers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">        <span class="k">return</span> <span class="p">[</span>
</span><span class="line">            <span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="s">&#39;name_tokens&#39;</span><span class="p">,</span> <span class="n">tokenize_name</span><span class="p">),</span>
</span><span class="line">            <span class="p">(</span><span class="s">&#39;address&#39;</span><span class="p">,</span> <span class="s">&#39;address_tokens&#39;</span><span class="p">,</span> <span class="n">tokenize_address</span><span class="p">),</span>
</span><span class="line">            <span class="p">(</span><span class="s">&#39;phone&#39;</span><span class="p">,</span> <span class="s">&#39;phone_tokens&#39;</span><span class="p">,</span> <span class="n">tokenize_phone</span><span class="p">)</span>
</span><span class="line">        <span class="p">]</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">get_right_tokenizers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">        <span class="k">return</span> <span class="p">[</span>
</span><span class="line">            <span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="s">&#39;name_tokens&#39;</span><span class="p">,</span> <span class="n">tokenize_name</span><span class="p">),</span>
</span><span class="line">            <span class="p">(</span><span class="s">&#39;postcode&#39;</span><span class="p">,</span> <span class="s">&#39;address_tokens&#39;</span><span class="p">,</span> <span class="n">tokenize_address</span><span class="p">),</span>
</span><span class="line">            <span class="p">(</span><span class="s">&#39;personal phone&#39;</span><span class="p">,</span> <span class="s">&#39;phone_tokens&#39;</span><span class="p">,</span> <span class="n">tokenize_phone</span><span class="p">),</span>
</span><span class="line">            <span class="p">(</span><span class="s">&#39;business phone&#39;</span><span class="p">,</span> <span class="s">&#39;phone_tokens&#39;</span><span class="p">,</span> <span class="n">tokenize_phone</span><span class="p">)</span>
</span><span class="line">        <span class="p">]</span>
</span><span class="line">
</span><span class="line"><span class="n">cbm</span> <span class="o">=</span> <span class="n">ComicBookMatcher</span><span class="p">()</span>
</span><span class="line">
</span><span class="line"><span class="n">final_matches</span> <span class="o">=</span> <span class="n">cbm</span><span class="o">.</span><span class="n">match_rdds</span><span class="p">(</span><span class="n">left_rdd</span><span class="p">,</span> <span class="n">right_rdd</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>How cool is that?</p>

<p>Coming up: better ways to evaluate matches.</p>
</div>



  <head>
    
  </head>

  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">nadbor</span></span>

      




<time class='entry-date' datetime='2016-07-22T22:57:45+01:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>22</span><span class='date-suffix'>nd</span>, <span class='date-year'>2016</span></span> <span class='time'>10:57 pm</span></time>
      


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://nadbordrozd.github.io/blog/2016/07/22/datamatching-part-2-spark-pipeline/" data-via="" data-counturl="http://nadbordrozd.github.io/blog/2016/07/22/datamatching-part-2-spark-pipeline/" >Tweet</a>
  
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2016/07/12/datamatching-part-1/" title="Previous Post: datamatching - part 1: algorithm">&laquo; datamatching - part 1: algorithm</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/07/22/datamatching-part-2-spark-pipeline/">Datamatching Part 2: Spark Pipeline</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/07/12/datamatching-part-1/">Datamatching - Part 1: Algorithm</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/06/15/dear-recruiter/">Dear Recruiter</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/06/13/deepwalking-with-companies/">Deepwalking With Companies</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/05/22/one-weird-trick-that-will-fix-your-pyspark-schemas/">Data Engineers Will Hate You - One Weird Trick to Fix Your Pyspark Schemas</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/nadbordrozd">@nadbordrozd</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'nadbordrozd',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/nadbordrozd?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - nadbor -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'ds-lore';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://nadbordrozd.github.io/blog/2016/07/22/datamatching-part-2-spark-pipeline/';
        var disqus_url = 'http://nadbordrozd.github.io/blog/2016/07/22/datamatching-part-2-spark-pipeline/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>

<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  jax: ["input/TeX", "output/HTML-CSS"],
  tex2jax: {
    inlineMath: [ ['$', '$'] ],
    displayMath: [ ['$$', '$$']],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  messageStyle: "none",
  "HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"] }
});
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML" type="text/javascript"></script>

</html>
